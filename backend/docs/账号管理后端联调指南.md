# 账号管理后端联调指南 
 
 本指南详细说明了如何将“账号管理”前端页面与 FastAPI 后端进行联调，特别是修改密码功能的实现。 
 
 ## 1. 后端接口说明 
 
 ### 1.1 修改密码接口 
 
 - **路径**: `/api/v1/user/password` 
 - **方法**: `PATCH` 
 - **认证**: 需要 JWT Token（放在请求头的 `Authorization: Bearer {token}` 中） 
 - **请求体 (JSON)**: 
   ```json 
   { 
     "currentPassword": "当前旧密码", 
     "newPassword": "新密码" 
   } 
   ``` 
 - **验证规则**: 
   - `newPassword`: 长度 8-128 位，必须包含大写字母、小写字母和数字。 
 - **响应格式**: 
   - 成功: `{"ok": true}` 
   - 失败: 返回 400 错误及详细错误信息（如 `invalid_current_password`, `weak_new_password` 等）。 
 
 ### 1.2 获取用户信息接口 (参考) 
 
 - **路径**: `/api/v1/user/me` 
 - **方法**: `GET` 
 - **功能**: 用于在账号管理页面显示当前登录的用户名等信息。 
 
 ## 2. 前端实现细节 
 
 ### 2.1 API 调用工具 
 
 前端统一使用 `src/app/lib/api.ts` 中定义的 axios 实例进行请求。 
 
 ```typescript 
 import api from '../lib/api' 
 
 // 示例调用 
 const response = await api.patch('/v1/user/password', { 
   currentPassword: '...', 
   newPassword: '...' 
 }, { 
   headers: { Authorization: `Bearer ${token}` } 
 }) 
 ``` 
 
 ### 2.2 状态管理 
 
 使用 Pinia store (`src/app/stores/auth.ts`) 管理用户登录状态和 Token。 
 
 ```typescript 
 import { useAuthStore } from '../stores/auth' 
 const auth = useAuthStore() 
 // 使用 auth.token 获取当前 Token 
 ``` 
 
 ### 2.3 错误处理逻辑 
 
 在 `Account.vue` 中，我们根据后端返回的 `detail` 字段进行友好的错误提示： 
 
 - `invalid_current_password`: 提示“当前密码错误”。 
 - `weak_new_password`: 提示“新密码太弱（需包含大小写字母和数字）”。 
 - `demo_user_cannot_change_password`: 提示“演示账号不允许修改密码”。 
 - 其他错误: 提示“服务器错误，请稍后再试”。 
 
 ## 3. 联调注意事项 
 
 1. **跨域配置**: 后端 `main.py` 已配置 `CORSMiddleware` 允许所有来源 (`*`)，但在生产环境下建议限制为前端域名。 
 2. **演示账号限制**: 系统内置的演示账号（如 `admin`, `ops`, `obs`）在后端 `users.py` 中被拦截，不允许修改密码，以保护公共演示环境的安全。 
 3. **数据模型**: 修改密码操作会直接更新数据库中 `users` 表的 `password_hash` 字段，并同步更新 `updated_at` 时间戳。 
 
 ## 4. 后续扩展 
 
 - **双因素认证 (2FA)**: 目前前端预留了位置，后端尚未实现相关接口。 
 - **头像上传**: 建议后续增加 `/user/avatar` 接口支持。
