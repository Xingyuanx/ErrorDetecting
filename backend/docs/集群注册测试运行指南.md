# 集群注册测试运行指南

本文档说明如何运行集群注册测试脚本 `backend/tests/test_cluster_register.py`，覆盖“成功/失败”两种注册情况。

## 1. 前置条件

- 后端服务已启动并可访问（默认 `http://127.0.0.1:8000`）
- 你使用的登录账号有集群注册权限（后端限制为 `admin` 或 `ops`）
- 后端能够连通集群各节点的 SSH（若当前环境无 TUN，请先按“后端带 SOCKS5 代理启动指南”启动）

## 2. 测试数据说明

脚本内置了你提供的“正确集群 test”节点信息：

- hadoop102  100.71.90.16  NameNode
- hadoop103  100.74.47.4   ResourceManager
- hadoop104  100.99.172.96 SecondaryNameNode
- hadoop105  100.91.174.104
- hadoop100  100.73.220.46

所有节点默认使用：

- 用户名：`hadoop`
- 密码：`limouren...`

失败用例由脚本自动生成（将 `type` 改为非法值），期望后端返回 `400`。

## 3. 运行方式

在项目根目录执行：

```bash
LOGIN_PASSWORD='admin123' \
HADOOP_PASSWORD='limouren...' \
BASE_URL='http://127.0.0.1:8000' \
python3 /home/devbox/project/backend/tests/test_cluster_register.py
```

可选环境变量：

- `BASE_URL`：后端地址，默认 `http://127.0.0.1:8000`
- `LOGIN_USER`：登录用户名，默认 `admin`
- `LOGIN_PASSWORD`：登录密码（必填）
- `HADOOP_USER`：集群 SSH 用户名，默认 `hadoop`
- `HADOOP_PASSWORD`：集群 SSH 密码（必填）

## 4. 预期输出

成功时输出类似：

- `成功用例通过: uuid= ...`
- `失败用例通过: status=400 detail= ...`

脚本退出码：

- `0`：两种情况都符合预期
- `1`：用例未按预期（例如成功用例返回非 200，或失败用例未返回 400）
- `2`：缺少必要环境变量

## 5. 常见失败与排查

### 5.1 成功用例报 SSH 不可连接 / timed out

现象通常为后端返回：

- `注册失败：SSH不可连接`
- `detail: timed out`

处理方式：

- 确认 tailscale 侧能够看到节点在线：`tailscale status`
- 若当前环境没有 `/dev/net/tun`，必须使用 userspace networking + SOCKS5，并让后端通过 `TS_SOCKS5_SERVER` 走代理启动

