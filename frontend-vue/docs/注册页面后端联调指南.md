# 注册页面后端联调指南

本指南旨在帮助后端开发人员排查和解决注册接口（`/api/v1/user/register`）返回 `HTTP 400 Bad Request` 的问题。

## 1. 现象描述

当前端提交注册表单时，页面弹出红色提示框显示：**“注册请求失败 (状态码: 400)”**。这意味着请求已到达服务器，但因参数校验或业务逻辑错误被拒绝。

## 2. 前端请求详情

在排查前，请确保后端接口能够接收并正确解析以下格式的请求：

- **URL**: `/api/v1/user/register`
- **Method**: `POST`
- **Content-Type**: `application/json`
- **Payload (请求体)**:
  ```json
  {
    "username": "testuser",
    "email": "test@example.com",
    "password": "password123",
    "fullName": "张三"
  }
  ```
  > **注意**: 姓名键名为 `fullName` (小驼峰)，请检查后端模型是否误定义为 `full_name`。

## 3. 后端排查重点

### A. 字段模型校验

- **必填项**: 确保 `username`, `email`, `password`, `fullName` 四个字段均为必填。
- **长度限制**: 检查后端是否有针对 `username` (前端要求 >=3 位) 或 `password` (前端要求 >=8 位) 的最小长度限制。
- **复杂度要求**: 前端已增加校验，要求密码必须包含 **大写字母、小写字母和数字**。请确保后端校验逻辑同步。
- **格式校验**: 确保 `email` 字段使用了标准的邮箱格式校验。

### B. 业务逻辑冲突

- **用户名重复**: 数据库中 `username` 字段是否有唯一性约束？如果已存在同名用户，后端应返回明确提示。
- **邮箱重复**: 数据库中 `email` 字段是否已绑定。

### C. 响应格式规范 (重要)

前端 [api.ts](file:///home/devbox/project/frontend-vue/src/app/lib/api.ts) 拦截器会尝试解析后端返回的错误信息。为了让用户看到具体的失败原因，建议后端按照以下结构返回错误：

#### 推荐的错误返回 (400)

```json
{
  "detail": {
    "message": "该用户名已被注册"
  }
}
```

或者支持 `msg` 字段：

```json
{
  "detail": {
    "msg": "邮箱格式不合法"
  }
}
```

#### 不推荐的返回 (会导致前端只显示状态码 400)

```json
// 缺少 message 或 msg 字段
{
  "detail": "Bad Request"
}
// 或者 FastAPI 默认的 validation error 结构 (前端目前适配有限)
{
  "detail": [{"loc": ["body", "username"], "msg": "field required"}]
}
```

## 4. 排查步骤建议

1. **查看后端日志**: 确认是否有 `Pydantic` 抛出的 `ValidationError` 或数据库的 `IntegrityError`。
2. **Swagger 测试**: 直接通过 `/docs` 页面，输入上述 JSON Payload 进行测试。
3. **检查跨域/代理**: 确认 `vite.config.ts` 中的代理配置是否正确将请求转发到了预期的后端实例。

## 5. 常见问题对照表

| 现象                     | 可能原因             | 解决方案                               |
| :----------------------- | :------------------- | :------------------------------------- |
| 400 (无具体消息)         | 字段名不匹配         | 将 `full_name` 改为 `fullName`         |
| 400 (提示注册失败)       | 用户名/邮箱已存在    | 检查数据库唯一索引并返回具体 `message` |
| 422 Unprocessable Entity | 请求体格式错误       | 检查 JSON 数据类型是否正确             |
| 405 Method Not Allowed   | 接口未定义 POST 方法 | 确认接口路由定义                       |
