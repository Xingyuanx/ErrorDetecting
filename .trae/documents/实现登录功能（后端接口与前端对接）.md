## 当前状态
- 本地数据库与所有表已创建完毕（含示例用户与权限）。
- 项目已具备基础后端骨架（FastAPI + SQLAlchemy + asyncpg），路由与模型已就绪。

## 目标
- 在后端实现登录接口（用户名/邮箱 + 密码），校验 `users.password_hash`（bcrypt），返回 JWT。
- 在前端原型 `index.html` 的登录区对接 `/api/v1/user/login`，存储 Token 并启用 Axios 拦截器为后续请求附加 `Authorization`。
- 保护受限页面与接口（集群管理、故障中心等），未认证/无权限时处理 401/403 与页面跳转。

## 技术选型与依赖
- 密码校验：`passlib[bcrypt]`（验证 `$2b$12$...` 格式的 bcrypt 哈希）
- Token：`PyJWT`（HS256），配置 `SECRET_KEY` 与 `ACCESS_TOKEN_EXPIRE_MINUTES`。
- 依赖追加到 `src/backend/requirements.txt`：`passlib[bcrypt]`、`PyJWT`。

## 后端实现
### 配置
- 在 `src/backend/app/config.py` 增加：`SECRET_KEY`、`ALGORITHM='HS256'`、`ACCESS_TOKEN_EXPIRE_MINUTES=60`（从环境变量读取，支持 `.env`）。

### 模型与工具
- 新增 `src/backend/app/models/users.py` 映射 `users` 表（`id, username, email, password_hash, is_active, ...`）。
- 新增 `src/backend/app/security.py`：
  - 函数：`verify_password(plain, hashed)` 使用 `passlib` 验证；
  - 函数：`create_access_token(data, expires_minutes)` 使用 `PyJWT` 生成 JWT；
  - 依赖：`get_current_user(token)` 验证 Bearer Token 并加载用户。

### 路由
- 新增 `src/backend/app/schemas/auth.py`：`LoginRequest {username_or_email, password}`、`TokenResponse {access_token, token_type}`。
- 新增 `src/backend/app/routers/auth.py`：
  - `POST /api/v1/user/login`：
    1) 接受 `LoginRequest`
    2) 支持用户名或邮箱匹配用户
    3) 验证 `password_hash`
    4) 生成 `JWT` 并返回 `TokenResponse`
  - 失败返回：`401`（统一错误包络：`{code,message,detail,traceId}`）。
- 将 `auth` 路由挂载到 `app/main.py`（`/api/v1`）。

### 受限接口保护
- 在现有路由（clusters/faults/logs）添加可选依赖 `get_current_user`（至少在需要用户态的写操作时强制验证）。
- 统一异常处理：
  - 未认证：返回 `401`，前端跳转登录；
  - 无权限：返回 `403`，前端显示无权限提示。

## 前端集成
- 在 `src/fronted/index.html` 的登录页（`#login`）绑定提交事件：
  - 调用 `POST /api/v1/user/login`，成功后将 `access_token` 存入 `localStorage`。
  - 切换到主界面并在 Axios 拦截器中附加 `Authorization: Bearer <token>`。
- 在 utils 层（`utils/auth.js`）：
  - `setupAuth()`：注册登录表单事件、退出登录、Token 读写；
  - `setupAxios()`：请求拦截器注入 `Authorization`，响应拦截器处理 `401/403`（跳转登录/无权限提示）。

## 安全与配置
- `.env`（不提交仓库）：
  - `DATABASE_URL=postgresql+asyncpg://app_user:<pwd>@localhost:5432/hadoop_fault_db`
  - `SECRET_KEY=<随机32字节>`
  - `ACCESS_TOKEN_EXPIRE_MINUTES=60`
- 最小权限：后端连接使用 `app_user`，仅业务读写权限（已在教程中设置）。

## 测试与验证
- 用脚本插入一个测试用户（若已有则跳过），并设置 bcrypt 哈希（脚本已包含管理员示例）。
- 后端启动：`uvicorn src.backend.app.main:app --reload`；
- 测试：
  - `POST /api/v1/user/login` 成功返回 Token；
  - 携带 Authorization 访问 `GET /api/v1/clusters` 正常；
  - 不带 Token 时受限接口返回 401/403。
- 前端登录表单：输入已存在用户与密码，跳转后页面 API 正常附带 Token。

## 交付物
- 后端：`auth` 路由与 `security` 工具、`users` 模型与 `schemas`、主入口注册与依赖更新。
- 前端：`utils/auth.js` 登录逻辑与 Axios 拦截器；在 `index.html` 调用初始化。

## 后续扩展
- 注册与审批流（`POST /api/user/register` → 管理员审批列表）；
- 角色与权限在 Token 中下发（`role_key`），前端按角色控制菜单显示；
- 刷新令牌与登出；
- 审计：登录成功/失败写入 `audit_logs`。