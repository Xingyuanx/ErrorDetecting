# PostgreSQL 数据库部署步骤教程（从零开始）

## 环境与准备
- 操作系统：Windows（PowerShell）或其他平台
- 数据库：PostgreSQL 14+（编码 `UTF8`）
- 项目脚本：`doc/project/数据库建表脚本_postgres.sql`（不包含 `CREATE DATABASE`）
- 注意：请不要以明文形式保存任何数据库账户口令

## 安装 PostgreSQL
- 安装器方式（Windows）：
  - 访问 https://www.postgresql.org/download/windows/ 下载 14+ 安装包
  - 按向导安装并记住超级用户 `postgres` 的口令
  - 将 `psql.exe` 所在目录加入 `PATH`
- Docker 方式：
  - `docker run -d --name pg -e POSTGRES_PASSWORD=<安全口令> -p 5432:5432 postgres:14`

## 初始化数据库与用户
- 使用 `psql` 连接到默认数据库并创建业务库：
```sql
CREATE DATABASE hadoop_fault_db WITH ENCODING 'UTF8';
```
- 可选：创建业务用户并授权（按需执行）：
```sql
CREATE USER app_user WITH PASSWORD '<安全口令>';
GRANT CONNECT ON DATABASE hadoop_fault_db TO app_user;
GRANT USAGE ON SCHEMA public TO app_user;
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO app_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO app_user;
```
- 本地认证配置（如需）：在 `pg_hba.conf` 中确保存在如下规则：
```
host    all             all             127.0.0.1/32            md5
host    all             all             ::1/128                 md5
```

## 执行建表脚本
- Windows 本机执行：
```powershell
psql -U postgres -h localhost -d hadoop_fault_db -f "doc/project/数据库建表脚本_postgres.sql"
```
- Docker 容器执行：
```powershell
docker cp "doc/project/数据库建表脚本_postgres.sql" pg:/tmp/schema.sql
docker exec -it pg psql -U postgres -d hadoop_fault_db -f /tmp/schema.sql
```

## 验证与自检
- 查看表与索引：
```sql
\dt
\di
```
- 查看关键表结构：
```sql
\d+ fault_records
\d+ exec_logs
\d+ system_logs
```
- 验证示例数据：
```sql
SELECT name, uuid FROM clusters;
SELECT role_name, role_key FROM roles;
```

## 备份与恢复
- 备份：
```powershell
pg_dump -U postgres -d hadoop_fault_db > backup_$(Get-Date -Format yyyyMMdd).sql
```
- 恢复：
```powershell
psql -U postgres -d hadoop_fault_db -f backup_20250101.sql
```

## 连接字符串示例
- 本地：`postgresql://postgres:<安全口令>@localhost:5432/hadoop_fault_db`
- 后端（asyncpg）：`postgresql+asyncpg://postgres:<安全口令>@localhost:5432/hadoop_fault_db`

## 运维与安全建议
- 最小权限原则：为应用创建专用账号，仅授予必要权限
- 定期备份与恢复演练：使用 `pg_dump` 与 `psql` 验证恢复可用
- 指标与监控：暴露数据库关键指标并纳入监控平台
- 参数与密钥管理：统一置于安全的环境配置管理，避免明文写入代码或库

## 运维与安全操作（详细教程，结合当前项目）

### 1. 为后端应用创建专用账号并授予必要权限
> 目标：后端仅能进行业务读写（SELECT/INSERT/UPDATE/DELETE），不能 `CREATE/DROP/ALTER` 架构对象；新建表默认也继承上述权限。

1) 创建专用账号（禁止超级权限）：
```sql
CREATE USER app_user WITH PASSWORD '<安全口令>' NOSUPERUSER NOCREATEDB NOCREATEROLE NOINHERIT LOGIN;
```

2) 授权到业务库与 schema：
```sql
GRANT CONNECT ON DATABASE hadoop_fault_db TO app_user;
GRANT USAGE ON SCHEMA public TO app_user;
```

3) 授予现有对象最小权限：
```sql
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO app_user;
GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO app_user;
```

4) 为未来对象设置默认权限（由对象拥有者执行，通常为 postgres 或迁移用户）：
```sql
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO app_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT USAGE, SELECT ON SEQUENCES TO app_user;
```

5) 测试最小权限（应成功读写但不能删除架构）：
```sql
-- 作为 app_user 连接后测试：
SELECT COUNT(*) FROM clusters;
-- 业务写入示例（按需测试）：
-- INSERT INTO fault_records (fault_id, fault_type, fault_level, title, status) VALUES ('TEST-0001','demo','low','测试故障','detected');
-- 以下操作应失败：
-- DROP TABLE system_logs; -- 预期报错：权限不足
```

### 2. 创建只读账号（用于报表/监控读取）
> 目标：只读账号仅能 `SELECT`，适用于报表或外部监控。
```sql
CREATE USER report_user WITH PASSWORD '<安全口令>' NOSUPERUSER NOCREATEDB NOCREATEROLE NOINHERIT LOGIN;
GRANT CONNECT ON DATABASE hadoop_fault_db TO report_user;
GRANT USAGE ON SCHEMA public TO report_user;
GRANT SELECT ON ALL TABLES IN SCHEMA public TO report_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT ON TABLES TO report_user;
```

### 3. 连接控制（pg_hba.conf）与网络安全
> 目标：仅允许可信来源访问，使用密码/可选 TLS。
- 本机开发：保证如下规则存在（已在教程示例中给出）：
```
host    all             all             127.0.0.1/32            md5
host    all             all             ::1/128                 md5
```
- 生产环境：仅白名单应用服务器 IP，例如：
```
host    hadoop_fault_db  app_user       <APP_SERVER_IP>/32      md5
```
- 可选启用 TLS（建议）：在服务端启用证书后，客户端 DSN 带上 `sslmode=require`
  - 例如：`postgresql+asyncpg://app_user:<安全口令>@<host>:5432/hadoop_fault_db?sslmode=require`

### 4. 后端配置与密钥管理
> 目标：避免明文密钥进入代码库，统一通过环境变量或安全配置管理下发。
- 示例：在后端 `.env` 中设置（不要提交到仓库）：
```
DATABASE_URL=postgresql+asyncpg://app_user:<安全口令>@localhost:5432/hadoop_fault_db
JWT_SECRET=<随机高强度密钥>
JWT_EXPIRE_MINUTES=60
```
- 代码引用：`src/backend/app/config.py` 通过 `dotenv` 加载 `DATABASE_URL`
- 口令轮换：
```sql
ALTER ROLE app_user WITH PASSWORD '<新口令>'; -- 轮换后更新部署环境中的 DATABASE_URL
```

### 5. SQL 审计与慢查询日志（可选）
> 目标：定位性能问题与风险操作。生产环境谨慎开启，避免过多日志。
- 建议参数（在 `postgresql.conf` 或 `ALTER SYSTEM`）：
```
log_min_duration_statement = 500ms    # 仅记录慢于 500ms 的SQL
log_line_prefix = '%m [%p] %u %d %r'  # 时间/进程/用户/库/来源
```
- 重载配置：`SELECT pg_reload_conf();`

### 6. 维护例行（每周/每月）
> 目标：保持统计与索引健康，日志/表空间合理。
- 更新统计信息：`VACUUM (ANALYZE);`
- 查看膨胀与重建索引（按需）：`REINDEX DATABASE hadoop_fault_db;`
- 日志归档与保留策略：结合 `app_configurations` 中的保留天数统一治理。
