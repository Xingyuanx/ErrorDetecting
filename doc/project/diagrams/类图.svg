<?xml version="1.0" encoding="UTF-8"?>
<svg width="1400" height="1000" xmlns="http://www.w3.org/2000/svg" style="background-color: white;">
  <defs>
    <style>
      .title { font-family: 'Microsoft YaHei', sans-serif; font-size: 24px; font-weight: bold; text-anchor: middle; }
      .class-name { font-family: 'Microsoft YaHei', sans-serif; font-size: 14px; font-weight: bold; text-anchor: middle; }
      .attribute { font-family: 'Microsoft YaHei', sans-serif; font-size: 11px; }
      .method { font-family: 'Microsoft YaHei', sans-serif; font-size: 11px; }
      .enum-value { font-family: 'Microsoft YaHei', sans-serif; font-size: 11px; text-anchor: middle; }
      .note-text { font-family: 'Microsoft YaHei', sans-serif; font-size: 10px; }
      .class-box { fill: #E3F2FD; stroke: #1976D2; stroke-width: 2; }
      .enum-box { fill: #FFF3E0; stroke: #F57C00; stroke-width: 2; }
      .association { stroke: #333333; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
      .composition { stroke: #333333; stroke-width: 2; fill: none; marker-end: url(#diamond); }
      .note-box { fill: #FFFDE7; stroke: #FBC02D; stroke-width: 1; }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#333333" />
    </marker>
    <marker id="diamond" markerWidth="12" markerHeight="8" refX="12" refY="4" orient="auto">
      <polygon points="0 4, 6 0, 12 4, 6 8" fill="#333333" />
    </marker>
  </defs>

  <!-- 标题 -->
  <text x="700" y="30" class="title">故障检测与自动修复 - 类图</text>

  <!-- 第一行类 -->
  <!-- FlumeAgent -->
  <g id="FlumeAgent">
    <rect x="50" y="70" width="150" height="80" class="class-box" />
    <text x="125" y="90" class="class-name">FlumeAgent</text>
    <line x1="50" y1="95" x2="200" y2="95" stroke="#1976D2" stroke-width="1" />
    <text x="60" y="110" class="attribute">+config : Map</text>
    <line x1="50" y1="115" x2="200" y2="115" stroke="#1976D2" stroke-width="1" />
    <text x="60" y="130" class="method">+start()</text>
    <text x="60" y="145" class="method">+stop()</text>
  </g>

  <!-- LogEvent -->
  <g id="LogEvent">
    <rect x="250" y="70" width="180" height="120" class="class-box" />
    <text x="340" y="90" class="class-name">LogEvent</text>
    <line x1="250" y1="95" x2="430" y2="95" stroke="#1976D2" stroke-width="1" />
    <text x="260" y="110" class="attribute">+timestamp : datetime</text>
    <text x="260" y="125" class="attribute">+host : string</text>
    <text x="260" y="140" class="attribute">+source : string</text>
    <text x="260" y="155" class="attribute">+level : string</text>
    <text x="260" y="170" class="attribute">+message : string</text>
    <text x="260" y="185" class="attribute">+raw : text</text>
  </g>

  <!-- FastAPIService -->
  <g id="FastAPIService">
    <rect x="480" y="70" width="220" height="140" class="class-box" />
    <text x="590" y="90" class="class-name">FastAPIService</text>
    <line x1="480" y1="95" x2="700" y2="95" stroke="#1976D2" stroke-width="1" />
    <line x1="480" y1="100" x2="700" y2="100" stroke="#1976D2" stroke-width="1" />
    <text x="490" y="115" class="method">+ingestLog(e: LogEvent)</text>
    <text x="490" y="130" class="method">+getClusterStatus()</text>
    <text x="490" y="145" class="method">+queryLogs(filter)</text>
    <text x="490" y="160" class="method">+diagnose(logs)</text>
    <text x="490" y="175" class="method">+executeRepair(cmd: FixCommand)</text>
  </g>

  <!-- 第二行类 -->
  <!-- DiagnosisService -->
  <g id="DiagnosisService">
    <rect x="50" y="250" width="200" height="100" class="class-box" />
    <text x="150" y="270" class="class-name">DiagnosisService</text>
    <line x1="50" y1="275" x2="250" y2="275" stroke="#1976D2" stroke-width="1" />
    <line x1="50" y1="280" x2="250" y2="280" stroke="#1976D2" stroke-width="1" />
    <text x="60" y="295" class="method">+callLLM(logs) : FixCommand</text>
    <text x="60" y="310" class="method">+validateCommand(cmd: FixCommand) : bool</text>
  </g>

  <!-- LLMClient -->
  <g id="LLMClient">
    <rect x="300" y="250" width="180" height="100" class="class-box" />
    <text x="390" y="270" class="class-name">LLMClient</text>
    <line x1="300" y1="275" x2="480" y2="275" stroke="#1976D2" stroke-width="1" />
    <text x="310" y="290" class="attribute">+apiKey : string</text>
    <text x="310" y="305" class="attribute">+endpoint : string</text>
    <line x1="300" y1="315" x2="480" y2="315" stroke="#1976D2" stroke-width="1" />
    <text x="310" y="330" class="method">+invoke(prompt) : string</text>
  </g>

  <!-- FixCommand -->
  <g id="FixCommand">
    <rect x="530" y="250" width="180" height="120" class="class-box" />
    <text x="620" y="270" class="class-name">FixCommand</text>
    <line x1="530" y1="275" x2="710" y2="275" stroke="#1976D2" stroke-width="1" />
    <text x="540" y="290" class="attribute">+fault_type : string</text>
    <text x="540" y="305" class="attribute">+reason : string</text>
    <text x="540" y="320" class="attribute">+fix_script : string</text>
    <text x="540" y="335" class="attribute">+risk_level : RiskLevel</text>
  </g>

  <!-- RiskLevel枚举 -->
  <g id="RiskLevel">
    <rect x="750" y="250" width="120" height="100" class="enum-box" />
    <text x="810" y="270" class="class-name">《enumeration》</text>
    <text x="810" y="285" class="class-name">RiskLevel</text>
    <line x1="750" y1="290" x2="870" y2="290" stroke="#F57C00" stroke-width="1" />
    <text x="810" y="305" class="enum-value">low</text>
    <text x="810" y="320" class="enum-value">medium</text>
    <text x="810" y="335" class="enum-value">high</text>
  </g>

  <!-- 第三行类 -->
  <!-- RepairExecutor -->
  <g id="RepairExecutor">
    <rect x="50" y="420" width="180" height="100" class="class-box" />
    <text x="140" y="440" class="class-name">RepairExecutor</text>
    <line x1="50" y1="445" x2="230" y2="445" stroke="#1976D2" stroke-width="1" />
    <line x1="50" y1="450" x2="230" y2="450" stroke="#1976D2" stroke-width="1" />
    <text x="60" y="465" class="method">+run(script) : ExecResult</text>
    <text x="60" y="480" class="method">+precheck() : bool</text>
  </g>

  <!-- ExecResult -->
  <g id="ExecResult">
    <rect x="280" y="420" width="150" height="100" class="class-box" />
    <text x="355" y="440" class="class-name">ExecResult</text>
    <line x1="280" y1="445" x2="430" y2="445" stroke="#1976D2" stroke-width="1" />
    <text x="290" y="460" class="attribute">+stdout : text</text>
    <text x="290" y="475" class="attribute">+stderr : text</text>
    <text x="290" y="490" class="attribute">+exitCode : int</text>
  </g>

  <!-- FaultRecord -->
  <g id="FaultRecord">
    <rect x="480" y="420" width="180" height="120" class="class-box" />
    <text x="570" y="440" class="class-name">FaultRecord</text>
    <line x1="480" y1="445" x2="660" y2="445" stroke="#1976D2" stroke-width="1" />
    <text x="490" y="460" class="attribute">+id : int</text>
    <text x="490" y="475" class="attribute">+fault_type : string</text>
    <text x="490" y="490" class="attribute">+reason : string</text>
    <text x="490" y="505" class="attribute">+timestamp : datetime</text>
    <text x="490" y="520" class="attribute">+node : string</text>
  </g>

  <!-- ExecLog -->
  <g id="ExecLog">
    <rect x="710" y="420" width="150" height="120" class="class-box" />
    <text x="785" y="440" class="class-name">ExecLog</text>
    <line x1="710" y1="445" x2="860" y2="445" stroke="#1976D2" stroke-width="1" />
    <text x="720" y="460" class="attribute">+id : int</text>
    <text x="720" y="475" class="attribute">+record_id : int</text>
    <text x="720" y="490" class="attribute">+stdout : text</text>
    <text x="720" y="505" class="attribute">+stderr : text</text>
    <text x="720" y="520" class="attribute">+timestamp : datetime</text>
  </g>

  <!-- 第四行类 -->
  <!-- MySQLClient -->
  <g id="MySQLClient">
    <rect x="50" y="590" width="220" height="120" class="class-box" />
    <text x="160" y="610" class="class-name">MySQLClient</text>
    <line x1="50" y1="615" x2="270" y2="615" stroke="#1976D2" stroke-width="1" />
    <line x1="50" y1="620" x2="270" y2="620" stroke="#1976D2" stroke-width="1" />
    <text x="60" y="635" class="method">+saveFault(record: FaultRecord)</text>
    <text x="60" y="650" class="method">+saveExecLog(log: ExecLog)</text>
    <text x="60" y="665" class="method">+queryLogs(filter)</text>
  </g>

  <!-- RedisCache -->
  <g id="RedisCache">
    <rect x="320" y="590" width="180" height="100" class="class-box" />
    <text x="410" y="610" class="class-name">RedisCache</text>
    <line x1="320" y1="615" x2="500" y2="615" stroke="#1976D2" stroke-width="1" />
    <line x1="320" y1="620" x2="500" y2="620" stroke="#1976D2" stroke-width="1" />
    <text x="330" y="635" class="method">+set(key, value)</text>
    <text x="330" y="650" class="method">+publish(channel, msg)</text>
    <text x="330" y="665" class="method">+get(key)</text>
  </g>

  <!-- ClusterStatus -->
  <g id="ClusterStatus">
    <rect x="550" y="590" width="180" height="120" class="class-box" />
    <text x="640" y="610" class="class-name">ClusterStatus</text>
    <line x1="550" y1="615" x2="730" y2="615" stroke="#1976D2" stroke-width="1" />
    <text x="560" y="630" class="attribute">+nodesUp : int</text>
    <text x="560" y="645" class="attribute">+nodesDown : int</text>
    <text x="560" y="660" class="attribute">+hdfsUsage : float</text>
    <text x="560" y="675" class="attribute">+yarnActiveApps : int</text>
  </g>

  <!-- FrontendWeb -->
  <g id="FrontendWeb">
    <rect x="780" y="590" width="180" height="120" class="class-box" />
    <text x="870" y="610" class="class-name">FrontendWeb</text>
    <line x1="780" y1="615" x2="960" y2="615" stroke="#1976D2" stroke-width="1" />
    <line x1="780" y1="620" x2="960" y2="620" stroke="#1976D2" stroke-width="1" />
    <text x="790" y="635" class="method">+viewStatus()</text>
    <text x="790" y="650" class="method">+queryLogs()</text>
    <text x="790" y="665" class="method">+requestDiagnosis()</text>
    <text x="790" y="680" class="method">+executeRepair()</text>
  </g>

  <!-- 关联关系 -->
  <!-- FlumeAgent -> FastAPIService -->
  <line x1="200" y1="110" x2="480" y2="130" class="association" />
  <text x="340" y="115" class="note-text">push(LogEvent)</text>

  <!-- FastAPIService -> DiagnosisService -->
  <line x1="520" y1="210" x2="180" y2="250" class="association" />
  <text x="350" y="225" class="note-text">diagnose(logs)</text>

  <!-- DiagnosisService -> LLMClient -->
  <line x1="250" y1="290" x2="300" y2="290" class="association" />
  <text x="275" y="285" class="note-text">call_llm_diagnose</text>

  <!-- DiagnosisService -> FixCommand -->
  <line x1="250" y1="310" x2="530" y2="320" class="association" />
  <text x="390" y="310" class="note-text">returns</text>

  <!-- FastAPIService -> RepairExecutor -->
  <line x1="550" y1="210" x2="150" y2="420" class="association" />
  <text x="350" y="315" class="note-text">execute(FixCommand)</text>

  <!-- RepairExecutor -> ExecResult -->
  <line x1="230" y1="470" x2="280" y2="470" class="association" />
  <text x="255" y="465" class="note-text">returns</text>

  <!-- FastAPIService -> MySQLClient -->
  <line x1="550" y1="210" x2="200" y2="590" class="association" />
  <text x="375" y="400" class="note-text">save FaultRecord/ExecLog</text>

  <!-- FastAPIService -> RedisCache -->
  <line x1="580" y1="210" x2="420" y2="590" class="association" />
  <text x="500" y="400" class="note-text">cache/publish status</text>

  <!-- FrontendWeb -> FastAPIService -->
  <line x1="850" y1="590" x2="620" y2="210" class="association" />
  <text x="735" y="400" class="note-text">REST/WebSocket</text>

  <!-- FastAPIService -> ClusterStatus -->
  <line x1="620" y1="210" x2="640" y2="590" class="association" />
  <text x="630" y="400" class="note-text">compose</text>

  <!-- MySQLClient -> FaultRecord -->
  <line x1="270" y1="620" x2="480" y2="480" class="composition" />

  <!-- MySQLClient -> ExecLog -->
  <line x1="270" y1="650" x2="710" y2="500" class="composition" />

  <!-- FixCommand -> RiskLevel -->
  <line x1="710" y1="320" x2="750" y2="320" class="association" />

  <!-- 注释框 -->
  <g id="note">
    <rect x="950" y="250" width="400" height="150" class="note-box" />
    <text x="960" y="270" class="note-text" font-weight="bold">FixCommand JSON 示例:</text>
    <text x="960" y="290" class="note-text">{</text>
    <text x="970" y="305" class="note-text"> fault_type: "DataNode故障",</text>
    <text x="970" y="320" class="note-text"> reason: "磁盘占满",</text>
    <text x="970" y="335" class="note-text"> fix_script: "ssh dn 'clean_temp.sh'",</text>
    <text x="970" y="350" class="note-text"> risk_level: "medium"</text>
    <text x="960" y="365" class="note-text">}</text>
  </g>

  <!-- 系统架构说明 -->
  <g id="architecture-note">
    <rect x="50" y="750" width="1300" height="200" fill="#F5F5F5" stroke="#CCCCCC" stroke-width="1" />
    <text x="60" y="770" class="class-name">系统架构说明：</text>
    <text x="70" y="790" class="note-text">• 数据流：FlumeAgent收集日志 → FastAPIService处理 → DiagnosisService诊断 → LLMClient生成修复命令</text>
    <text x="70" y="810" class="note-text">• 执行流：RepairExecutor执行修复脚本 → ExecResult返回结果 → MySQLClient保存记录</text>
    <text x="70" y="830" class="note-text">• 缓存层：RedisCache提供状态缓存和消息发布功能</text>
    <text x="70" y="850" class="note-text">• 前端交互：FrontendWeb通过REST API和WebSocket与FastAPIService通信</text>
    <text x="70" y="870" class="note-text">• 数据持久化：MySQLClient负责FaultRecord和ExecLog的存储管理</text>
    <text x="70" y="890" class="note-text">• 风险控制：FixCommand包含风险等级，DiagnosisService进行命令验证</text>
    <text x="70" y="910" class="note-text">• 集群监控：ClusterStatus提供实时集群状态信息</text>
  </g>
</svg>