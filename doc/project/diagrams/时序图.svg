<?xml version="1.0" encoding="UTF-8"?>
<svg width="1400" height="1000" xmlns="http://www.w3.org/2000/svg" style="background-color: white;">
  <defs>
    <style>
      .title { font-family: 'Microsoft YaHei', sans-serif; font-size: 24px; font-weight: bold; text-anchor: middle; }
      .participant-title { font-family: 'Microsoft YaHei', sans-serif; font-size: 14px; font-weight: bold; text-anchor: middle; }
      .message-text { font-family: 'Microsoft YaHei', sans-serif; font-size: 12px; }
      .participant-box { fill: #E3F2FD; stroke: #1976D2; stroke-width: 2; }
      .lifeline { stroke: #666666; stroke-width: 2; stroke-dasharray: 5,5; }
      .message-arrow { stroke: #333333; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
      .return-arrow { stroke: #666666; stroke-width: 1; fill: none; marker-end: url(#arrowhead-return); stroke-dasharray: 3,3; }
      .activation { fill: #FFEB3B; stroke: #F57F17; stroke-width: 1; }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#333333" />
    </marker>
    <marker id="arrowhead-return" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#666666" />
    </marker>
  </defs>

  <!-- 标题 -->
  <text x="700" y="30" class="title">日志诊断与自动修复流程</text>

  <!-- 参与者 -->
  <g id="participants">
    <!-- User -->
    <rect x="50" y="60" width="80" height="40" class="participant-box" />
    <text x="90" y="83" class="participant-title">User</text>
    
    <!-- Frontend -->
    <rect x="180" y="60" width="100" height="40" class="participant-box" />
    <text x="230" y="83" class="participant-title">Frontend</text>
    
    <!-- FastAPI -->
    <rect x="330" y="60" width="100" height="40" class="participant-box" />
    <text x="380" y="83" class="participant-title">FastAPI</text>
    
    <!-- Flume -->
    <rect x="480" y="60" width="80" height="40" class="participant-box" />
    <text x="520" y="83" class="participant-title">Flume</text>
    
    <!-- MySQL -->
    <rect x="610" y="60" width="80" height="40" class="participant-box" />
    <text x="650" y="83" class="participant-title">MySQL</text>
    
    <!-- Redis -->
    <rect x="740" y="60" width="80" height="40" class="participant-box" />
    <text x="780" y="83" class="participant-title">Redis</text>
    
    <!-- LLM -->
    <rect x="870" y="60" width="80" height="40" class="participant-box" />
    <text x="910" y="83" class="participant-title">LLM</text>
    
    <!-- 修复脚本 -->
    <rect x="1000" y="60" width="100" height="40" class="participant-box" />
    <text x="1050" y="83" class="participant-title">修复脚本</text>
  </g>

  <!-- 生命线 -->
  <g id="lifelines">
    <line x1="90" y1="100" x2="90" y2="950" class="lifeline" />
    <line x1="230" y1="100" x2="230" y2="950" class="lifeline" />
    <line x1="380" y1="100" x2="380" y2="950" class="lifeline" />
    <line x1="520" y1="100" x2="520" y2="950" class="lifeline" />
    <line x1="650" y1="100" x2="650" y2="950" class="lifeline" />
    <line x1="780" y1="100" x2="780" y2="950" class="lifeline" />
    <line x1="910" y1="100" x2="910" y2="950" class="lifeline" />
    <line x1="1050" y1="100" x2="1050" y2="950" class="lifeline" />
  </g>

  <!-- 消息序列 -->
  <g id="messages">
    <!-- 1. Flume -> API : 推送结构化日志 -->
    <line x1="520" y1="140" x2="380" y2="140" class="message-arrow" />
    <text x="430" y="135" class="message-text">推送结构化日志</text>
    <rect x="375" y="145" width="10" height="30" class="activation" />
    
    <!-- 2. API -> DB : 写入 fault_record -->
    <line x1="380" y1="180" x2="650" y2="180" class="message-arrow" />
    <text x="500" y="175" class="message-text">写入 fault_record</text>
    <rect x="645" y="185" width="10" height="20" class="activation" />
    
    <!-- 3. FE -> API : 查询 /api/logs/query -->
    <line x1="230" y1="220" x2="380" y2="220" class="message-arrow" />
    <text x="280" y="215" class="message-text">查询 /api/logs/query</text>
    <rect x="375" y="225" width="10" height="30" class="activation" />
    
    <!-- 4. API -> FE : 返回日志列表 -->
    <line x1="380" y1="260" x2="230" y2="260" class="return-arrow" />
    <text x="280" y="255" class="message-text">返回日志列表</text>
    
    <!-- 5. API -> LLM : call_llm_diagnose(logs) -->
    <line x1="380" y1="300" x2="910" y2="300" class="message-arrow" />
    <text x="620" y="295" class="message-text">call_llm_diagnose(logs)</text>
    <rect x="905" y="305" width="10" height="40" class="activation" />
    
    <!-- 6. LLM -> API : 返回 FixCommand(JSON) -->
    <line x1="910" y1="340" x2="380" y2="340" class="return-arrow" />
    <text x="620" y="335" class="message-text">返回 FixCommand(JSON)</text>
    <rect x="375" y="345" width="10" height="80" class="activation" />
    
    <!-- 7. API -> DB : 写入 exec_log -->
    <line x1="380" y1="380" x2="650" y2="380" class="message-arrow" />
    <text x="500" y="375" class="message-text">写入 exec_log</text>
    <rect x="645" y="385" width="10" height="20" class="activation" />
    
    <!-- 8. API -> Redis : 缓存/发布修复任务 -->
    <line x1="380" y1="420" x2="780" y2="420" class="message-arrow" />
    <text x="560" y="415" class="message-text">缓存/发布修复任务</text>
    <rect x="775" y="425" width="10" height="20" class="activation" />
    
    <!-- 9. API -> FE : WebSocket 推送诊断结果 -->
    <line x1="380" y1="460" x2="230" y2="460" class="message-arrow" />
    <text x="280" y="455" class="message-text">WebSocket 推送诊断结果</text>
    
    <!-- 10. FE -> API : /api/repair/execute -->
    <line x1="230" y1="500" x2="380" y2="500" class="message-arrow" />
    <text x="280" y="495" class="message-text">/api/repair/execute</text>
    <rect x="375" y="505" width="10" height="120" class="activation" />
    
    <!-- 11. API -> 修复脚本 : 执行Shell/Hadoop命令 -->
    <line x1="380" y1="540" x2="1050" y2="540" class="message-arrow" />
    <text x="700" y="535" class="message-text">执行Shell/Hadoop命令</text>
    <rect x="1045" y="545" width="10" height="60" class="activation" />
    
    <!-- 12. 修复脚本 -> API : stdout/stderr -->
    <line x1="1050" y1="580" x2="380" y2="580" class="return-arrow" />
    <text x="700" y="575" class="message-text">stdout/stderr</text>
    
    <!-- 13. API -> DB : 更新 exec_log -->
    <line x1="380" y1="620" x2="650" y2="620" class="message-arrow" />
    <text x="500" y="615" class="message-text">更新 exec_log</text>
    <rect x="645" y="625" width="10" height="20" class="activation" />
    
    <!-- 14. API -> FE : 返回执行结果 -->
    <line x1="380" y1="660" x2="230" y2="660" class="return-arrow" />
    <text x="280" y="655" class="message-text">返回执行结果</text>
  </g>

  <!-- 注释区域 -->
  <g id="notes">
    <rect x="50" y="720" width="1300" height="200" fill="#F5F5F5" stroke="#CCCCCC" stroke-width="1" />
    <text x="60" y="740" class="participant-title">流程说明：</text>
    <text x="70" y="760" class="message-text">1. Flume收集日志并推送到FastAPI后端</text>
    <text x="70" y="780" class="message-text">2. 系统将日志存储到MySQL数据库</text>
    <text x="70" y="800" class="message-text">3. 前端查询日志并展示给用户</text>
    <text x="70" y="820" class="message-text">4. 系统调用LLM进行智能诊断，生成修复命令</text>
    <text x="70" y="840" class="message-text">5. 诊断结果通过WebSocket实时推送到前端</text>
    <text x="70" y="860" class="message-text">6. 用户确认后执行自动修复，系统记录执行过程和结果</text>
    <text x="70" y="880" class="message-text">7. Redis用于缓存任务状态和消息队列管理</text>
  </g>
</svg>