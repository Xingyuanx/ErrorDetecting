# 登录/注册模块前后端联调详细教程（分角色分阶段）

## 目标与范围
- 目标：在开发网络内让前端同学本地运行页面并稳定访问同一套后端与数据库，完成登录/注册模块的联调与测试。
- 范围：Windows 开发环境；后端 FastAPI + SQLAlchemy（异步，`asyncpg`）；数据库 PostgreSQL；前端为静态站点（`src/fronted`）。

## 角色与职责
- 数据库管理员（DBA）：部署 PostgreSQL、建库建表、放行网络、提供连接串。
- 后端负责人（BE）：配置 `.env`、安装依赖、启动后端、开放端口、提供 API。
- 前端开发（FE）：启动静态站点、配置后端基地址、发起接口请求、验证 CORS。
- 联调与测试（QA/协同）：执行跨角色的验证脚本，记录问题并推动修复。

## 阶段划分与通过标准
- 阶段 0：网络与信息准备 → 互相 `ping` 可达，记录 IP/端口/用户信息
- 阶段 1：数据库部署与放行（DBA） → `psql SELECT 1` 成功，其他电脑 `Test-NetConnection` 通过
- 阶段 2：后端启动与连通性验证（BE） → `/api/v1/health` 返回 `{"status":"ok"}`
- 阶段 3：前端启动与联调准备（FE） → FE 本地页面能请求 `health/clusters/faults/logs`
- 阶段 4：登录/注册联调与验收（FE+BE+QA） → 注册/登录/`/user/me` 流程完整可用

---

## 阶段 0：网络与信息准备（所有角色）
**步骤**
- 查询本机 IP：
  ```powershell
  ipconfig
  ```
- 测试连通：
  ```powershell
  ping <对方IP>
  ```
- 记录统一信息（示例）：
  - 后端开发机 IP：`192.168.1.50`
  - 数据库主机 IP：`192.168.1.50:5432`
  - 后端服务端口：`8000`
  - 数据库：`hadoop_fault_db`，账户：`app_user`

**验证通过标准**
- 前端电脑可以 `ping` 通后端开发机与数据库主机，并记录信息到协同表格。

---

## 阶段 1：数据库部署与放行（DBA）
**方案 A：本地安装 PostgreSQL**
1) 配置远程监听：
- 编辑 `postgresql.conf`：`listen_addresses = '*'`
- 编辑 `pg_hba.conf`：添加网段白名单（示例）
  ```
  host all all 192.168.1.0/24 md5
  ```
2) 重启服务并开放端口（Windows 防火墙）：
```powershell
New-NetFirewallRule -DisplayName "Postgres 5432" -Direction Inbound -LocalPort 5432 -Protocol TCP -Action Allow
```
3) 创建数据库与用户（在 `psql` 中执行）：
```sql
CREATE DATABASE hadoop_fault_db;
CREATE USER app_user WITH PASSWORD 'StrongPassword123!';
GRANT ALL PRIVILEGES ON DATABASE hadoop_fault_db TO app_user;
```
4) 执行建表脚本：
```powershell
psql -h <DB主机> -U app_user -d hadoop_fault_db -f "doc/project/数据库建表脚本_postgres.sql"
```

**方案 B：Docker 快速部署**
```powershell
docker run --name pg14 -e POSTGRES_PASSWORD=StrongPassword123! -p 5432:5432 -d postgres:14
docker exec -it pg14 psql -U postgres -c "CREATE DATABASE hadoop_fault_db;"
docker exec -it pg14 psql -U postgres -c "CREATE USER app_user WITH PASSWORD 'StrongPassword123!';"
docker exec -it pg14 psql -U postgres -d hadoop_fault_db -c "GRANT ALL PRIVILEGES ON DATABASE hadoop_fault_db TO app_user;"
docker cp "doc/project/数据库建表脚本_postgres.sql" pg14:/tmp/schema.sql
docker exec -it pg14 psql -U app_user -d hadoop_fault_db -f /tmp/schema.sql
```

**验证通过标准**
- 任一电脑执行：
  ```powershell
  psql -h <DB主机> -U app_user -d hadoop_fault_db -c "SELECT 1"
  Test-NetConnection <DB主机> -Port 5432
  ```
- 结果显示查询成功，`TcpTestSucceeded : True`。

---

## 阶段 2：后端启动与连通性验证（BE）
**安装依赖与配置环境**
```powershell
cd e:\学习通\download\软件项目管理\故障检测\项目\ErrorDetecting
python -m venv venv
venv\Scripts\activate
pip install -r src\backend\requirements.txt
```

**创建 `.env`（与 `src/backend/app/config.py:6-9` 加载逻辑一致）**
```env
DATABASE_URL=postgresql+asyncpg://app_user:StrongPassword123!@<DB主机>:5432/hadoop_fault_db
```

**启动后端并监听局域网**
```powershell
uvicorn src.backend.app.main:app --host 0.0.0.0 --port 8000 --reload
```

**开放 8000 端口（Windows 防火墙）**
```powershell
New-NetFirewallRule -DisplayName "Uvicorn 8000" -Direction Inbound -LocalPort 8000 -Protocol TCP -Action Allow
```

**可用联调端点**
- 健康检查：`GET http://<后端IP>:8000/api/v1/health`（`src/backend/app/routers/health.py:7-11`）
- 集群列表：`GET http://<后端IP>:8000/api/v1/clusters`（`src/backend/app/routers/clusters.py:9-14`）
- 故障列表：`GET http://<后端IP>:8000/api/v1/faults`（`src/backend/app/routers/faults.py:9-14`）
- 系统日志：`GET http://<后端IP>:8000/api/v1/logs?page=1&pageSize=10`（`src/backend/app/routers/logs.py:9-23`）

**验证通过标准**
- 前端电脑执行：
  ```powershell
  curl http://<后端IP>:8000/api/v1/health
  ```
- 返回 `{"status":"ok"}`；后端控制台无错误（数据库连通：`health_check` 会执行 `SELECT 1`）。

---

## 阶段 3：前端启动与联调准备（FE）
**启动静态站点服务**
- Node 方案：
  ```powershell
  npx http-server src/fronted -p 5173
  ```
- Python 方案：
  ```powershell
  cd src\fronted
  python -m http.server 5173
  ```
- 打开浏览器：`http://localhost:5173`

**配置后端基地址（开发）**
- 将前端调用统一指向：`http://<后端IP>:8000/api/v1`

**验证通过标准**
- 浏览器直接访问：`http://<后端IP>:8000/api/v1/health` 返回 `ok`
- 从前端页面发起请求到 `health/clusters/faults/logs` 均正常返回；控制台无 CORS 报错（`src/backend/app/main.py:7-13` 开启任意来源）。

---

## 阶段 4：登录/注册联调与验收（FE+BE+QA）
**后端接口建议（落地后联调）**
- `POST /api/v1/user/register`：`{ username, password, email }` → 入库 `users`
- `POST /api/v1/user/login`：`{ username, password }` → 返回 `{ access_token, token_type }`
- `GET /api/v1/user/me`：`Authorization: Bearer <token>` → 返回当前用户

**前端联调要点**
- 替换本地演示登录逻辑为真实 `fetch/axios` 调用；登录成功后保存 `access_token` 到 `localStorage`，在后续请求中注入 `Authorization: Bearer <token>`。

**示例验证命令（后端接口就绪后执行）**
```powershell
# 注册
curl -X POST http://<后端IP>:8000/api/v1/user/register -H "Content-Type: application/json" -d "{\"username\":\"admin\",\"password\":\"Admin123!\",\"email\":\"admin@example.com\"}"

# 登录
curl -X POST http://<后端IP>:8000/api/v1/user/login -H "Content-Type: application/json" -d "{\"username\":\"admin\",\"password\":\"Admin123!\"}"

# 获取当前用户（替换 <access_token>）
curl http://<后端IP>:8000/api/v1/user/me -H "Authorization: Bearer <access_token>"
```

**验收标准**
- 注册返回成功并在 `users` 表可见记录。
- 登录返回有效 `access_token`；`/user/me` 返回当前用户信息。
- 前端展示用户菜单、受控页面按角色可见；携带 Token 的后续请求成功。

---

## 故障排查与回滚建议
**端口不可达**
- 后端：确认 `--host 0.0.0.0`、防火墙入站规则（`8000`）、`Test-NetConnection <后端IP> -Port 8000`
- 数据库：检查 `pg_hba.conf` 白名单、`postgresql.conf` 监听、`5432` 防火墙

**数据库认证失败**
- 统一连接串与口令，确保 `.env` 生效；校验 `app_user` 权限与表是否存在。

**CORS 报错**
- 开发阶段允许任意来源；联调稳定后将 `allow_origins` 收敛到 FE 来源（如 `http://localhost:5173`）。

**JWT 校验失败**
- FE 是否正确传入 `Authorization: Bearer <token>`；后端 `JWT_SECRET`/过期时间一致（落地登录后）。

**回滚建议**
- 回到阶段 2/3 先以 `health`/列表接口验证链路，登录/注册接口再增量上线。

---

## 安全与合规
- 仅在受控内网放行 `5432/8000`；使用隧道工具时加 IP 白名单与强密码。
- `.env` 不入库，敏感信息只在环境中配置。
- CORS 在联调后尽快收敛到明确的 FE 开发来源列表。

---

## 关键代码位置（便于对焦）
- CORS 配置：`src/backend/app/main.py:7-13`
- 环境变量加载与默认连接串：`src/backend/app/config.py:6-9`
- 数据库异步会话：`src/backend/app/db.py:1-10`
- 健康检查：`src/backend/app/routers/health.py:7-11`
- 列表接口：
  - 集群：`src/backend/app/routers/clusters.py:9-14`
  - 故障：`src/backend/app/routers/faults.py:9-14`
  - 日志：`src/backend/app/routers/logs.py:9-23`

---

## 常用验证命令清单（PowerShell）
```powershell
# 网络
ipconfig
ping <对方IP>
Test-NetConnection <主机> -Port <端口>

# 数据库
psql -h <DB主机> -U app_user -d hadoop_fault_db -c "SELECT 1"

# 后端
uvicorn src.backend.app.main:app --host 0.0.0.0 --port 8000 --reload
curl http://<后端IP>:8000/api/v1/health

# 前端（二选一）
npx http-server src/fronted -p 5173
cd src\fronted; python -m http.server 5173
```

