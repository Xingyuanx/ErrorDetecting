# 基于 Hadoop 的故障检测与智能诊断项目 - 需求规格说明书 (SRS)

## 1. 引言

### 1.1 目的
本说明书详细定义了“Hadoop 故障检测与智能诊断系统”的功能性与非功能性需求，作为系统设计、开发、测试及验收的权威依据。

### 1.2 范围
本系统包含：基于 FastAPI 的异步后端、基于 SSH 的分布式日志与指标采集引擎、基于 OpenAI 的 AI 诊断智能体、以及配套的 PostgreSQL 数据库模型。

## 2. 总体描述

### 2.1 软件架构
系统采用前后端分离架构，后端通过异步任务驱动采集逻辑，利用智能体技术封装运维经验，支持水平扩展以管理多个 Hadoop 集群。

### 2.2 用户角色
- **管理员**: 拥有所有集群的管理权限，可增删改查用户及全局配置。
- **运维人员**: 可执行诊断任务、配置采集器、下发修复指令。
- **审计员**: 仅可查看执行日志与审计报表。

## 3. 功能需求

### 3.1 集群与节点管理 (Cluster & Node Management)
- **F-01-01 集群注册**: 支持通过名称、NameNode IP 注册集群。
- **F-01-02 SSH 校验**: 注册时自动测试 SSH 连接，确保后端可操控节点。
- **F-01-03 节点发现**: 自动同步集群下的所有节点（DataNode, ResourceManager 等）。

### 3.2 自动化指标采集 (Automated Metrics Collection)
- **F-02-01 周期采集**: 默认每 60 秒采集一次各节点的 CPU 和内存占用。
- **F-02-02 趋势分析**: 提供历史指标接口，支持前端绘制负载曲线。
- **F-02-03 采集控制**: 支持手动启动或停止特定集群的采集任务。

### 3.3 日志管理与采集 (Log Management)
- **F-03-01 远程读取**: 支持按路径或预定义类型（Hadoop/System）读取远程日志。
- **F-03-02 增量采集**: 采集器自动维持 SSH 链接，实时将日志增量写入数据库。
- **F-03-03 日志检索**: 提供多维度（级别、内容、节点、时间）的高性能检索。

### 3.4 AI 故障诊断 (AI-Powered Diagnosis)
- **F-04-01 SSE 流式对话**: 支持基于 OpenAI 的流式输出，提升用户交互体验。
- **F-04-02 工具链调用**: AI 可自动调用“读取日志”、“执行命令”等工具收集证据。
- **F-04-03 报告生成**: 自动根据诊断上下文生成 MD 格式的分析报告。

### 3.5 运维审计 (Operations Auditing)
- **F-05-01 命令记录**: 记录所有通过平台执行的远程 shell 命令及其退出码。
- **F-05-02 审计追踪**: 记录关键配置修改及登录行为。

## 4. 接口规范 (API Specification)

### 4.1 认证接口
- `POST /api/v1/auth/login`: 登录并返回 JWT。
- `POST /api/v1/auth/register`: 注册新账户。

### 4.2 集群接口
- `GET /api/v1/clusters`: 获取集群列表。
- `POST /api/v1/clusters/verify`: 验证 SSH 连接。

### 4.3 日志接口
- `GET /api/v1/hadoop/logs`: 分页检索持久化日志。
- `GET /api/v1/hadoop/logs/{node}/{type}`: 读取节点实时日志。

### 4.4 AI 接口
- `POST /api/v1/ai/chat`: 发起诊断对话（SSE）。

## 5. 数据库设计要点

- **用户表 (users)**: 存储哈希后的密码及角色。
- **集群表 (clusters)**: 存储 UUID、管理 IP 及配置 JSON。
- **日志表 (hadoop_logs)**: 采用分表或索引优化，存储大规模结构化日志。
- **指标表 (node_metrics)**: 动态 Schema，存储时序监控数据。

## 6. 非功能需求

- **可用性**: 核心采集服务具备断线重连机制。
- **性能**: API 接口平均响应时间 < 500ms（不含 AI 调用）。
- **安全性**: 所有接口必须经过 JWT 校验（除公开健康检查外）。
- **兼容性**: 支持 Hadoop 2.x/3.x 版本的标准日志路径。
