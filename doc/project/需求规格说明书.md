# 基于Hadoop的故障检测与自动恢复项目 需求规格说明书（SRS）

## 1. 引言
- 目的：定义系统的功能与非功能需求，为设计、开发、测试与验收提供统一依据。
- 范围：Web 应用（前端、后端、多智能体编排）、日志采集、数据库与缓存、可观测性。
- 术语：Cluster、Node、Fault、ExecLog、Agent、Policy、JSONB、INET、TIMESTAMPTZ。
- 参考：
  - `doc/project/数据库设计文档.md`
  - `doc/project/数据库建表脚本_postgres.sql`
  - `doc/project/ER图设计说明.md`
  - `src/fronted/index.html`（前端原型）
  - `doc/project/项目前景与范围文档.md`

## 2. 总体概述
- 产品透视：为 Hadoop 运维提供监控、日志分析、智能诊断与自动修复的一体化平台。
- 用户特征：管理员、操作员、观察员（角色权限定义与审批流程）。
- 约束：PostgreSQL 14+、Redis、FastAPI、Vue3、Flume；遵循安全与合规最佳实践。

## 3. 功能需求（按模块）

### F-01 身份认证与注册审批
- 说明：登录、注册（审批队列）、用户状态管理、JWT 认证。
- 前端映射：`#login`、`#register`、`#user-management`（审批列表）。
- 接口示例：`POST /api/v1/user/login`、`POST /api/v1/user/register`、`GET /api/v1/admin/approvals`、`POST /api/v1/admin/approvals/{id}/approve`、`GET /api/v1/user/me`。
- 数据映射：`users`、`audit_logs`、`roles/user_role_mapping`。
- 验收：登录成功生成 JWT 与角色；注册进入审批队列；操作审计记录完整；受保护接口需携带 `Authorization: Bearer <token>`。

### F-02 集群列表与注册
- 说明：查看已注册集群、注册新集群、注销集群。
- 前端映射：`#cluster-list`（注册面板/列表）。
- 接口示例：`GET /api/clusters`、`POST /api/clusters`、`DELETE /api/clusters/{uuid}`。
- 数据映射：`clusters(uuid,name,type,node_count,health_status,config_info)`。
- 验收：集群唯一性（uuid/name）；健康状态检查约束；审计可追踪。

### F-03 仪表板监控
- 说明：节点概览、状态指标、趋势图（CPU/内存）、WebSocket 状态。
- 前端映射：`#dashboard`（统计卡片、图表、节点表格）。
- 接口示例：`GET /api/cluster/status`、`GET /api/nodes?cluster=...`、WS `/ws/status`。
- 数据映射：`nodes(cluster_id,hostname,ip_address,status,usage,last_heartbeat)`。
- 验收：节点列表与统计一致；图表数据刷新正常；WS 在线率达标。

### F-04 日志查询
- 说明：按级别/来源集群/来源节点/操作类型/用户ID/时间范围筛选，支持导出。
- 前端映射：`#logs`（搜索条件/列表/分页）。
- 接口示例：`GET /api/logs?level=&cluster=&node=&op=&user=&time_range=`、`GET /api/logs/export`。
- 数据映射：`system_logs(log_id,timestamp,host,service,log_level,message,exception,raw_log,processed)`。
- 验收：筛选项工作正常；分页与导出准确；处理进度与日志条目一致。

### F-05 故障诊断（多智能体）
- 说明：拖拽上下文日志，选择智能体与模型，生成诊断结果与修复建议。
- 前端映射：`#diagnosis`（树形选择/预览/多智能体面板/对话）。
- 接口示例：`POST /api/llm/diagnose`（结构化日志→诊断结果），`POST /api/llm/report`（生成状态报告）。
- 数据映射：`fault_records(affected_nodes,affected_clusters,root_cause,repair_suggestion,status)`、`exec_logs(parameters,target_nodes)`。
- 验收：DiagnosisAgent 输出结构化建议；PolicyAgent 过滤高风险；生成报告成功。

### F-06 故障中心（CRUD）
- 说明：故障列表筛选、详情、增删改；状态机（detected→analyzing→repairing→resolved/failed）。
- 前端映射：`#fault-center`（筛选/列表/操作）。
- 接口示例：`GET /api/faults`、`POST /api/faults`、`PUT /api/faults/{id}`、`DELETE /api/faults/{id}`、`POST /api/faults/{id}/transition`。
- 数据映射：`fault_records(fault_id,fault_type,fault_level,status,title,created_at,...)`。
- 验收：唯一约束 `fault_id`；状态转换合法且有审计记录；索引支持高频查询。

### F-07 执行日志（CRUD）
- 说明：记录修复命令执行详情，支持筛选与分页。
- 前端映射：`#exec-logs`（列表/操作）。
- 接口示例：`GET /api/exec-logs`、`POST /api/exec-logs`、`PUT /api/exec-logs/{id}`、`DELETE /api/exec-logs/{id}`。
- 数据映射：`exec_logs(exec_id,fault_id,command_type,command_content,target_nodes,risk_level,execution_status,start_time,end_time,stdout_log,stderr_log,exit_code,operator)`。
- 验收：外键 `fault_id` 关联完整；执行状态与时长约束合法；日志内容可读。

### F-08 告警配置（规则管理原型）
- 说明：新增/编辑/删除规则，通知渠道（邮件/短信/Webhook），阈值条件。
- 前端映射：`#alert-config`（新增弹窗/规则列表）。
- 接口示例：`GET /api/alerts`、`POST /api/alerts`、`PUT /api/alerts/{id}`、`DELETE /api/alerts/{id}`。
- 数据映射：`app_configurations(config_type='alert_rule',config_key,config_value,is_enabled)`。
- 验收：配置值以 JSONB 存储；启用状态可控；策略与通知联动。

### F-09 用户管理与角色分配
- 说明：用户列表、状态（启用/禁用/待审核）、角色分配与撤销。
- 前端映射：`#user-management`、`#role-assignment`。
- 接口示例：`GET /api/admin/users`、`POST /api/admin/users`、`PUT /api/admin/users/{id}`、`POST /api/admin/users/{id}/roles`。
- 数据映射：`users`、`user_role_mapping`、`roles`。
- 验收：用户名/邮箱唯一；角色分配与撤销一致；审计完整。

### F-10 权限策略（原型）
- 说明：资源与操作的允许/拒绝策略配置。
- 前端映射：`#permission-policy`（策略列表）。
- 接口示例：`GET /api/policies`、`POST /api/policies`、`DELETE /api/policies/{id}`。
- 数据映射：`roles`、`permissions`、`role_permission_mapping`。
- 验收：策略生效与资源范围匹配；拒绝优先；审计记录。

### F-11 审计日志
- 说明：记录用户操作与系统事件，可筛选导出。
- 前端映射：`#audit-logs`。
- 接口示例：`GET /api/audit-logs`、`GET /api/audit-logs/export`。
- 数据映射：`audit_logs(user_id,cluster_id,role_id,action,resource_type,ip_address,request_data,response_status,created_at)`。
- 验收：字段完整；IP 为 INET；JSONB 字段审计可读；索引满足查询需求。

### F-12 WebSocket 推送
- 说明：状态与诊断结果的实时推送；前端 WS 状态展示。
- 前端映射：`#dashboard`（WebSocket 状态区）。
- 接口示例：WS `/ws/status`、`/ws/diagnose`。
- 验收：WS 连接稳定；消息格式统一；断线重连策略有效。

## 4. 非功能性需求
- 性能：核心查询 P95 ≤ 500ms；WS 延迟 ≤ 500ms；后端并发 1k 连接稳定。
- 安全：基于角色的访问控制；敏感信息不落盘；API 速率限制与审计。
- 可靠性：日常备份与恢复演练（`pg_dump`）；关键链路重试与降级。
- 可维护性：模块化架构；多智能体职责清晰；日志与监控完善。
- 可用性：前端可访问性（ARIA 标签与语义结构）；错误提示与操作引导。
- 可观测性：Prometheus 指标采集；Grafana 看板；日志分级与追踪ID。

## 5. 数据需求
- 数据库：PostgreSQL（JSONB/UUID/INET/TIMESTAMPTZ），参见建表脚本与数据字典。
- 关键实体：`clusters`、`nodes`、`system_logs`、`fault_records`、`exec_logs`、`app_configurations`、`users`、`audit_logs`、`roles`、`permissions`、`user_role_mapping`、`role_permission_mapping`、`user_cluster_mapping`。
- 约束：唯一键与外键完整；检查约束覆盖状态与枚举值；索引优化高频查询。

## 6. 外部接口
- 日志采集：Flume → `POST /api/log/auto-upload`。
- 集群状态：`GET /api/cluster/status`（可缓存 Redis）。
- 诊断：`POST /api/llm/diagnose`；修复报告：`POST /api/llm/report`。
- 故障与执行：`/api/faults/*`、`/api/exec-logs/*`。
- 告警与配置：`/api/alerts/*`、`/api/configs/*`。
- 审计与用户：`/api/audit-logs/*`、`/api/admin/*`。

## 7. 状态机定义
- 故障状态：`detected → analyzing → repairing → {resolved | failed}`；事件驱动与审批联动（高风险需审批）。
- 执行状态：`pending → running → {success | failed | timeout}`；时长与退出码记录完整。

## 8. 用例与原型映射
- 集群列表/注册 → `#cluster-list`、`clusters`、`/api/clusters`。
- 仪表板监控 → `#dashboard`、`nodes`、`/api/cluster/status`、WS `/ws/status`。
- 日志查询 → `#logs`、`system_logs`、`/api/logs`。
- 故障诊断 → `#diagnosis`、`fault_records/exec_logs`、`/api/llm/diagnose`。
- 故障中心 → `#fault-center`、`fault_records`、`/api/faults/*`。
- 执行日志 → `#exec-logs`、`exec_logs`、`/api/exec-logs/*`。
- 告警配置 → `#alert-config`、`app_configurations`、`/api/alerts/*`。
- 用户管理/角色 → `#user-management/#role-assignment`、`users/roles/user_role_mapping`、`/api/admin/*`。
- 权限策略 → `#permission-policy`、`roles/permissions/role_permission_mapping`。
- 审计日志 → `#audit-logs`、`audit_logs`、`/api/audit-logs/*`。

## 9. 验收标准
- 端到端闭环：日志→诊断→修复→审计→报表。
- 指标达标：准确率/时效性/复发率/KPI 满足“前景与范围文档”定义。
- 安全合规：权限与审计完整，敏感信息管理符合最佳实践。
- 文档齐备：API、数据字典、ER 与部署说明一致。

## 10. 需求追踪矩阵（摘要）
- 功能模块 ↔ 前端页面 ↔ 后端接口 ↔ 数据表 ↔ 指标/验证用例。
- 用于测试与验收阶段交叉核对，确保每项需求均有实现与验证。
