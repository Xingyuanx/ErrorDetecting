# 故障检测系统数据字典

## 1. 数据字典概述

### 1.1 文档说明
本文档详细描述了故障检测系统数据库中所有表、字段、索引、约束等数据库对象的定义和说明，为PowerDesigner建模和系统开发提供参考。

### 1.2 版本信息
- **版本**: v1.0
- **创建日期**: 2024年
- **数据库**: MySQL 8.0+
- **字符集**: utf8mb4

## 2. 表结构详细说明

### 2.1 核心业务表

#### 表名: fault_records (故障记录表)
**表说明**: 存储系统检测到的所有故障信息，是系统的核心业务表

| 序号 | 字段名 | 数据类型 | 长度 | 精度 | 是否主键 | 是否为空 | 默认值 | 字段说明 | 备注 |
|------|--------|----------|------|------|----------|----------|--------|----------|------|
| 1 | id | BIGINT | - | - | ✓ | NOT NULL | AUTO_INCREMENT | 主键ID | 自增长 |
| 2 | fault_id | VARCHAR | 32 | - | - | NOT NULL | - | 故障唯一标识 | 格式: FLT-YYYYMMDD-XXXX |
| 3 | fault_type | VARCHAR | 50 | - | - | NOT NULL | - | 故障类型 | DataNode离线/磁盘不足等 |
| 4 | fault_level | ENUM | - | - | - | NOT NULL | 'medium' | 故障级别 | low/medium/high/critical |
| 5 | title | VARCHAR | 200 | - | - | NOT NULL | - | 故障标题 | 简短描述 |
| 6 | description | TEXT | - | - | - | NULL | - | 故障详细描述 | 详细说明 |
| 7 | affected_nodes | JSON | - | - | - | NULL | - | 受影响的节点列表 | JSON数组格式 |
| 8 | source_logs | JSON | - | - | - | NULL | - | 相关日志ID列表 | 关联system_logs表 |
| 9 | root_cause | TEXT | - | - | - | NULL | - | 根本原因分析 | AI分析结果 |
| 10 | repair_suggestion | TEXT | - | - | - | NULL | - | 修复建议 | AI生成的修复建议 |
| 11 | status | ENUM | - | - | - | NOT NULL | 'detected' | 状态 | detected/analyzing/repairing/resolved/failed |
| 12 | assignee | VARCHAR | 50 | - | - | NULL | - | 负责人 | 处理人员 |
| 13 | reporter | VARCHAR | 50 | - | - | NULL | 'system' | 报告人 | 故障发现者 |
| 14 | created_at | TIMESTAMP | - | - | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 | 故障发现时间 |
| 15 | updated_at | TIMESTAMP | - | - | - | NOT NULL | CURRENT_TIMESTAMP ON UPDATE | 更新时间 | 最后修改时间 |
| 16 | resolved_at | TIMESTAMP | - | - | - | NULL | - | 解决时间 | 故障解决时间 |

**索引信息**:
- PRIMARY KEY: id
- UNIQUE KEY: uk_fault_id (fault_id)
- INDEX: idx_fault_type (fault_type)
- INDEX: idx_fault_level (fault_level)
- INDEX: idx_status (status)
- INDEX: idx_created_at (created_at)
- INDEX: idx_assignee (assignee)

#### 表名: exec_logs (执行日志表)
**表说明**: 记录自动修复脚本的执行过程和结果

| 序号 | 字段名 | 数据类型 | 长度 | 精度 | 是否主键 | 是否为空 | 默认值 | 字段说明 | 备注 |
|------|--------|----------|------|------|----------|----------|--------|----------|------|
| 1 | id | BIGINT | - | - | ✓ | NOT NULL | AUTO_INCREMENT | 主键ID | 自增长 |
| 2 | exec_id | VARCHAR | 32 | - | - | NOT NULL | - | 执行唯一标识 | 格式: EXE-YYYYMMDD-XXXX |
| 3 | fault_id | VARCHAR | 32 | - | - | NOT NULL | - | 关联故障ID | 外键关联fault_records |
| 4 | command_type | VARCHAR | 50 | - | - | NOT NULL | - | 命令类型 | restart/repair/check等 |
| 5 | script_path | VARCHAR | 255 | - | - | NULL | - | 脚本路径 | 执行脚本的文件路径 |
| 6 | command_content | TEXT | - | - | - | NOT NULL | - | 执行的命令内容 | 完整的命令或脚本内容 |
| 7 | target_nodes | JSON | - | - | - | NULL | - | 目标执行节点 | JSON数组格式 |
| 8 | risk_level | ENUM | - | - | - | NOT NULL | 'medium' | 风险级别 | low/medium/high |
| 9 | execution_status | ENUM | - | - | - | NOT NULL | 'pending' | 执行状态 | pending/running/success/failed/timeout |
| 10 | start_time | TIMESTAMP | - | - | - | NULL | - | 开始执行时间 | 命令开始执行时间 |
| 11 | end_time | TIMESTAMP | - | - | - | NULL | - | 结束执行时间 | 命令结束执行时间 |
| 12 | duration | INT | - | - | - | NULL | - | 执行时长(秒) | 计算得出的执行时长 |
| 13 | stdout_log | LONGTEXT | - | - | - | NULL | - | 标准输出日志 | 命令执行的标准输出 |
| 14 | stderr_log | LONGTEXT | - | - | - | NULL | - | 错误输出日志 | 命令执行的错误输出 |
| 15 | exit_code | INT | - | - | - | NULL | - | 退出码 | 命令执行的退出码 |
| 16 | operator | VARCHAR | 50 | - | - | NULL | 'system' | 操作人 | 执行操作的用户 |
| 17 | created_at | TIMESTAMP | - | - | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 | 记录创建时间 |
| 18 | updated_at | TIMESTAMP | - | - | - | NOT NULL | CURRENT_TIMESTAMP ON UPDATE | 更新时间 | 记录更新时间 |

**索引信息**:
- PRIMARY KEY: id
- UNIQUE KEY: uk_exec_id (exec_id)
- INDEX: idx_fault_id (fault_id)
- INDEX: idx_execution_status (execution_status)
- INDEX: idx_start_time (start_time)
- INDEX: idx_operator (operator)

**外键约束**:
- fk_exec_logs_fault_id: fault_id → fault_records.fault_id

#### 表名: cluster_status (集群状态表)
**表说明**: 记录Hadoop集群各节点的实时状态信息

| 序号 | 字段名 | 数据类型 | 长度 | 精度 | 是否主键 | 是否为空 | 默认值 | 字段说明 | 备注 |
|------|--------|----------|------|------|----------|----------|--------|----------|------|
| 1 | id | BIGINT | - | - | ✓ | NOT NULL | AUTO_INCREMENT | 主键ID | 自增长 |
| 2 | node_id | VARCHAR | 50 | - | - | NOT NULL | - | 节点标识 | 唯一标识节点 |
| 3 | node_name | VARCHAR | 100 | - | - | NOT NULL | - | 节点名称 | 节点的友好名称 |
| 4 | ip_address | VARCHAR | 15 | - | - | NOT NULL | - | IP地址 | 节点的IP地址 |
| 5 | node_role | ENUM | - | - | - | NOT NULL | - | 节点角色 | NameNode/DataNode/ResourceManager/NodeManager |
| 6 | node_status | ENUM | - | - | - | NOT NULL | 'unknown' | 节点状态 | online/offline/maintenance/unknown |
| 7 | cpu_usage | DECIMAL | 5 | 2 | - | NULL | - | CPU使用率(%) | 0.00-100.00 |
| 8 | memory_usage | DECIMAL | 5 | 2 | - | NULL | - | 内存使用率(%) | 0.00-100.00 |
| 9 | disk_usage | DECIMAL | 5 | 2 | - | NULL | - | 磁盘使用率(%) | 0.00-100.00 |
| 10 | network_io | BIGINT | - | - | - | NULL | - | 网络IO(bytes/s) | 网络吞吐量 |
| 11 | disk_io | BIGINT | - | - | - | NULL | - | 磁盘IO(bytes/s) | 磁盘吞吐量 |
| 12 | load_average | DECIMAL | 5 | 2 | - | NULL | - | 系统负载 | 系统平均负载 |
| 13 | uptime | BIGINT | - | - | - | NULL | - | 运行时间(秒) | 节点运行时长 |
| 14 | last_heartbeat | TIMESTAMP | - | - | - | NULL | - | 最后心跳时间 | 最后一次心跳时间 |
| 15 | health_score | INT | - | - | - | NULL | 100 | 健康评分(0-100) | 节点健康度评分 |
| 16 | alerts_count | INT | - | - | - | NOT NULL | 0 | 告警数量 | 当前活跃告警数 |
| 17 | created_at | TIMESTAMP | - | - | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 | 记录创建时间 |
| 18 | updated_at | TIMESTAMP | - | - | - | NOT NULL | CURRENT_TIMESTAMP ON UPDATE | 更新时间 | 记录更新时间 |

**索引信息**:
- PRIMARY KEY: id
- UNIQUE KEY: uk_node_id (node_id)
- INDEX: idx_node_role (node_role)
- INDEX: idx_node_status (node_status)
- INDEX: idx_last_heartbeat (last_heartbeat)
- INDEX: idx_health_score (health_score)

#### 表名: system_logs (系统日志表)
**表说明**: 存储从Flume采集的原始日志数据

| 序号 | 字段名 | 数据类型 | 长度 | 精度 | 是否主键 | 是否为空 | 默认值 | 字段说明 | 备注 |
|------|--------|----------|------|------|----------|----------|--------|----------|------|
| 1 | id | BIGINT | - | - | ✓ | NOT NULL | AUTO_INCREMENT | 主键ID | 自增长 |
| 2 | log_id | VARCHAR | 32 | - | - | NOT NULL | - | 日志唯一标识 | 格式: LOG-YYYYMMDD-XXXX |
| 3 | timestamp | TIMESTAMP | - | - | - | NOT NULL | - | 日志时间戳 | 日志产生的时间 |
| 4 | host | VARCHAR | 100 | - | - | NOT NULL | - | 主机名 | 产生日志的主机 |
| 5 | ip_address | VARCHAR | 15 | - | - | NOT NULL | - | IP地址 | 主机IP地址 |
| 6 | service | VARCHAR | 50 | - | - | NOT NULL | - | 服务名 | HDFS/YARN/MapReduce等 |
| 7 | component | VARCHAR | 50 | - | - | NULL | - | 组件名 | 具体的组件名称 |
| 8 | log_level | ENUM | - | - | - | NOT NULL | - | 日志级别 | DEBUG/INFO/WARN/ERROR/FATAL |
| 9 | thread | VARCHAR | 100 | - | - | NULL | - | 线程名 | 产生日志的线程 |
| 10 | logger | VARCHAR | 200 | - | - | NULL | - | Logger名称 | 日志记录器名称 |
| 11 | message | LONGTEXT | - | - | - | NOT NULL | - | 日志消息 | 日志的主要内容 |
| 12 | exception | LONGTEXT | - | - | - | NULL | - | 异常堆栈 | 异常的堆栈信息 |
| 13 | raw_log | LONGTEXT | - | - | - | NULL | - | 原始日志内容 | 未处理的原始日志 |
| 14 | tags | JSON | - | - | - | NULL | - | 标签信息 | 日志的标签和元数据 |
| 15 | processed | BOOLEAN | - | - | - | NOT NULL | FALSE | 是否已处理 | 标记是否已被分析处理 |
| 16 | created_at | TIMESTAMP | - | - | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 | 记录创建时间 |

**索引信息**:
- PRIMARY KEY: id
- UNIQUE KEY: uk_log_id (log_id)
- INDEX: idx_timestamp (timestamp)
- INDEX: idx_host (host)
- INDEX: idx_service (service)
- INDEX: idx_log_level (log_level)
- INDEX: idx_processed (processed)
- INDEX: idx_timestamp_level (timestamp, log_level) - 复合索引

### 2.2 配置管理表

#### 表名: system_configs (系统配置表)
**表说明**: 存储系统配置参数

| 序号 | 字段名 | 数据类型 | 长度 | 精度 | 是否主键 | 是否为空 | 默认值 | 字段说明 | 备注 |
|------|--------|----------|------|------|----------|----------|--------|----------|------|
| 1 | id | BIGINT | - | - | ✓ | NOT NULL | AUTO_INCREMENT | 主键ID | 自增长 |
| 2 | config_key | VARCHAR | 100 | - | - | NOT NULL | - | 配置键 | 配置项的唯一标识 |
| 3 | config_value | TEXT | - | - | - | NULL | - | 配置值 | 配置项的值 |
| 4 | config_type | VARCHAR | 20 | - | - | NOT NULL | 'string' | 配置类型 | string/int/boolean/json |
| 5 | category | VARCHAR | 50 | - | - | NOT NULL | - | 配置分类 | 配置项的分类 |
| 6 | description | VARCHAR | 500 | - | - | NULL | - | 配置描述 | 配置项的说明 |
| 7 | is_active | BOOLEAN | - | - | - | NOT NULL | TRUE | 是否启用 | 配置是否生效 |
| 8 | created_at | TIMESTAMP | - | - | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 | 记录创建时间 |
| 9 | updated_at | TIMESTAMP | - | - | - | NOT NULL | CURRENT_TIMESTAMP ON UPDATE | 更新时间 | 记录更新时间 |

**索引信息**:
- PRIMARY KEY: id
- UNIQUE KEY: uk_config_key (config_key)
- INDEX: idx_category (category)
- INDEX: idx_is_active (is_active)

#### 表名: alert_rules (告警规则表)
**表说明**: 定义各种告警规则和阈值

| 序号 | 字段名 | 数据类型 | 长度 | 精度 | 是否主键 | 是否为空 | 默认值 | 字段说明 | 备注 |
|------|--------|----------|------|------|----------|----------|--------|----------|------|
| 1 | id | BIGINT | - | - | ✓ | NOT NULL | AUTO_INCREMENT | 主键ID | 自增长 |
| 2 | rule_name | VARCHAR | 100 | - | - | NOT NULL | - | 规则名称 | 告警规则的名称 |
| 3 | rule_type | VARCHAR | 50 | - | - | NOT NULL | - | 规则类型 | threshold/pattern/anomaly |
| 4 | metric_name | VARCHAR | 100 | - | - | NOT NULL | - | 监控指标名 | 监控的指标名称 |
| 5 | condition_expr | TEXT | - | - | - | NOT NULL | - | 条件表达式 | 告警触发条件 |
| 6 | threshold_value | DECIMAL | 10 | 2 | - | NULL | - | 阈值 | 告警阈值 |
| 7 | severity | ENUM | - | - | - | NOT NULL | 'medium' | 严重级别 | low/medium/high/critical |
| 8 | description | TEXT | - | - | - | NULL | - | 规则描述 | 规则的详细说明 |
| 9 | is_enabled | BOOLEAN | - | - | - | NOT NULL | TRUE | 是否启用 | 规则是否生效 |
| 10 | created_at | TIMESTAMP | - | - | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 | 记录创建时间 |
| 11 | updated_at | TIMESTAMP | - | - | - | NOT NULL | CURRENT_TIMESTAMP ON UPDATE | 更新时间 | 记录更新时间 |

**索引信息**:
- PRIMARY KEY: id
- INDEX: idx_rule_type (rule_type)
- INDEX: idx_metric_name (metric_name)
- INDEX: idx_severity (severity)
- INDEX: idx_is_enabled (is_enabled)

### 2.3 用户管理表

#### 表名: users (用户表)
**表说明**: 系统用户信息

| 序号 | 字段名 | 数据类型 | 长度 | 精度 | 是否主键 | 是否为空 | 默认值 | 字段说明 | 备注 |
|------|--------|----------|------|------|----------|----------|--------|----------|------|
| 1 | id | BIGINT | - | - | ✓ | NOT NULL | AUTO_INCREMENT | 主键ID | 自增长 |
| 2 | username | VARCHAR | 50 | - | - | NOT NULL | - | 用户名 | 登录用户名 |
| 3 | email | VARCHAR | 100 | - | - | NOT NULL | - | 邮箱 | 用户邮箱地址 |
| 4 | password_hash | VARCHAR | 255 | - | - | NOT NULL | - | 密码哈希 | 加密后的密码 |
| 5 | full_name | VARCHAR | 100 | - | - | NOT NULL | - | 姓名 | 用户真实姓名 |
| 6 | role | ENUM | - | - | - | NOT NULL | 'operator' | 角色 | admin/operator/viewer |
| 7 | department | VARCHAR | 100 | - | - | NULL | - | 部门 | 用户所属部门 |
| 8 | phone | VARCHAR | 20 | - | - | NULL | - | 电话 | 联系电话 |
| 9 | is_active | BOOLEAN | - | - | - | NOT NULL | TRUE | 是否激活 | 账号是否可用 |
| 10 | last_login | TIMESTAMP | - | - | - | NULL | - | 最后登录时间 | 最后一次登录时间 |
| 11 | created_at | TIMESTAMP | - | - | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 | 账号创建时间 |
| 12 | updated_at | TIMESTAMP | - | - | - | NOT NULL | CURRENT_TIMESTAMP ON UPDATE | 更新时间 | 账号更新时间 |

**索引信息**:
- PRIMARY KEY: id
- UNIQUE KEY: uk_username (username)
- UNIQUE KEY: uk_email (email)
- INDEX: idx_role (role)
- INDEX: idx_is_active (is_active)

#### 表名: audit_logs (操作审计表)
**表说明**: 记录用户操作审计日志

| 序号 | 字段名 | 数据类型 | 长度 | 精度 | 是否主键 | 是否为空 | 默认值 | 字段说明 | 备注 |
|------|--------|----------|------|------|----------|----------|--------|----------|------|
| 1 | id | BIGINT | - | - | ✓ | NOT NULL | AUTO_INCREMENT | 主键ID | 自增长 |
| 2 | user_id | BIGINT | - | - | - | NULL | - | 用户ID | 关联users表 |
| 3 | username | VARCHAR | 50 | - | - | NOT NULL | - | 用户名 | 操作用户名 |
| 4 | action | VARCHAR | 100 | - | - | NOT NULL | - | 操作动作 | 具体的操作类型 |
| 5 | resource_type | VARCHAR | 50 | - | - | NOT NULL | - | 资源类型 | 操作的资源类型 |
| 6 | resource_id | VARCHAR | 100 | - | - | NULL | - | 资源ID | 操作的资源标识 |
| 7 | ip_address | VARCHAR | 15 | - | - | NOT NULL | - | IP地址 | 操作来源IP |
| 8 | user_agent | TEXT | - | - | - | NULL | - | 用户代理 | 浏览器信息 |
| 9 | request_data | JSON | - | - | - | NULL | - | 请求数据 | 请求的详细数据 |
| 10 | response_status | INT | - | - | - | NULL | - | 响应状态码 | HTTP响应状态 |
| 11 | created_at | TIMESTAMP | - | - | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 | 操作发生时间 |

**索引信息**:
- PRIMARY KEY: id
- INDEX: idx_user_id (user_id)
- INDEX: idx_username (username)
- INDEX: idx_action (action)
- INDEX: idx_created_at (created_at)

**外键约束**:
- fk_audit_logs_user_id: user_id → users.id

## 3. 枚举值定义

### 3.1 故障级别 (fault_level)
- `low`: 低级别故障，影响较小
- `medium`: 中等级别故障，需要关注
- `high`: 高级别故障，需要及时处理
- `critical`: 严重故障，需要立即处理

### 3.2 故障状态 (status)
- `detected`: 已检测到，等待分析
- `analyzing`: 正在分析中
- `repairing`: 正在修复中
- `resolved`: 已解决
- `failed`: 修复失败

### 3.3 节点角色 (node_role)
- `NameNode`: Hadoop NameNode节点
- `DataNode`: Hadoop DataNode节点
- `ResourceManager`: YARN ResourceManager节点
- `NodeManager`: YARN NodeManager节点

### 3.4 节点状态 (node_status)
- `online`: 在线正常
- `offline`: 离线
- `maintenance`: 维护中
- `unknown`: 状态未知

### 3.5 日志级别 (log_level)
- `DEBUG`: 调试信息
- `INFO`: 一般信息
- `WARN`: 警告信息
- `ERROR`: 错误信息
- `FATAL`: 致命错误

### 3.6 执行状态 (execution_status)
- `pending`: 等待执行
- `running`: 正在执行
- `success`: 执行成功
- `failed`: 执行失败
- `timeout`: 执行超时

### 3.7 用户角色 (role)
- `admin`: 系统管理员，拥有所有权限
- `operator`: 运维工程师，可以执行修复操作
- `viewer`: 查看者，只能查看信息

## 4. JSON字段结构说明

### 4.1 affected_nodes (受影响节点)
```json
[
  {
    "node_id": "node-001",
    "node_name": "hadoop-master",
    "impact_level": "high"
  }
]
```

### 4.2 source_logs (相关日志)
```json
[
  {
    "log_id": "LOG-20241201-0001",
    "relevance_score": 0.95
  }
]
```

### 4.3 target_nodes (目标节点)
```json
[
  {
    "node_id": "node-001",
    "node_name": "hadoop-master",
    "execution_order": 1
  }
]
```

### 4.4 tags (日志标签)
```json
{
  "environment": "production",
  "cluster": "hadoop-cluster-01",
  "severity": "high",
  "category": "system"
}
```

## 5. 视图定义

### 5.1 v_fault_statistics (故障统计视图)
提供故障的统计信息，包括按日期、级别、类型的分组统计。

### 5.2 v_cluster_health (集群健康度视图)
提供集群各角色节点的健康状况汇总。

### 5.3 v_execution_success_rate (执行成功率视图)
提供修复执行的成功率统计。

## 6. 存储过程

### 6.1 sp_create_fault_record
创建故障记录的存储过程，自动生成故障ID。

### 6.2 sp_update_cluster_status
更新集群状态的存储过程，支持插入或更新操作。

## 7. 触发器

### 7.1 tr_fault_status_change
故障状态变更触发器，自动记录解决时间和审计日志。

## 8. 数据完整性约束

### 8.1 主键约束
所有表都有自增长的主键ID。

### 8.2 唯一性约束
- fault_records.fault_id
- exec_logs.exec_id
- cluster_status.node_id
- system_logs.log_id
- system_configs.config_key
- users.username
- users.email

### 8.3 外键约束
- exec_logs.fault_id → fault_records.fault_id
- audit_logs.user_id → users.id

### 8.4 检查约束
- health_score: 0 <= health_score <= 100
- cpu_usage: 0.00 <= cpu_usage <= 100.00
- memory_usage: 0.00 <= memory_usage <= 100.00
- disk_usage: 0.00 <= disk_usage <= 100.00

## 9. PowerDesigner建模建议

### 9.1 物理数据模型(PDM)
1. 导入SQL脚本创建基础结构
2. 设置表和字段的注释
3. 配置索引和约束
4. 生成数据库文档

### 9.2 概念数据模型(CDM)
1. 定义实体和属性
2. 建立实体间关系
3. 设置业务规则
4. 生成概念模型图

### 9.3 逻辑数据模型(LDM)
1. 从CDM生成LDM
2. 优化表结构设计
3. 设置数据类型和约束
4. 验证模型完整性

## 10. 维护建议

### 10.1 定期维护
- 每周分析表统计信息
- 每月检查索引使用情况
- 每季度进行表空间整理

### 10.2 性能监控
- 监控慢查询日志
- 跟踪表增长趋势
- 优化高频查询索引

### 10.3 数据归档
- system_logs表按月分区
- 历史数据定期归档
- 保持表大小合理