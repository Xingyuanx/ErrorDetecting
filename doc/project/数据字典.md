# 故障检测系统数据字典

## 1. 数据字典概述

### 1.1 文档说明
本文档详细描述了故障检测系统数据库中所有表、字段、索引、约束等数据库对象的定义和说明，为PowerDesigner建模和系统开发提供参考。

### 1.2 版本信息
- **版本**: v1.2
- **创建日期**: 2025年
- **数据库**: PostgreSQL 14+
- **字符集**: UTF8

## 2. 表结构详细说明

#### 表名: roles (角色表)
**表说明**: 系统角色定义

| 序号 | 字段名 | 数据类型 | 长度 | 精度 | 是否主键 | 是否为空 | 默认值 | 字段说明 | 备注 |
|---|---|---|---|---|---|---|---|---|---|
| 1 | id | BIGINT | - | - | ✓ | NOT NULL | - | 主键ID | |
| 2 | role_name | CHARACTER | - | - | - | NOT NULL | - | 角色名称 | |
| 3 | role_key | CHARACTER | - | - | - | NOT NULL | - | 角色唯一标识 | |
| 4 | description | CHARACTER | - | - | - | NULL | - | 角色描述 | |
| 5 | is_system_role | BOOLEAN | - | - | - | NOT NULL | false | 是否为系统内置角色 | |
| 6 | created_at | TIMESTAMP | - | - | - | NOT NULL | now() | 创建时间 | |
| 7 | updated_at | TIMESTAMP | - | - | - | NOT NULL | now() | 更新时间 | |

**索引信息**:
- PRIMARY KEY: (id)
#### 表名: permissions (权限表)
**表说明**: 系统权限定义

| 序号 | 字段名 | 数据类型 | 长度 | 精度 | 是否主键 | 是否为空 | 默认值 | 字段说明 | 备注 |
|---|---|---|---|---|---|---|---|---|---|
| 1 | id | BIGINT | - | - | ✓ | NOT NULL | - | 主键ID | |
| 2 | permission_name | CHARACTER | - | - | - | NOT NULL | - | 权限名称 | |
| 3 | permission_key | CHARACTER | - | - | - | NOT NULL | - | 权限唯一标识 | |
| 4 | description | CHARACTER | - | - | - | NULL | - | 权限描述 | |
| 5 | created_at | TIMESTAMP | - | - | - | NOT NULL | now() | 创建时间 | |

**索引信息**:
- PRIMARY KEY: (id)
#### 表名: role_permission_mapping (角色-权限映射表)
**表说明**: 角色与权限的多对多关系

| 序号 | 字段名 | 数据类型 | 长度 | 精度 | 是否主键 | 是否为空 | 默认值 | 字段说明 | 备注 |
|---|---|---|---|---|---|---|---|---|---|
| 1 | role_id | BIGINT | - | - | ✓ | NOT NULL | - | 角色ID | |
| 2 | permission_id | BIGINT | - | - | ✓ | NOT NULL | - | 权限ID | |

**索引信息**:
- PRIMARY KEY: (role_id, permission_id)
- FOREIGN KEY: FK(permission_id) -> public.permissions(id)
- FOREIGN KEY: FK(role_id) -> public.roles(id)
#### 表名: user_role_mapping (用户-角色映射表)
**表说明**: 用户与角色的多对多关系

| 序号 | 字段名 | 数据类型 | 长度 | 精度 | 是否主键 | 是否为空 | 默认值 | 字段说明 | 备注 |
|---|---|---|---|---|---|---|---|---|---|
| 1 | user_id | BIGINT | - | - | ✓ | NOT NULL | - | 用户ID | |
| 2 | role_id | BIGINT | - | - | ✓ | NOT NULL | - | 角色ID | |

**索引信息**:
- PRIMARY KEY: (user_id, role_id)
- FOREIGN KEY: FK(role_id) -> public.roles(id)
- FOREIGN KEY: FK(user_id) -> public.users(id)
#### 表名: fault_records (故障记录表)
**表说明**: 存储系统检测到的所有故障信息，是系统的核心业务表

| 序号 | 字段名 | 数据类型 | 长度 | 精度 | 是否主键 | 是否为空 | 默认值 | 字段说明 | 备注 |
|---|---|---|---|---|---|---|---|---|---|
| 1 | id | BIGINT | - | - | ✓ | NOT NULL | IDENTITY | 主键ID | |
| 2 | fault_id | VARCHAR | 32 | - | - | NOT NULL | - | 故障唯一标识 | 格式: FLT-YYYYMMDD-XXXX |
| 3 | cluster_id | BIGINT | - | - | - | NULL | - | 关联集群ID | 外键关联clusters表 |
| 4 | fault_type | VARCHAR | 50 | - | - | NOT NULL | - | 故障类型 | DataNode离线/磁盘不足等 |
| 5 | fault_level | VARCHAR | 20 | - | - | NOT NULL | 'medium' | 故障级别 | low/medium/high/critical |
| 6 | title | VARCHAR | 200 | - | - | NOT NULL | - | 故障标题 | 简短描述 |
| 7 | description | TEXT | - | - | - | NULL | - | 故障详细描述 | 详细说明 |
| 8 | affected_nodes | JSONB | - | - | - | NULL | - | 受影响的节点列表 | JSONB数组 |
| 9 | affected_clusters | JSONB | - | - | - | NULL | - | 受影响的集群列表 | JSONB数组 |
| 10 | root_cause | TEXT | - | - | - | NULL | - | 根本原因分析 | AI分析结果 |
| 11 | repair_suggestion | TEXT | - | - | - | NULL | - | 修复建议 | AI生成的修复建议 |
| 12 | status | VARCHAR | 20 | - | - | - | NOT NULL | 'detected' | 状态 | detected/analyzing/repairing/resolved/failed |
| 12 | assignee | VARCHAR | 50 | - | - | NULL | - | 负责人 | 处理人员 |
| 13 | reporter | VARCHAR | 50 | - | - | NULL | 'system' | 报告人 | 故障发现者 |
| 15 | created_at | TIMESTAMPTZ | - | - | - | NOT NULL | NOW() | 创建时间 | 故障发现时间 |
| 16 | updated_at | TIMESTAMPTZ | - | - | - | NOT NULL | NOW() | 更新时间 | 最后修改时间 |
| 17 | resolved_at | TIMESTAMPTZ | - | - | - | NULL | - | 解决时间 | 故障解决时间 |

**索引信息**:
- PRIMARY KEY: id
- UNIQUE KEY: uk_fault_id (fault_id)
- INDEX: idx_fault_records_type (fault_type)
- INDEX: idx_fault_records_status (status)
- INDEX: idx_fault_records_created_at (created_at)

**外键约束**:
- fk_fault_records_cluster_id: cluster_id → clusters.id

#### 表名: exec_logs (执行日志表)
**表说明**: 记录自动修复脚本的执行过程和结果

| 序号 | 字段名 | 数据类型 | 长度 | 精度 | 是否主键 | 是否为空 | 默认值 | 字段说明 | 备注 |
|---|---|---|---|---|---|---|---|---|---|
| 1 | id | BIGINT | - | - | ✓ | NOT NULL | - | 主键ID | |
| 2 | exec_id | CHARACTER | - | - | - | NOT NULL | - | 执行唯一标识 | |
| 3 | fault_id | CHARACTER | - | - | - | NOT NULL | - | 关联故障标识(无外键) | |
| 4 | command_type | CHARACTER | - | - | - | NOT NULL | - | 命令类型 | |
| 5 | script_path | CHARACTER | - | - | - | NULL | - | 脚本路径 | |
| 6 | command_content | TEXT | - | - | - | NOT NULL | - | 执行的命令内容 | |
| 7 | target_nodes | JSONB | - | - | - | NULL | - | 目标执行节点(JSONB) | |
| 8 | risk_level | CHARACTER | - | - | - | NOT NULL | 'medium'::character | 风险级别(low/medium/high) | |
| 9 | execution_status | CHARACTER | - | - | - | NOT NULL | 'pending'::character | 执行状态(pending/running/success/failed/timeout) | |
| 10 | start_time | TIMESTAMP | - | - | - | NULL | - | 开始执行时间 | |
| 11 | end_time | TIMESTAMP | - | - | - | NULL | - | 结束执行时间 | |
| 12 | duration | INTEGER | - | - | - | NULL | - | 执行时长(秒) | |
| 13 | stdout_log | TEXT | - | - | - | NULL | - | 标准输出日志 | |
| 14 | stderr_log | TEXT | - | - | - | NULL | - | 错误输出日志 | |
| 15 | exit_code | INTEGER | - | - | - | NULL | - | 退出码 | |
| 16 | operator | CHARACTER | - | - | - | NOT NULL | 'system'::character | 操作人 | |
| 17 | created_at | TIMESTAMP | - | - | - | NOT NULL | now() | 创建时间 | |
| 18 | updated_at | TIMESTAMP | - | - | - | NOT NULL | now() | 更新时间 | |

**索引信息**:
- PRIMARY KEY: (id)
- INDEX: idx_exec_logs_end_time (end_time)
- INDEX: idx_exec_logs_fault_id (fault_id)
- INDEX: idx_exec_logs_start_time (start_time)
- INDEX: idx_exec_logs_status (execution_status)
#### 表名: nodes (节点信息表)
**表说明**: 记录集群内各节点的状态信息

| 序号 | 字段名 | 数据类型 | 长度 | 精度 | 是否主键 | 是否为空 | 默认值 | 字段说明 | 备注 |
|---|---|---|---|---|---|---|---|---|---|
| 1 | id | BIGINT | - | - | ✓ | NOT NULL | - | 主键ID | |
| 2 | uuid | UUID | - | - | - | NOT NULL | - | 节点唯一标识(UUID) | |
| 3 | cluster_id | BIGINT | - | - | - | NOT NULL | - | 所属集群ID | |
| 4 | hostname | CHARACTER | - | - | - | NOT NULL | - | 节点主机名 | |
| 5 | ip_address | INET | - | - | - | NOT NULL | - | 节点IP地址(INET, 兼容IPv4/IPv6) | |
| 6 | status | CHARACTER | - | - | - | NOT NULL | 'unknown'::character | 节点健康状态(healthy/unhealthy/warning/unknown) | |
| 7 | last_heartbeat | TIMESTAMP | - | - | - | NULL | - | 最后心跳时间 | |
| 8 | created_at | TIMESTAMP | - | - | - | NOT NULL | now() | 创建时间 | |
| 9 | updated_at | TIMESTAMP | - | - | - | NOT NULL | now() | 更新时间 | |
| 10 | ssh_user | CHARACTER | - | - | - | NULL | - |  | |
| 11 | ssh_password | CHARACTER | - | - | - | NULL | - |  | |

**索引信息**:
- PRIMARY KEY: (id)
- INDEX: idx_nodes_cluster_id (cluster_id)
- INDEX: idx_nodes_ip_address (ip_address)
- INDEX: idx_nodes_last_heartbeat (last_heartbeat)
- INDEX: idx_nodes_status (status)
- INDEX: uk_cluster_hostname (cluster_id, hostname)
- FOREIGN KEY: FK(cluster_id) -> public.clusters(id)
#### 表名: system_logs (系统日志表)
**表说明**: 存储从Flume采集的原始日志数据

| 序号 | 字段名 | 数据类型 | 长度 | 精度 | 是否主键 | 是否为空 | 默认值 | 字段说明 | 备注 |
|---|---|---|---|---|---|---|---|---|---|
| 1 | id | BIGINT | - | - | ✓ | NOT NULL | - | 主键ID | |
| 2 | log_id | CHARACTER | - | - | - | NOT NULL | - | 日志唯一标识 | |
| 3 | fault_id | CHARACTER | - | - | - | NULL | - | 关联故障标识(无外键) | |
| 4 | cluster_id | BIGINT | - | - | - | NULL | - | 关联集群ID | |
| 5 | host | CHARACTER | - | - | - | NOT NULL | - | 主机名 | |
| 6 | service | CHARACTER | - | - | - | NOT NULL | - | 服务名 | |
| 7 | source | CHARACTER | - | - | - | NULL | - | 来源 | |
| 8 | log_level | CHARACTER | - | - | - | NOT NULL | - | 日志级别(DEBUG/INFO/WARN/ERROR/FATAL) | |
| 9 | message | TEXT | - | - | - | NOT NULL | - | 日志消息 | |
| 10 | exception | TEXT | - | - | - | NULL | - | 异常堆栈 | |
| 11 | raw_log | TEXT | - | - | - | NULL | - | 原始日志内容 | |
| 12 | processed | BOOLEAN | - | - | - | NOT NULL | false | 是否已处理 | |
| 13 | created_at | TIMESTAMP | - | - | - | NOT NULL | now() | 创建时间 | |

**索引信息**:
- PRIMARY KEY: (id)
- INDEX: idx_system_logs_cluster_id (cluster_id)
- INDEX: idx_system_logs_fault_id (fault_id)
- INDEX: idx_system_logs_level (log_level)
- INDEX: idx_system_logs_processed (processed)
- INDEX: idx_system_logs_timestamp ("timestamp")
- FOREIGN KEY: FK(cluster_id) -> public.clusters(id)
#### 表名: clusters (集群信息表)
**表说明**: 存储用户管理的集群信息

| 序号 | 字段名 | 数据类型 | 长度 | 精度 | 是否主键 | 是否为空 | 默认值 | 字段说明 | 备注 |
|---|---|---|---|---|---|---|---|---|---|
| 1 | id | BIGINT | - | - | ✓ | NOT NULL | - | 主键ID | |
| 2 | uuid | UUID | - | - | - | NOT NULL | - | 集群唯一标识(UUID) | |
| 3 | name | CHARACTER | - | - | - | NOT NULL | - | 集群名称 | |
| 4 | type | CHARACTER | - | - | - | NOT NULL | - | 集群类型 | |
| 5 | node_count | INTEGER | - | - | - | NOT NULL | 0 | 集群节点数量 | |
| 6 | health_status | CHARACTER | - | - | - | NOT NULL | 'unknown'::character | 集群健康状态(healthy/warning/error/unknown) | |
| 7 | description | TEXT | - | - | - | NULL | - | 集群描述 | |
| 8 | config_info | JSONB | - | - | - | NULL | - | 集群配置信息(JSONB) | |
| 9 | created_at | TIMESTAMP | - | - | - | NOT NULL | now() | 创建时间 | |
| 10 | updated_at | TIMESTAMP | - | - | - | NOT NULL | now() | 更新时间 | |
| 11 | namenode_ip | INET | - | - | - | NULL | - |  | |
| 12 | namenode_psw | CHARACTER | - | - | - | NULL | - |  | |
| 13 | rm_ip | INET | - | - | - | NULL | - |  | |
| 14 | rm_psw | CHARACTER | - | - | - | NULL | - |  | |

**索引信息**:
- PRIMARY KEY: (id)
#### 表名: user_cluster_mapping (用户与集群映射表)
**表说明**: 管理用户和集群的多对多关系

| 序号 | 字段名 | 数据类型 | 长度 | 精度 | 是否主键 | 是否为空 | 默认值 | 字段说明 | 备注 |
|---|---|---|---|---|---|---|---|---|---|
| 1 | id | BIGINT | - | - | ✓ | NOT NULL | - | 主键ID | |
| 2 | user_id | BIGINT | - | - | - | NOT NULL | - | 用户ID | |
| 3 | cluster_id | BIGINT | - | - | - | NOT NULL | - | 集群ID | |
| 4 | role_id | BIGINT | - | - | - | NOT NULL | - | 角色ID | |
| 5 | created_at | TIMESTAMP | - | - | - | NOT NULL | now() | 创建时间 | |

**索引信息**:
- PRIMARY KEY: (id)
- FOREIGN KEY: FK(cluster_id) -> public.clusters(id)
- FOREIGN KEY: FK(role_id) -> public.roles(id)
- FOREIGN KEY: FK(user_id) -> public.users(id)
#### 表名: app_configurations (应用配置表)
**表说明**: 存储系统各类配置信息，包括系统参数、告警规则和通知设置

| 序号 | 字段名 | 数据类型 | 长度 | 精度 | 是否主键 | 是否为空 | 默认值 | 字段说明 | 备注 |
|---|---|---|---|---|---|---|---|---|---|
| 1 | id | BIGINT | - | - | ✓ | NOT NULL | - | 主键ID | |
| 2 | config_type | CHARACTER | - | - | - | NOT NULL | - | 配置类型(system/alert_rule/notification/llm) | |
| 3 | config_key | CHARACTER | - | - | - | NOT NULL | - | 配置键 | |
| 4 | config_value | JSONB | - | - | - | NOT NULL | - | 配置值(JSONB) | |
| 5 | description | CHARACTER | - | - | - | NULL | - | 配置描述 | |
| 6 | is_enabled | BOOLEAN | - | - | - | NOT NULL | true | 是否启用 | |
| 7 | created_at | TIMESTAMP | - | - | - | NOT NULL | now() | 创建时间 | |
| 8 | updated_at | TIMESTAMP | - | - | - | NOT NULL | now() | 更新时间 | |

**索引信息**:
- PRIMARY KEY: (id)
- INDEX: idx_app_config_enabled (is_enabled)
#### 表名: users (用户表)
**表说明**: 系统用户信息

| 序号 | 字段名 | 数据类型 | 长度 | 精度 | 是否主键 | 是否为空 | 默认值 | 字段说明 | 备注 |
|---|---|---|---|---|---|---|---|---|---|
| 1 | id | BIGINT | - | - | ✓ | NOT NULL | - | 主键ID | |
| 2 | username | CHARACTER | - | - | - | NOT NULL | - | 用户名 | |
| 3 | email | CHARACTER | - | - | - | NOT NULL | - | 邮箱 | |
| 4 | password_hash | CHARACTER | - | - | - | NOT NULL | - | 密码哈希 | |
| 5 | full_name | CHARACTER | - | - | - | NOT NULL | - | 姓名 | |
| 6 | is_active | BOOLEAN | - | - | - | NOT NULL | true | 是否激活 | |
| 7 | last_login | TIMESTAMP | - | - | - | NULL | - | 最后登录时间 | |
| 8 | created_at | TIMESTAMP | - | - | - | NOT NULL | now() | 创建时间 | |
| 9 | updated_at | TIMESTAMP | - | - | - | NOT NULL | now() | 更新时间 | |

**索引信息**:
- PRIMARY KEY: (id)
#### 表名: audit_logs (操作审计表)
**表说明**: 记录用户操作审计日志

| 序号 | 字段名 | 数据类型 | 长度 | 精度 | 是否主键 | 是否为空 | 默认值 | 字段说明 | 备注 |
|---|---|---|---|---|---|---|---|---|---|
| 1 | id | BIGINT | - | - | ✓ | NOT NULL | - | 主键ID | |
| 2 | user_id | BIGINT | - | - | - | NULL | - | 用户ID | |
| 3 | cluster_id | BIGINT | - | - | - | NULL | - | 集群ID | |
| 4 | role_id | BIGINT | - | - | - | NULL | - | 角色ID | |
| 5 | username | CHARACTER | - | - | - | NOT NULL | - | 用户名 | |
| 6 | action | CHARACTER | - | - | - | NOT NULL | - | 操作动作 | |
| 7 | resource_type | CHARACTER | - | - | - | NOT NULL | - | 资源类型 | |
| 8 | resource_id | CHARACTER | - | - | - | NULL | - | 资源ID | |
| 9 | ip_address | INET | - | - | - | NOT NULL | - | 请求来源IP(INET, 兼容IPv4/IPv6) | |
| 10 | request_data | JSONB | - | - | - | NULL | - | 请求数据(JSONB) | |
| 11 | response_status | INTEGER | - | - | - | NULL | - | 响应状态码 | |
| 12 | created_at | TIMESTAMP | - | - | - | NOT NULL | now() | 创建时间 | |

**索引信息**:
- PRIMARY KEY: (id)
- INDEX: idx_audit_logs_action (action)
- INDEX: idx_audit_logs_cluster_id (cluster_id)
- INDEX: idx_audit_logs_created_at (created_at)
- INDEX: idx_audit_logs_role_id (role_id)
- INDEX: idx_audit_logs_user_id (user_id)
- FOREIGN KEY: FK(cluster_id) -> public.clusters(id)
- FOREIGN KEY: FK(role_id) -> public.roles(id)
- FOREIGN KEY: FK(user_id) -> public.users(id)
#### 表名: repair_templates (修复模板表)
**表说明**: 存储常见故障的修复模板

| 序号 | 字段名 | 数据类型 | 长度 | 精度 | 是否主键 | 是否为空 | 默认值 | 字段说明 | 备注 |
|---|---|---|---|---|---|---|---|---|---|
| 1 | id | BIGINT | - | - | ✓ | NOT NULL | - | 主键ID | |
| 2 | template_name | CHARACTER | - | - | - | NOT NULL | - | 模板名称 | |
| 3 | fault_type | CHARACTER | - | - | - | NOT NULL | - | 适用故障类型 | |
| 4 | script_content | TEXT | - | - | - | NOT NULL | - | 脚本内容 | |
| 5 | risk_level | CHARACTER | - | - | - | NOT NULL | 'medium'::character | 风险级别(low/medium/high) | |
| 6 | description | TEXT | - | - | - | NULL | - | 模板描述 | |
| 7 | parameters | JSONB | - | - | - | NULL | - | 模板参数定义(JSONB) | |
| 8 | created_by | CHARACTER | - | - | - | NULL | - | 创建人 | |
| 9 | created_at | TIMESTAMP | - | - | - | NOT NULL | now() | 创建时间 | |
| 10 | updated_at | TIMESTAMP | - | - | - | NOT NULL | now() | 更新时间 | |

**索引信息**:
- PRIMARY KEY: (id)
- INDEX: idx_repair_templates_fault_type (fault_type)
