# 前后端启动前交流确认清单

> 技术栈对齐：FastAPI + SQLAlchemy + asyncpg | PostgreSQL 14+（JSONB/UUID/INET/TIMESTAMPTZ）| Redis | Vue3/Vite/Element Plus/ECharts | WebSocket | Flume | Prometheus/Grafana | 多智能体（LangGraph/Ray）

## 统一规范摘要
- Base Path：`/api/v1`；`Content-Type: application/json`；认证：`Authorization: Bearer <token>`
- 错误包络：`{ "code": <int>, "message": "<string>", "detail": { ... }, "traceId": "<uuid>" }`
- 分页参数：`page`、`pageSize`；返回统一：`{ "total": <int>, "list": [...] }`
- 时间：ISO8601 UTC（TIMESTAMPTZ）；IP：`INET`；JSON字段统一 `JSONB`
- WebSocket：`/ws/status`、`/ws/diagnose`，包含心跳与重连策略（指数退避，最大间隔 30s）

### 规范对照表
| 项目 | 约定 | 示例 |
|---|---|---|
| Base Path | `/api/v1` | `/api/v1/faults` |
| 错误包络 | `{ code, message, detail, traceId }` | `code=400` |
| 分页参数 | `page`, `pageSize` | `page=1&pageSize=20` |
| 时间 | ISO8601 UTC（TIMESTAMPTZ） | `2025-11-07T10:30:15Z` |
| 数据类型 | JSONB / INET / TIMESTAMPTZ | 数据库字段类型 |
| WebSocket | `/ws/status`, `/ws/diagnose` | 心跳 30s |

## 示例约定
- 请求示例（故障列表）：
```http
GET /api/v1/faults?status=detected&page=1&pageSize=20 HTTP/1.1
Authorization: Bearer <token>
Accept: application/json
```

- 响应示例：
```json
{
  "code": 200,
  "message": "OK",
  "detail": null,
  "traceId": "e7b0f2f2-1c1a-4c4e-bb2e-0e9f4ab11234",
  "data": {
    "total": 2,
    "list": [
      {
        "faultId": "FLT-20251107-0001",
        "faultType": "DataNode 离线",
        "faultLevel": "high",
        "status": "analyzing",
        "title": "DataNode 心跳丢失",
        "cluster": "CL-3333-CCCC",
        "node": "CL-3333-CCCC-003",
        "createdAt": "2025-11-07T10:15:00Z"
      },
      {
        "faultId": "FLT-20251106-0023",
        "faultType": "磁盘空间不足",
        "faultLevel": "medium",
        "status": "detected",
        "title": "节点磁盘使用率过高",
        "cluster": "CL-2222-BBBB",
        "node": "CL-2222-BBBB-002",
        "createdAt": "2025-11-06T18:42:17Z"
      }
    ]
  }
}
```

- WebSocket 消息示例：
```json
{
  "type": "status_update",
  "cluster": "CL-1111-AAAA",
  "nodes": [
    { "hostname": "CL-1111-AAAA-001", "status": "running", "cpu": 45.0, "mem": 0.26 },
    { "hostname": "CL-1111-AAAA-002", "status": "warning", "cpu": 82.0, "mem": 0.80 }
  ],
  "ts": "2025-11-07T10:30:15Z"
}
```

## 前端约定
- Axios 拦截器：统一注入 `Authorization`，处理 `401/403` 跳转；请求/响应日志采样（调试环境）
- ECharts：大数据量下懒加载与降采样；图表区域需具备无障碍 `aria-label`
- WebSocket：断线重连，心跳 30s；消息按 `type` 分发；前端状态机避免竞态
- 角色/权限：菜单与按钮按角色隐藏（管理员/操作员/观察员）；后端强校验

## 后端约定
- FastAPI：接口遵循 RESTful，统一前缀 `/api/v1`；OpenAPI/Swagger 实时同步
- PostgreSQL：时间 `TIMESTAMPTZ`、IP `INET`、结构化数据 `JSONB`；事务与审计完整
- 多智能体：Diagnosis/Repair/Policy/LogParser 由 Orchestrator 编排；高风险需审批
- 可观测性：Prometheus 指标（接口耗时、错误率、WS在线率），Grafana 展示

## 模块对齐总览（依据需求规格说明书）
| 模块 | 前端页面ID | 核心接口 | 数据表 | WebSocket |
|---|---|---|---|---|
| 集群列表/注册 | `#cluster-list` | `/api/v1/clusters` | `clusters` | - |
| 仪表板监控 | `#dashboard` | `/api/v1/cluster/status` | `nodes` | `/ws/status` |
| 日志查询 | `#logs` | `/api/v1/logs` | `system_logs` | - |
| 故障诊断（智能体） | `#diagnosis` | `/api/v1/llm/diagnose`, `/api/v1/llm/report` | `fault_records`, `exec_logs` | `/ws/diagnose` |
| 故障中心（CRUD） | `#fault-center` | `/api/v1/faults/*` | `fault_records` | - |
| 执行日志（CRUD） | `#exec-logs` | `/api/v1/exec-logs/*` | `exec_logs` | - |
| 告警配置 | `#alert-config` | `/api/v1/alerts/*` | `app_configurations` | - |
| 用户管理/角色分配 | `#user-management/#role-assignment` | `/api/v1/admin/*` | `users`, `roles`, `user_role_mapping` | - |
| 权限策略 | `#permission-policy` | `/api/v1/policies/*` | `permissions`, `role_permission_mapping` | - |
| 审计日志 | `#audit-logs` | `/api/v1/audit-logs/*` | `audit_logs` | - |

## 状态机与审批（与SRS一致）
- 故障状态：`detected → analyzing → repairing → {resolved | failed}`；高风险修复需审批（PolicyAgent 把关）
- 执行状态：`pending → running → {success | failed | timeout}`；记录 `duration` 与 `exitCode`

## 智能体诊断与修复接口约定
- 诊断接口：`POST /api/v1/llm/diagnose`
  - 入参：结构化日志片段（JSON），可包含上下文节点/集群标识
  - 出参：`{ faultType, reason, repairSuggestion, riskLevel }`
- 状态报告：`POST /api/v1/llm/report`
  - 入参：故障ID与必要上下文；
  - 出参：Markdown/文本报告（含诊断摘要与建议）
- 风险控制：`riskLevel ∈ {low, medium, high}`；`high` 需审批与告警联动

## 日志采集与处理约定
- 采集链路：Flume → `POST /api/v1/log/auto-upload`（JSON）
- 结构化处理：后端 `preprocess_log` 提取 `timestamp(TIMESTAMPTZ)`、`log_level(VARCHAR)`、`service`、`message(TEXT)` 等
- 存储规范：`system_logs` 统一 `JSONB` 扩展字段、`INET` IP、`TIMESTAMPTZ` 时间，索引覆盖 `fault_id/timestamp/log_level/processed`

## 性能与监控基线
- 性能：核心查询 P95 ≤ 500ms；WS 平均延迟 ≤ 500ms；后端并发 ≥ 1k 连接稳定
- 监控：暴露 Prometheus 指标（接口耗时、错误率、WS 在线率、队列长度），Grafana 看板分模块展示

## 联调优先级与里程碑（与项目前景文档一致）
- M1 环境与链路：`/api/v1/cluster/status`、`/api/v1/log/auto-upload`、WS `/ws/status`
- M2 核心CRUD：`/api/v1/faults/*`、`/api/v1/exec-logs/*`、`/api/v1/logs`
- M3 智能体闭环：`/api/v1/llm/diagnose`、`/api/v1/llm/report`、Policy 审批策略对接
- M4 配置与监控：`/api/v1/alerts/*`、`/api/v1/audit-logs/*`、Prometheus/Grafana 联动

## 错误码对照表
| code | HTTP | 说明 |
|---|---|---|
| 200 | 200 | 成功 |
| 401 | 401 | 未认证（Token 失效或缺失）|
| 403 | 403 | 无权限 |
| 429 | 429 | 频率限制（配合 `Retry-After`）|
| 500 | 500 | 服务器内部错误 |
| 10001 | 401 | 业务未登录（需跳转登录）|
| 10003 | 403 | 业务无权限（前端展示无权限页面）|

---

### 一、数据交互规则（核心中的核心）

1. **接口设计规范**

- 统一接口风格：RESTful（GET/POST/PUT/PATCH/DELETE）；如需特殊例外需在接口文档明确说明

- 接口路径前缀：统一为 `/api/v1`（版本化接口）

- 请求方法与业务对应：例如“获取列表”用 `GET`，“提交表单”用 `POST`；特殊例外需注明

2. **数据格式约定**

- 请求/返回数据类型：统一使用 JSON（避免返回 XML 或纯文本）

- 字段命名规则：API 使用 camelCase（如 `userName`），数据库使用 snake_case（如 `user_name`）；后端映射统一转换

- 空值处理：后端返回 `null` / `""` / 省略字段 的约定；前端需提供兼容策略

- 列表数据结构：统一为 `{ total: <int>, list: [...] }`；分页参数统一为 `page`、`pageSize`

3. **状态码与错误处理**

- HTTP 状态码：成功 200，客户端错误 4xx，服务端错误 5xx；业务状态码如 `code: 10001` 代表“未登录”

- 错误信息格式：统一为 `{ code, message, detail, traceId }`；如需多语言由 `message` 适配

- 特殊场景提示：例如频率限制通过业务码与 `Retry-After` 头返回；前端弹窗与退避策略配合

4. **认证与授权**

- 登录凭证：使用 JWT；携带在请求头 `Authorization: Bearer <token>`

- Token 过期处理：后端返回 `401`；是否启用刷新与刷新流程（前端拦截器 + 刷新接口）

- 权限校验：权限不足返回 `403`；前端跳转至无权限页面

5. **特殊数据处理**

- 日期时间：统一为 ISO8601 UTC 字符串；数据库字段使用 TIMESTAMPTZ

- 文件上传：约定分片与断点续传的接口参数与流程（含校验与合并）

- 二进制数据：优先返回 URL；必要时提供获取二进制流的接口

### 二、前后端分工边界

1. **表单验证**

- 前端负责：基础格式校验（如手机号位数、邮箱格式）、必填项提示、实时反馈（如“密码强度”）

- 后端负责：最终校验（防止前端绕过）、业务规则校验（如“手机号已被注册”）

- 校验失败反馈：后端返回字段级错误（如 `{ errors: { phone: "格式错误" } }`），前端按表单项绑定展示

2. **权限控制**

- 前端负责：根据用户角色隐藏/禁用按钮/菜单（如“普通用户看不到删除按钮”）

- 后端负责：接口访问权限校验（即使前端显示了按钮，无权限时接口返回 403）

- 角色/权限数据：登录返回携带角色；必要时提供查询接口以刷新角色列表

3. **静态资源**

- 图片/视频存储：后端服务器/CDN/OSS；前端优先使用 URL（如 `https://cdn.com/xxx.png`）

- 资源上传路径：支持上传凭证（OSS policy）或直传后端接口，两种模式需在接口文档明确

4. **路由与页面跳转**

- 404/500 页面：由前端路由拦截处理；后端接口仅返回 JSON 错误

- 登录失效跳转：后端不返回 HTML 重定向；前端依据 `code:401` 自行跳转至 `/login`

- 页面参数：例如详情页 `/detail?id=1`，`id` 的格式（数字/字符串）由后端校验与约束

5. **业务逻辑归属**

- 例如：“购物车计算总价”——前端只做展示计算，后端返回最终价格（防止篡改）

- 例如：“列表筛选”——数据量小前端本地筛选；数据量大由后端接口筛选

### 三、技术协作与工具

1. **跨域处理**

- 后端配置 CORS（允许前端域名访问）；允许的请求头需包含 `Content-Type`、`Authorization`

- 若使用前端 Vite `proxy`，后端需识别代理来源并正确处理 `X-Forwarded-*` 头

2. **接口文档与调试**

- 接口文档工具：Swagger/OpenAPI；由后端负责维护并实时更新；前端可用 Apifox/Postman 调试

- 调试环境：统一测试服务器（如 `test.xxx.com`）；接口支持本地 Mock（前端 Mock.js 或后端 Mock 接口）

3. **版本与变更管理**

- 接口变更流程：后端修改接口后需更新文档并群通知，重大变更需提前告知

- 兼容性：新增字段需兼容旧前端；删除字段需设置过渡期与版本号策略

4. **依赖与兼容性**

- 浏览器兼容：明确支持范围；避免返回 IE 不兼容的数据格式（如 `BigInt` 原样返回）

- 前端框架特殊需求：例如 Vue `v-model` 绑定需要特定结构时，由后端提供兼容返回

### 四、项目流程与时间

1. **接口交付时间**

- 后端提供第一批可用接口的时间点；按模块分批交付（如先登录、再首页、再详情）

- 联调截止时间与缓冲期（用于排查与修复问题）

2. **沟通机制**

- 日常对接工具（企业微信/飞书/会议）；接口问题的响应 SLA（如 1 小时内回复）

- 定期同步会（如每日 30 分钟联调进度会）

**使用建议**：

- 每一条确认后，记录后端同学的明确答复（避免“可能”“大概”）；

- 最终整理成《前后端协作规范文档》，双方签字/存档，后期有争议时可追溯；

- 小项目可简化，但“数据交互规则”和“接口文档工具”必须100%对齐。

## 启动前对齐检查清单（可复制）
- [ ] Base Path 与版本统一为 `/api/v1`
- [ ] 认证方式与头部字段（`Authorization: Bearer <token>`）统一
- [ ] 错误包络结构与字段命名约定（API camelCase/DB snake_case）统一
- [ ] 分页参数与返回结构统一（`page`、`pageSize` 与 `{ total, list }`）
- [ ] 时间统一为 ISO8601 UTC（TIMESTAMPTZ），IP 为 INET，结构化字段 JSONB
- [ ] WebSocket 心跳与重连策略对齐（断线重连与最大间隔）
- [ ] Swagger/OpenAPI 文档实时更新；Mock/联调环境明确
- [ ] 故障与执行日志的状态机事件与审批策略对齐（高风险需审批）
- [ ] Prometheus 指标暴露与 Grafana 看板项对齐
- [ ] 安全与审计策略（敏感信息、角色权限、审计日志）对齐
