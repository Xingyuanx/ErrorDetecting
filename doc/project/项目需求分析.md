# 项目需求分析（基于Hadoop的故障检测与自动恢复）

## 项目概述
- 目标：为 Hadoop 运维提供监控、日志分析、智能诊断与自动修复的一体化平台。
- 范围：Web 应用（前端、后端、多智能体编排）、日志采集、数据库与缓存、可观测性。
- 技术栈：FastAPI + SQLAlchemy（异步，`asyncpg`）、PostgreSQL 14+（`JSONB/UUID/INET/TIMESTAMPTZ`）、Flume、前端静态站点原型。

## 背景与问题陈述
- Hadoop 集群在生产中存在多源日志、跨节点事件关联困难、故障定位成本高、修复操作规范性不足等问题。
- 需要一个统一的故障中心：能从日志线索到诊断建议、审批把关与执行记录形成可审计闭环，并提供指标、报表与可视化。

## 目标与成功标准
- 核心闭环：日志→诊断→修复→审计→报表；支持状态机与高风险审批。
- 成功标准：接口与前端原型连通、关键场景可演示、性能与安全指标达基线、文档与数据模型一致。

## 用户角色与场景
- 管理员（admin）：配置与审批、规则管理、用户与权限、全局审计与报表。
- 操作员（operator）：诊断与修复执行、故障中心操作、仪表板监控。
- 观察员（observer）：只读查看（集群、日志、执行记录、报表）。
- 角色可在前端原型中映射，路由控制参考 `src/fronted/utils/auth.js`。

## 关键业务流程
- 日志采集：Flume 推送结构化日志 → 后端预处理与入库 → 前端查询分页展示。
- 故障诊断：选择上下文日志 → LLM 诊断（DiagnosisAgent）→ 风险评估（PolicyAgent）→ 建议与报告生成。
- 修复执行：审批通过 → 执行脚本命令 → 标准输出与错误输出入库 → 结果推送与审计。
- WS 推送：仪表板状态与诊断结果实时更新，断线重连策略。
- 时序参考：`doc/project/diagrams/时序图.puml`。

## 功能需求分解（与前端原型/后端接口/数据表映射）
- 身份认证与注册审批（F-01）：`#login/#register/#user-management`；`POST /api/v1/user/login`、`POST /api/v1/user/register`、`GET /api/v1/user/me`；数据 `users/audit_logs/roles/user_role_mapping`。
- 集群列表与注册（F-02）：`#cluster-list`；`/api/clusters`；数据 `clusters(uuid,name,type,node_count,health_status,config_info)`。
- 仪表板监控（F-03）：`#dashboard`；`/api/cluster/status`、WS `/ws/status`；数据 `nodes(...)`。
- 日志查询（F-04）：`#logs`；`/api/logs?...`；数据 `system_logs(log_id,timestamp,host,service,log_level,message,...)`。
- 故障诊断（F-05）：`#diagnosis`；`POST /api/llm/diagnose`、`POST /api/llm/report`；数据 `fault_records/exec_logs`。
- 故障中心（F-06）：`#fault-center`；`/api/faults/*`、`POST /api/faults/{id}/transition`；数据 `fault_records(...)`。
- 执行日志（F-07）：`#exec-logs`；`/api/exec-logs/*`；数据 `exec_logs(...)`。
- 告警配置（F-08）：`#alert-config`；`/api/alerts/*`；数据 `app_configurations(config_type='alert_rule',...)`。
- 用户管理与角色分配（F-09）：`#user-management/#role-assignment`；`/api/admin/*`；数据 `users/roles/user_role_mapping`。
- 权限策略（F-10）：`#permission-policy`；`/api/policies/*`；数据 `roles/permissions/role_permission_mapping`。
- 审计日志（F-11）：`#audit-logs`；`/api/audit-logs/*`；数据 `audit_logs(...)`。
- WebSocket 推送（F-12）：`#dashboard`、`/ws/status`、`/ws/diagnose`；消息格式统一与重连策略。
- 详细 SRS：见 `doc/project/需求规格说明书.md:19-103`。

## 接口约定与版本策略
- API 前缀：`/api/v1`（见 `src/backend/app/main.py:15-18` 路由挂载）。
- 返回结构：列表 `{ total, list }`；错误包络 `{ code, message, detail, traceId }`（见 `src/backend/README.md:47-55`）。
- 统一状态码与业务码映射：参考团队约定（见周报 `doc/process/weekly/week-9/...`）。
- 时间与类型规范：`TIMESTAMPTZ`/`JSONB` 对齐 PostgreSQL 原生类型。

## 非功能需求与指标
- 性能：核心查询 P95 ≤ 500ms；WS 延迟 ≤ 500ms；后端并发 ≥ 1k 连接稳定（见 `doc/project/前后端启动前交流确认清单.md:125`）。
- 安全：JWT、CORS 白名单、RBAC、速率限制、审计；敏感信息通过环境变量管理（`DATABASE_URL/JWT_SECRET`）。
- 可靠性：数据库备份与恢复演练；关键链路重试与降级。
- 可观测性：Prometheus 指标、Grafana 看板、日志分级与 TraceID。
- 可维护性与可用性：模块化、组件化、ARIA 可访问性与清晰交互反馈。

## 数据模型与约束摘要
- 关键实体：`clusters`、`nodes`、`system_logs`、`fault_records`、`exec_logs`、`app_configurations`、`users`、`audit_logs`、`roles`、`permissions`、`user_role_mapping`、`role_permission_mapping`、`user_cluster_mapping`。
- 约束：唯一键与外键完整；检查约束覆盖状态与枚举值；高频查询索引覆盖。
- 参考：`doc/project/数据库设计文档.md`、`doc/project/数据库建表脚本_postgres.sql`、`doc/project/数据字典.md`。

## 当前实现基线（便于联调）
- 后端入口：`src/backend/app/main.py:1-18`；CORS 允许所有来源（开发阶段）。
- 基础路由：`/api/v1/health`、`/api/v1/clusters`、`/api/v1/faults`、`/api/v1/logs`（见路由目录）。
- 环境变量加载：`src/backend/app/config.py:6-9`；数据库会话：`src/backend/app/db.py:1-10`。
- 前端原型：`src/fronted/index.html`；导航与权限：`src/fronted/utils/navigation.js`、`src/fronted/utils/auth.js`。

## 里程碑与交付
- M1：接口与数据模型最小可用（列表与健康检查可演示）。
- M2：登录/注册与 JWT 完成；RBAC 初版；审计入库。
- M3：诊断与修复闭环（含审批与执行日志）；报表初版。
- M4：性能与监控基线达标；安全策略落地；文档齐备。

## 验收标准
- 端到端闭环可演示；接口与页面一致；关键指标达基线；审计与安全策略有效。
- 文档一致性：SRS、数据字典、建表脚本与接口文档一致；代码路径与接口前缀清晰可查。

## 风险与应对
- 并发一致性：采用乐观/幂等策略，后续引入锁与事务细化；测试覆盖关键状态转换。
- 安全复杂度：JWT 与角色权限细化，接口白名单与速率控制；日志审计与告警联动。
- 集成复杂度：Flume/Hadoop 环节逐步引入，保持后端与前端最小闭环可演示。

## 开放问题与下一步
- 诊断与审批策略边界需与业务方细化；高风险分类与联动规则待完善。
- 报表与指标体系细化（准确率、时效性、复发率、KPI 定义）。
- WebSocket 与队列/缓存（如 Redis）集成方案与参数调优（连接池、超时、重试）。

