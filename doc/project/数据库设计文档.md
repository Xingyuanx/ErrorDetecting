# 数据库设计文档

## 1. 数据库概览
本数据库名为 `hadoop_fault_db`，包含核心业务表及系统日志表。

## 2. 表结构详述

### app_configurations (应用配置表)
**表名**: `app_configurations` (应用配置表)

**字段列表**:
| 序号 | 字段名 | 类型 | 说明 |
| :--- | :--- | :--- | :--- |
| 1 | id | bigint NOT NULL | 主键ID |
| 2 | config_type | character varying(20) NOT NULL | 配置类型(system/alert_rule/notification/llm) |
| 3 | config_key | character varying(100) NOT NULL | 配置键 |
| 4 | config_value | jsonb NOT NULL | 配置值(JSONB) |
| 5 | description | character varying(500) | 配置描述 |
| 6 | is_enabled | boolean DEFAULT true NOT NULL | 是否启用 |
| 7 | created_at | timestamp with time zone DEFAULT now() NOT NULL | 创建时间 |
| 8 | updated_at | timestamp with time zone DEFAULT now() NOT NULL | 更新时间 |

### chat_messages
**表名**: `chat_messages`

**字段列表**:
| 序号 | 字段名 | 类型 | 说明 |
| :--- | :--- | :--- | :--- |
| 1 | id | integer NOT NULL |  |
| 2 | session_id | character varying NOT NULL |  |
| 3 | role | character varying NOT NULL |  |
| 4 | content | text NOT NULL |  |
| 5 | created_at | timestamp with time zone |  |
| 6 | reasoning | text |  |
| 7 | username | character varying(64) |  |

### chat_sessions
**表名**: `chat_sessions`

**字段列表**:
| 序号 | 字段名 | 类型 | 说明 |
| :--- | :--- | :--- | :--- |
| 1 | id | character varying NOT NULL |  |
| 2 | user_id | integer |  |
| 3 | title | character varying |  |
| 4 | created_at | timestamp with time zone |  |
| 5 | updated_at | timestamp with time zone |  |

### cluster_metrics (集群指标表)
**表名**: `cluster_metrics` (集群指标表)

**字段列表**:
| 序号 | 字段名 | 类型 | 说明 |
| :--- | :--- | :--- | :--- |
| 1 | id | integer NOT NULL |  |
| 2 | cluster_id | integer NOT NULL |  |
| 3 | timestamp | timestamp with time zone NOT NULL |  |
| 4 | cpu_avg | double precision |  |
| 5 | mem_used_avg | double precision |  |
| 6 | mem_free_avg | double precision |  |

### clusters (集群表)
**表名**: `clusters` (集群表)

**字段列表**:
| 序号 | 字段名 | 类型 | 说明 |
| :--- | :--- | :--- | :--- |
| 1 | id | bigint NOT NULL | 主键ID |
| 2 | uuid | uuid NOT NULL | 集群唯一标识(UUID) |
| 3 | name | character varying(100) NOT NULL | 集群名称 |
| 4 | type | character varying(50) NOT NULL | 集群类型 |
| 5 | node_count | integer DEFAULT 0 NOT NULL | 集群节点数量 |
| 6 | health_status | character varying(20) DEFAULT 'unknown'::character varying NOT NULL | 集群健康状态(healthy/warning/error/unknown) |
| 7 | description | text | 集群描述 |
| 8 | config_info | jsonb | 集群配置信息(JSONB) |
| 9 | created_at | timestamp with time zone DEFAULT now() NOT NULL | 创建时间 |
| 10 | updated_at | timestamp with time zone DEFAULT now() NOT NULL | 更新时间 |
| 11 | namenode_ip | inet |  |
| 12 | namenode_psw | character varying(255) |  |
| 13 | rm_ip | inet |  |
| 14 | rm_psw | character varying(255) |  |

### hadoop_exec_logs (Hadoop执行日志表)
**表名**: `hadoop_exec_logs` (Hadoop执行日志表)

**字段列表**:
| 序号 | 字段名 | 类型 | 说明 |
| :--- | :--- | :--- | :--- |
| 1 | id | integer NOT NULL |  |
| 2 | from_user_id | integer NOT NULL |  |
| 3 | cluster_name | character varying(255) NOT NULL |  |
| 4 | description | text |  |
| 5 | start_time | timestamp with time zone |  |
| 6 | end_time | timestamp with time zone |  |

### hadoop_logs
**表名**: `hadoop_logs`

**字段列表**:
| 序号 | 字段名 | 类型 | 说明 |
| :--- | :--- | :--- | :--- |
| 1 | log_id | integer NOT NULL |  |
| 2 | cluster_name | character varying(255) NOT NULL |  |
| 3 | node_host | character varying(100) NOT NULL |  |
| 4 | title | character varying(255) |  |
| 5 | info | text |  |
| 6 | log_time | timestamp with time zone NOT NULL |  |

### node_metrics (节点指标表)
**表名**: `node_metrics` (节点指标表)

**字段列表**:
| 序号 | 字段名 | 类型 | 说明 |
| :--- | :--- | :--- | :--- |
| 1 | id | integer NOT NULL |  |
| 2 | cluster_id | integer |  |
| 3 | node_name | character varying(100) NOT NULL |  |
| 4 | timestamp | timestamp with time zone NOT NULL |  |
| 5 | cpu_usage | double precision |  |
| 6 | mem_used | double precision |  |
| 7 | mem_free | double precision |  |

### nodes
**表名**: `nodes`

**字段列表**:
| 序号 | 字段名 | 类型 | 说明 |
| :--- | :--- | :--- | :--- |
| 1 | id | bigint NOT NULL | 主键ID |
| 2 | uuid | uuid NOT NULL | 节点唯一标识(UUID) |
| 3 | cluster_id | bigint NOT NULL | 所属集群ID |
| 4 | hostname | character varying(100) NOT NULL | 节点主机名 |
| 5 | ip_address | inet NOT NULL | 节点IP地址(INET, 兼容IPv4/IPv6) |
| 6 | status | character varying(20) DEFAULT 'unknown'::character varying NOT NULL | 节点健康状态(healthy/unhealthy/warning/unknown) |
| 7 | cpu_usage | numeric(5,2) | CPU使用率(%) |
| 8 | memory_usage | numeric(5,2) | 内存使用率(%) |
| 9 | disk_usage | numeric(5,2) | 磁盘使用率(%) |
| 10 | last_heartbeat | timestamp with time zone | 最后心跳时间 |
| 11 | created_at | timestamp with time zone DEFAULT now() NOT NULL | 创建时间 |
| 12 | updated_at | timestamp with time zone DEFAULT now() NOT NULL | 更新时间 |
| 13 | ssh_user | character varying(50) |  |
| 14 | ssh_password | character varying(255) |  |

### permissions
**表名**: `permissions`

**字段列表**:
| 序号 | 字段名 | 类型 | 说明 |
| :--- | :--- | :--- | :--- |
| 1 | id | bigint NOT NULL | 主键ID |
| 2 | permission_name | character varying(100) NOT NULL | 权限名称 |
| 3 | permission_key | character varying(100) NOT NULL | 权限唯一标识 |
| 4 | description | character varying(255) | 权限描述 |
| 5 | created_at | timestamp with time zone DEFAULT now() NOT NULL | 创建时间 |

### repair_templates
**表名**: `repair_templates`

**字段列表**:
| 序号 | 字段名 | 类型 | 说明 |
| :--- | :--- | :--- | :--- |
| 1 | id | bigint NOT NULL | 主键ID |
| 2 | template_name | character varying(100) NOT NULL | 模板名称 |
| 3 | fault_type | character varying(50) NOT NULL | 适用故障类型 |
| 4 | script_content | text NOT NULL | 脚本内容 |
| 5 | risk_level | character varying(20) DEFAULT 'medium'::character varying NOT NULL | 风险级别(low/medium/high) |
| 6 | description | text | 模板描述 |
| 7 | parameters | jsonb | 模板参数定义(JSONB) |
| 8 | created_by | character varying(50) | 创建人 |
| 9 | created_at | timestamp with time zone DEFAULT now() NOT NULL | 创建时间 |
| 10 | updated_at | timestamp with time zone DEFAULT now() NOT NULL | 更新时间 |

### role_permission_mapping (角色权限关联表)
**表名**: `role_permission_mapping` (角色权限关联表)

**字段列表**:
| 序号 | 字段名 | 类型 | 说明 |
| :--- | :--- | :--- | :--- |
| 1 | role_id | bigint NOT NULL | 角色ID |
| 2 | permission_id | bigint NOT NULL | 权限ID |

### roles
**表名**: `roles`

**字段列表**:
| 序号 | 字段名 | 类型 | 说明 |
| :--- | :--- | :--- | :--- |
| 1 | id | bigint NOT NULL | 主键ID |
| 2 | role_name | character varying(50) NOT NULL | 角色名称 |
| 3 | role_key | character varying(50) NOT NULL | 角色唯一标识 |
| 4 | description | character varying(255) | 角色描述 |
| 5 | is_system_role | boolean DEFAULT false NOT NULL | 是否为系统内置角色 |
| 6 | created_at | timestamp with time zone DEFAULT now() NOT NULL | 创建时间 |
| 7 | updated_at | timestamp with time zone DEFAULT now() NOT NULL | 更新时间 |

### sys_exec_logs (系统操作日志表)
**表名**: `sys_exec_logs` (系统操作日志表)

**字段列表**:
| 序号 | 字段名 | 类型 | 说明 |
| :--- | :--- | :--- | :--- |
| 1 | operation_id | uuid DEFAULT public.uuid_generate_v4() NOT NULL |  |
| 2 | user_id | integer NOT NULL |  |
| 3 | description | text NOT NULL |  |
| 4 | operation_time | timestamp with time zone DEFAULT now() NOT NULL |  |

### user_cluster_mapping
**表名**: `user_cluster_mapping`

**字段列表**:
| 序号 | 字段名 | 类型 | 说明 |
| :--- | :--- | :--- | :--- |
| 1 | id | bigint NOT NULL | 主键ID |
| 2 | user_id | bigint NOT NULL | 用户ID |
| 3 | cluster_id | bigint NOT NULL | 集群ID |
| 4 | role_id | bigint NOT NULL | 角色ID |
| 5 | created_at | timestamp with time zone DEFAULT now() NOT NULL | 创建时间 |

### user_role_mapping (用户角色关联表)
**表名**: `user_role_mapping` (用户角色关联表)

**字段列表**:
| 序号 | 字段名 | 类型 | 说明 |
| :--- | :--- | :--- | :--- |
| 1 | user_id | bigint NOT NULL | 用户ID |
| 2 | role_id | bigint NOT NULL | 角色ID |

### users (用户表)
**表名**: `users` (用户表)

**字段列表**:
| 序号 | 字段名 | 类型 | 说明 |
| :--- | :--- | :--- | :--- |
| 1 | id | bigint NOT NULL | 主键ID |
| 2 | username | character varying(50) NOT NULL | 用户名 |
| 3 | email | character varying(100) NOT NULL | 邮箱 |
| 4 | password_hash | character varying(255) NOT NULL | 密码哈希 |
| 5 | full_name | character varying(100) NOT NULL | 姓名 |
| 6 | is_active | boolean DEFAULT true NOT NULL | 是否激活 |
| 7 | last_login | timestamp with time zone | 最后登录时间 |
| 8 | created_at | timestamp with time zone DEFAULT now() NOT NULL | 创建时间 |
| 9 | updated_at | timestamp with time zone DEFAULT now() NOT NULL | 更新时间 |
