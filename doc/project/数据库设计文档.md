# 故障检测系统数据库设计文档

<style>
/* 统一本文件所有表格列宽与对齐 */
table {
  width: 100%;
  table-layout: fixed; /* 固定布局，列宽按百分比分配 */
  border-collapse: collapse;
}
table th, table td {
  text-align: left; /* 每一列首部对齐（左对齐） */
  vertical-align: top; /* 条目从上到下对齐 */
}
/* 六列宽度统一为固定比例，确保从上到下列宽一致 */
table th:nth-child(1), table td:nth-child(1) { width: 16%; }
table th:nth-child(2), table td:nth-child(2) { width: 16%; }
table th:nth-child(3), table td:nth-child(3) { width: 8%; }
table th:nth-child(4), table td:nth-child(4) { width: 12%; }
table th:nth-child(5), table td:nth-child(5) { width: 12%; }
table th:nth-child(6), table td:nth-child(6) { width: 36%; }
</style>

## 1. 数据库概述

### 1.1 设计目标
- 支持Hadoop集群故障检测与自动修复系统
- 提供高效的日志存储和查询能力
- 支持执行日志、集群状态等核心业务数据
- 确保数据一致性和系统性能

### 1.2 技术选型
- **数据库**: PostgreSQL 14+
- **主要类型**: `JSONB`、`UUID`、`INET`、`TIMESTAMPTZ`
- **字符集**: UTF8
- **时区**: 推荐使用UTC并统一为`TIMESTAMPTZ`
 - **后端**: `FastAPI` + `Uvicorn` + `Pydantic`
 - **数据库访问**: `SQLAlchemy` + `asyncpg`
 - **缓存/消息**: `Redis`（状态缓存/速率限制）
 - **日志采集**: `Apache Flume`（可选替代：`Fluent Bit`）
 - **前端**: `Vue3` + `Vite` + `Element Plus` + `ECharts`
 - **实时通信**: WebSocket（状态与诊断结果推送）
 - **多智能体编排**: `LangGraph`/`Ray`（Diagnosis/Repair/Policy Agent）
 - **可观测性**: `Prometheus` + `Grafana`（API与Agent指标监控）

### 1.3 命名规范
- 表名：小写字母+下划线，复数形式
- 字段名：小写字母+下划线
- 索引名：idx_表名_字段名
- 外键名：fk_表名_字段名

## 2. 数据库结构设计

### 2.1 核心业务表

#### 2.1.1 执行日志表 (exec_logs)
记录自动修复脚本的执行过程和结果

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
| :----- | :------- | :--- | :------ | :----- | :--- |
| id | BIGINT | - | NOT NULL | IDENTITY | 主键ID |
| exec_id | VARCHAR | 32 | NOT NULL | - | 执行唯一标识 |
| fault_id | VARCHAR | 32 | NOT NULL | - | 关联故障标识(无外键) |
| command_type | VARCHAR | 50 | NOT NULL | - | 命令类型 |
| script_path | VARCHAR | 255 | NULL | - | 脚本路径 |
| command_content | TEXT | - | NOT NULL | - | 执行的命令内容 |
| target_nodes | JSONB | - | NULL | - | 目标执行节点 |
| risk_level | VARCHAR | 20 | NOT NULL | 'medium' | 风险级别(low/medium/high) |
| execution_status | VARCHAR | 20 | NOT NULL | 'pending' | 执行状态(pending/running/success/failed/timeout) |
| start_time | TIMESTAMPTZ | - | NULL | - | 开始执行时间 |
| end_time | TIMESTAMPTZ | - | NULL | - | 结束执行时间 |
| duration | INT | - | NULL | - | 执行时长(秒) |
| stdout_log | TEXT | - | NULL | - | 标准输出日志 |
| stderr_log | TEXT | - | NULL | - | 错误输出日志 |
| exit_code | INT | - | NULL | - | 退出码 |
| operator | VARCHAR | 50 | NOT NULL | 'system' | 操作人 |
| created_at | TIMESTAMPTZ | - | NOT NULL | NOW() | 创建时间 |
| updated_at | TIMESTAMPTZ | - | NOT NULL | NOW() | 更新时间 |

**索引设计:**
- PRIMARY KEY (id)
- UNIQUE KEY uk_exec_id (exec_id)
- KEY idx_fault_id (fault_id)
- KEY idx_execution_status (execution_status)

#### 2.1.2 节点信息表 (nodes)
记录集群内各节点的状态信息

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
| :----- | :------- | :--- | :------ | :----- | :--- |
| id | BIGINT | - | NOT NULL | IDENTITY | 主键ID |
| uuid | UUID | - | NOT NULL | - | 节点唯一标识(UUID) |
| cluster_id | BIGINT | - | NOT NULL | - | 所属集群ID |
| hostname | VARCHAR | 100 | NOT NULL | - | 节点主机名 |
| ip_address | INET | - | NOT NULL | - | 节点IP地址(IPv4/IPv6) |
| status | VARCHAR | 20 | NOT NULL | 'unknown' | 节点健康状态(healthy/unhealthy/warning/unknown) |
| cpu_usage | NUMERIC | 5,2 | NULL | - | CPU使用率(%) |
| memory_usage | NUMERIC | 5,2 | NULL | - | 内存使用率(%) |
| disk_usage | NUMERIC | 5,2 | NULL | - | 磁盘使用率(%) |
| last_heartbeat | TIMESTAMPTZ | - | NULL | - | 最后心跳时间 |
| created_at | TIMESTAMPTZ | - | NOT NULL | NOW() | 创建时间 |
| updated_at | TIMESTAMPTZ | - | NOT NULL | NOW() | 更新时间 |

**索引设计:**
- PRIMARY KEY (id)
- UNIQUE KEY uk_cluster_hostname (cluster_id, hostname)
- INDEX: idx_nodes_cluster_id (cluster_id)
- INDEX: idx_nodes_status (status)
- INDEX: idx_nodes_last_heartbeat (last_heartbeat)
- INDEX: idx_nodes_ip_address (ip_address)

#### 2.1.3 系统日志表 (system_logs)
存储从Flume采集的原始日志数据

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
| :----- | :------- | :--- | :------ | :----- | :--- |
| id | BIGINT | - | NOT NULL | IDENTITY | 主键ID |
| log_id | VARCHAR | 32 | NOT NULL | - | 日志唯一标识 |
| fault_id | VARCHAR | 32 | NULL | - | 关联故障标识(无外键) |
| cluster_id | BIGINT | - | NULL | - | 关联集群ID |
| timestamp | TIMESTAMPTZ | - | NOT NULL | - | 日志时间戳 |
| host | VARCHAR | 100 | NOT NULL | - | 主机名 |
| service | VARCHAR | 50 | NOT NULL | - | 服务名 |
| log_level | VARCHAR | 10 | NOT NULL | - | 日志级别(DEBUG/INFO/WARN/ERROR/FATAL) |
| message | TEXT | - | NOT NULL | - | 日志消息 |
| exception | TEXT | - | NULL | - | 异常堆栈 |
| raw_log | TEXT | - | NULL | - | 原始日志内容 |
| processed | BOOLEAN | - | NOT NULL | FALSE | 是否已处理 |
| created_at | TIMESTAMPTZ | - | NOT NULL | NOW() | 创建时间 |

**索引设计:**
- PRIMARY KEY (id)
- UNIQUE KEY uk_log_id (log_id)
- KEY idx_system_logs_fault_id (fault_id)
- KEY idx_system_logs_cluster_id (cluster_id)
- KEY idx_system_logs_timestamp (timestamp)
- KEY idx_system_logs_level (log_level)
- KEY idx_system_logs_processed (processed)

### 2.2 配置管理与用户表

#### 2.2.0 角色表 (roles)
系统角色定义

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
| :----- | :------- | :--- | :------ | :----- | :--- |
| id | BIGINT | - | NOT NULL | IDENTITY | 主键ID |
| role_name | VARCHAR | 50 | NOT NULL | - | 角色名称 |
| role_key | VARCHAR | 50 | NOT NULL | - | 角色唯一标识 |
| description | VARCHAR | 255 | NULL | - | 角色描述 |
| is_system_role | BOOLEAN | - | NOT NULL | FALSE | 是否为系统内置角色 |
| created_at | TIMESTAMPTZ | - | NOT NULL | NOW() | 创建时间 |
| updated_at | TIMESTAMPTZ | - | NOT NULL | NOW() | 更新时间 |

**索引/约束设计:**
- PRIMARY KEY (id)
- UNIQUE KEY uk_role_key (role_key)

#### 2.2.1 权限表 (permissions)
系统权限定义

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
| :----- | :------- | :--- | :------ | :----- | :--- |
| id | BIGINT | - | NOT NULL | IDENTITY | 主键ID |
| permission_name | VARCHAR | 100 | NOT NULL | - | 权限名称 |
| permission_key | VARCHAR | 100 | NOT NULL | - | 权限唯一标识 |
| description | VARCHAR | 255 | NULL | - | 权限描述 |
| created_at | TIMESTAMPTZ | - | NOT NULL | NOW() | 创建时间 |

**索引/约束设计:**
- PRIMARY KEY (id)
- UNIQUE KEY uk_permission_key (permission_key)

#### 2.2.2 角色-权限映射表 (role_permission_mapping)
多对多关系的中间表

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
| :----- | :------- | :--- | :------ | :----- | :--- |
| role_id | BIGINT | - | NOT NULL | - | 角色ID |
| permission_id | BIGINT | - | NOT NULL | - | 权限ID |

**索引/约束设计:**
- PRIMARY KEY (role_id, permission_id)
- 外键: `role_id → roles.id (CASCADE)`
- 外键: `permission_id → permissions.id (CASCADE)`

#### 2.2.1 集群信息表 (clusters)
存储用户管理的集群信息

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
| :----- | :------- | :--- | :------ | :----- | :--- |
| id | BIGINT | - | NOT NULL | IDENTITY | 主键ID |
| uuid | UUID | - | NOT NULL | - | 集群唯一标识(UUID) |
| name | VARCHAR | 100 | NOT NULL | - | 集群名称 |
| type | VARCHAR | 50 | NOT NULL | - | 集群类型 |
| node_count | INT | - | NOT NULL | 0 | 集群节点数量 |
| health_status | VARCHAR | 20 | NOT NULL | 'unknown' | 集群健康状态(healthy/warning/error/unknown) |
| description | TEXT | - | NULL | - | 集群描述 |
| config_info | JSONB | - | NULL | - | 集群配置信息(JSONB) |
| created_at | TIMESTAMPTZ | - | NOT NULL | NOW() | 创建时间 |
| updated_at | TIMESTAMPTZ | - | NOT NULL | NOW() | 更新时间 |

**索引/约束设计:**
- PRIMARY KEY (id)
- UNIQUE (uuid)
- UNIQUE (name)
- CHECK: `health_status ∈ {healthy, warning, error, unknown}`

#### 2.2.2 用户与集群映射表 (user_cluster_mapping)
管理用户和集群的多对多关系

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
| :----- | :------- | :--- | :------ | :----- | :--- |
| id | BIGINT | - | NOT NULL | IDENTITY | 主键ID |
| user_id | BIGINT | - | NOT NULL | - | 用户ID |
| cluster_id | BIGINT | - | NOT NULL | - | 集群ID |
| role_id | BIGINT | - | NOT NULL | - | 角色ID |
| created_at | TIMESTAMPTZ | - | NOT NULL | NOW() | 创建时间 |

**索引/约束设计:**
- PRIMARY KEY (id)
- UNIQUE KEY uk_user_cluster (user_id, cluster_id)
- 外键: `user_id → users.id (CASCADE)`
- 外键: `cluster_id → clusters.id (CASCADE)`
- 外键: `role_id → roles.id (CASCADE)`

#### 2.2.3 应用统一配置表 (app_configurations)
统一管理系统配置、告警规则和通知设置

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
| :----- | :------- | :--- | :------ | :----- | :--- |
| id | BIGINT | - | NOT NULL | IDENTITY | 主键ID |
| config_type | VARCHAR | 20 | NOT NULL | - | 配置类型(system/alert_rule/notification/llm) |
| config_key | VARCHAR | 100 | NOT NULL | - | 配置键 |
| config_value | JSONB | - | NOT NULL | - | 配置值(JSONB) |
| description | VARCHAR | 500 | NULL | - | 配置描述 |
| is_enabled | BOOLEAN | - | NOT NULL | TRUE | 是否启用 |
| created_at | TIMESTAMPTZ | - | NOT NULL | NOW() | 创建时间 |
| updated_at | TIMESTAMPTZ | - | NOT NULL | NOW() | 更新时间 |

**索引/约束设计:**
- PRIMARY KEY (id)
- UNIQUE KEY uk_app_config (config_type, config_key)
- KEY idx_app_config_enabled (is_enabled)
- CHECK: `config_type ∈ {system, alert_rule, notification, llm}`

#### 2.2.4 用户表 (users)
系统用户信息

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
| :----- | :------- | :--- | :------ | :----- | :--- |
| id | BIGINT | - | NOT NULL | IDENTITY | 主键ID |
| username | VARCHAR | 50 | NOT NULL | - | 用户名 |
| email | VARCHAR | 100 | NOT NULL | - | 邮箱 |
| password_hash | VARCHAR | 255 | NOT NULL | - | 密码哈希 |
| full_name | VARCHAR | 100 | NOT NULL | - | 姓名 |
| is_active | BOOLEAN | - | NOT NULL | TRUE | 是否激活 |
| last_login | TIMESTAMPTZ | - | NULL | - | 最后登录时间 |
| created_at | TIMESTAMPTZ | - | NOT NULL | NOW() | 创建时间 |
| updated_at | TIMESTAMPTZ | - | NOT NULL | NOW() | 更新时间 |

**索引设计:**
- PRIMARY KEY (id)
- UNIQUE KEY uk_username (username)
- UNIQUE KEY uk_email (email)

#### 2.2.5 用户-角色映射表 (user_role_mapping)
用户与角色的多对多关系

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
| :----- | :------- | :--- | :------ | :----- | :--- |
| user_id | BIGINT | - | NOT NULL | - | 用户ID |
| role_id | BIGINT | - | NOT NULL | - | 角色ID |

**索引/约束设计:**
- PRIMARY KEY (user_id, role_id)
- 外键: `user_id → users.id (CASCADE)`
- 外键: `role_id → roles.id (CASCADE)`

#### 2.2.6 操作审计表 (audit_logs)
记录用户操作审计日志

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
| :----- | :------- | :--- | :------ | :----- | :--- |
| id | BIGINT | - | NOT NULL | IDENTITY | 主键ID |
| user_id | BIGINT | - | NULL | - | 用户ID |
| cluster_id | BIGINT | - | NULL | - | 集群ID |
| role_id | BIGINT | - | NULL | - | 角色ID |
| username | VARCHAR | 50 | NOT NULL | - | 用户名 |
| action | VARCHAR | 100 | NOT NULL | - | 操作动作 |
| resource_type | VARCHAR | 50 | NOT NULL | - | 资源类型 |
| resource_id | VARCHAR | 100 | NULL | - | 资源ID |
| ip_address | INET | - | NOT NULL | - | 请求来源IP(IPv4/IPv6) |
| request_data | JSONB | - | NULL | - | 请求数据(JSONB) |
| response_status | INT | - | NULL | - | 响应状态码 |
| created_at | TIMESTAMPTZ | - | NOT NULL | NOW() | 创建时间 |

**索引设计:**
- PRIMARY KEY (id)
- KEY idx_audit_logs_user_id (user_id)
- KEY idx_audit_logs_cluster_id (cluster_id)
- KEY idx_audit_logs_role_id (role_id)
- KEY idx_audit_logs_action (action)
- KEY idx_audit_logs_created_at (created_at)

### 2.3 扩展表

#### 2.3.1 修复脚本模板表 (repair_templates)
存储用于自动修复的脚本模板

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
| :----- | :------- | :--- | :------ | :----- | :--- |
| id | BIGINT | - | NOT NULL | IDENTITY | 主键ID |
| template_name | VARCHAR | 100 | NOT NULL | - | 模板名称 |
| fault_type | VARCHAR | 50 | NOT NULL | - | 适用故障类型 |
| script_content | TEXT | - | NOT NULL | - | 脚本内容 |
| risk_level | VARCHAR | 20 | NOT NULL | 'medium' | 风险级别(low/medium/high) |
| description | TEXT | - | NULL | - | 模板描述 |
| parameters | JSONB | - | NULL | - | 参数定义 |
| created_by | VARCHAR | 50 | NULL | - | 创建人 |
| created_at | TIMESTAMPTZ | - | NOT NULL | NOW() | 创建时间 |
| updated_at | TIMESTAMPTZ | - | NOT NULL | NOW() | 更新时间 |

**索引设计:**
- PRIMARY KEY (id)
- UNIQUE KEY uk_template_name (template_name)
- KEY idx_fault_type (fault_type)

## 3. 表关系设计

### 3.1 外键关系
```sql
-- system_logs.cluster_id → clusters.id (SET NULL, CASCADE)
-- nodes.cluster_id → clusters.id (CASCADE, CASCADE)
-- user_cluster_mapping.user_id → users.id (CASCADE, CASCADE)
-- user_cluster_mapping.cluster_id → clusters.id (CASCADE, CASCADE)
-- user_cluster_mapping.role_id → roles.id (CASCADE, CASCADE)
-- user_role_mapping.user_id → users.id (CASCADE, CASCADE)
-- user_role_mapping.role_id → roles.id (CASCADE, CASCADE)
-- role_permission_mapping.role_id → roles.id (CASCADE, CASCADE)
-- role_permission_mapping.permission_id → permissions.id (CASCADE, CASCADE)
-- audit_logs.user_id → users.id (SET NULL, CASCADE)
-- audit_logs.cluster_id → clusters.id (SET NULL, CASCADE)
-- audit_logs.role_id → roles.id (SET NULL, CASCADE)
```

### 3.2 关系说明
- **users** ↔ **clusters**: 多对多，通过 `user_cluster_mapping(user_id, cluster_id, role_id)` 连接。
- **users** ↔ **roles**: 多对多，通过 `user_role_mapping(user_id, role_id)` 连接。
- **roles** ↔ **permissions**: 多对多，通过 `role_permission_mapping(role_id, permission_id)` 连接。
- **clusters** ↔ **nodes**: 一对多，一个集群包含多个节点。
  
- **users** ↔ **audit_logs**: 一对多，一个用户可能有多条操作审计记录。
- **clusters** ↔ **audit_logs**: 一对多（可选），一个集群上的操作会产生审计日志。
- **roles** ↔ **audit_logs**: 一对多（可选），审计记录可附带当时的角色。
- **app_configurations**: 独立表，统一管理所有配置。
- **repair_templates**: 独立表，存储修复脚本模板。

## 4. 数据库初始化脚本

### 4.1 执行脚本
- 请直接在目标 PostgreSQL 数据库中执行 `doc/project/数据库建表脚本_postgres.sql`，该脚本包含所有表、索引、约束与注释。

## 5. 性能优化建议

### 5.1 分区策略
- **system_logs**: 按时间分区，每月一个分区。
- **audit_logs**: 按时间分区，每季度一个分区。

### 5.2 索引优化
- 为高频查询字段创建复合索引。
- 定期分析索引使用情况，删除无用索引。
- 对大表考虑使用分区索引。

### 5.3 数据归档
- `system_logs` 表数据保留3个月，超期数据归档到历史表。
- `audit_logs` 表数据保留1年。
- 定期清理临时数据和过期缓存。

## 6. 备份与恢复策略

### 6.1 备份策略
- 每日全量备份。
- 每小时增量备份。
- 重要操作前手动备份。

### 6.2 恢复测试
- 每月进行备份恢复测试。
- 制定灾难恢复预案。
- 建立数据恢复SOP。

## 7. 监控与维护

### 7.1 性能监控
- 监控慢查询日志。
- 跟踪表空间使用情况。
- 监控连接数和锁等待。

### 7.2 定期维护
- 每周执行表优化。
- 定期更新表统计信息。
- 监控磁盘空间使用情况。
