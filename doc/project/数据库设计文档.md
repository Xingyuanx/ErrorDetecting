# 故障检测系统数据库设计文档

<style>
/* 统一本文件所有表格列宽与对齐 */
table {
  width: 100%;
  table-layout: fixed; /* 固定布局，列宽按百分比分配 */
  border-collapse: collapse;
}
table th, table td {
  text-align: left; /* 每一列首部对齐（左对齐） */
  vertical-align: top; /* 条目从上到下对齐 */
}
/* 六列宽度统一为固定比例，确保从上到下列宽一致 */
table th:nth-child(1), table td:nth-child(1) { width: 16%; }
table th:nth-child(2), table td:nth-child(2) { width: 16%; }
table th:nth-child(3), table td:nth-child(3) { width: 8%; }
table th:nth-child(4), table td:nth-child(4) { width: 12%; }
table th:nth-child(5), table td:nth-child(5) { width: 12%; }
table th:nth-child(6), table td:nth-child(6) { width: 36%; }
</style>

## 1. 数据库概述

### 1.1 设计目标
- 支持Hadoop集群故障检测与自动修复系统
- 提供高效的日志存储和查询能力
- 支持执行日志、集群状态等核心业务数据
- 确保数据一致性和系统性能

### 1.2 技术选型
- **数据库**: PostgreSQL 14+
- **主要类型**: `JSONB`、`UUID`、`INET`、`TIMESTAMPTZ`
- **字符集**: UTF8
- **时区**: 推荐使用UTC并统一为`TIMESTAMPTZ`
 - **后端**: `FastAPI` + `Uvicorn` + `Pydantic`
 - **数据库访问**: `SQLAlchemy` + `asyncpg`
 - **缓存/消息**: `Redis`（状态缓存/速率限制）
 - **日志采集**: `Apache Flume`（可选替代：`Fluent Bit`）
 - **前端**: `Vue3` + `Vite` + `Element Plus` + `ECharts`
 - **实时通信**: WebSocket（状态与诊断结果推送）
 - **多智能体编排**: `LangGraph`/`Ray`（Diagnosis/Repair/Policy Agent）
 - **可观测性**: `Prometheus` + `Grafana`（API与Agent指标监控）

### 1.3 命名规范
- 表名：小写字母+下划线，复数形式
- 字段名：小写字母+下划线
- 索引名：idx_表名_字段名
- 外键名：fk_表名_字段名

## 2. 数据库结构设计

### 2.1 核心业务表

#### 2.1.1 执行日志表 (exec_logs)
记录自动修复脚本的执行过程和结果

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
| :----- | :------- | :--- | :------ | :----- | :--- |
| id | BIGINT | - | NOT NULL | - | (PK) 主键ID |
| exec_id | CHARACTER | - | NOT NULL | - | 执行唯一标识 |
| fault_id | CHARACTER | - | NOT NULL | - | 关联故障标识(无外键) |
| command_type | CHARACTER | - | NOT NULL | - | 命令类型 |
| script_path | CHARACTER | - | NULL | - | 脚本路径 |
| command_content | TEXT | - | NOT NULL | - | 执行的命令内容 |
| target_nodes | JSONB | - | NULL | - | 目标执行节点(JSONB) |
| risk_level | CHARACTER | - | NOT NULL | 'medium'::character | 风险级别(low/medium/high) |
| execution_status | CHARACTER | - | NOT NULL | 'pending'::character | 执行状态(pending/running/success/failed/timeout) |
| start_time | TIMESTAMP | - | NULL | - | 开始执行时间 |
| end_time | TIMESTAMP | - | NULL | - | 结束执行时间 |
| duration | INTEGER | - | NULL | - | 执行时长(秒) |
| stdout_log | TEXT | - | NULL | - | 标准输出日志 |
| stderr_log | TEXT | - | NULL | - | 错误输出日志 |
| exit_code | INTEGER | - | NULL | - | 退出码 |
| operator | CHARACTER | - | NOT NULL | 'system'::character | 操作人 |
| created_at | TIMESTAMP | - | NOT NULL | now() | 创建时间 |
| updated_at | TIMESTAMP | - | NOT NULL | now() | 更新时间 |

**索引/约束设计:**
- PRIMARY KEY: (id)
- INDEX: idx_exec_logs_end_time (end_time)
- INDEX: idx_exec_logs_fault_id (fault_id)
- INDEX: idx_exec_logs_start_time (start_time)
- INDEX: idx_exec_logs_status (execution_status)
#### 2.1.2 节点信息表 (nodes)
记录集群内各节点的状态信息

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
| :----- | :------- | :--- | :------ | :----- | :--- |
| id | BIGINT | - | NOT NULL | - | (PK) 主键ID |
| uuid | UUID | - | NOT NULL | - | 节点唯一标识(UUID) |
| cluster_id | BIGINT | - | NOT NULL | - | 所属集群ID |
| hostname | CHARACTER | - | NOT NULL | - | 节点主机名 |
| ip_address | INET | - | NOT NULL | - | 节点IP地址(INET, 兼容IPv4/IPv6) |
| status | CHARACTER | - | NOT NULL | 'unknown'::character | 节点健康状态(healthy/unhealthy/warning/unknown) |
| last_heartbeat | TIMESTAMP | - | NULL | - | 最后心跳时间 |
| created_at | TIMESTAMP | - | NOT NULL | now() | 创建时间 |
| updated_at | TIMESTAMP | - | NOT NULL | now() | 更新时间 |
| ssh_user | CHARACTER | - | NULL | - |  |
| ssh_password | CHARACTER | - | NULL | - |  |

**索引/约束设计:**
- PRIMARY KEY: (id)
- INDEX: idx_nodes_cluster_id (cluster_id)
- INDEX: idx_nodes_ip_address (ip_address)
- INDEX: idx_nodes_last_heartbeat (last_heartbeat)
- INDEX: idx_nodes_status (status)
- INDEX: uk_cluster_hostname (cluster_id, hostname)
- FOREIGN KEY: FK(cluster_id) -> public.clusters(id)
#### 2.1.3 系统日志表 (system_logs)
存储从Flume采集的原始日志数据

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
| :----- | :------- | :--- | :------ | :----- | :--- |
| id | BIGINT | - | NOT NULL | - | (PK) 主键ID |
| log_id | CHARACTER | - | NOT NULL | - | 日志唯一标识 |
| fault_id | CHARACTER | - | NULL | - | 关联故障标识(无外键) |
| cluster_id | BIGINT | - | NULL | - | 关联集群ID |
| host | CHARACTER | - | NOT NULL | - | 主机名 |
| service | CHARACTER | - | NOT NULL | - | 服务名 |
| source | CHARACTER | - | NULL | - | 来源 |
| log_level | CHARACTER | - | NOT NULL | - | 日志级别(DEBUG/INFO/WARN/ERROR/FATAL) |
| message | TEXT | - | NOT NULL | - | 日志消息 |
| exception | TEXT | - | NULL | - | 异常堆栈 |
| raw_log | TEXT | - | NULL | - | 原始日志内容 |
| processed | BOOLEAN | - | NOT NULL | false | 是否已处理 |
| created_at | TIMESTAMP | - | NOT NULL | now() | 创建时间 |

**索引/约束设计:**
- PRIMARY KEY: (id)
- INDEX: idx_system_logs_cluster_id (cluster_id)
- INDEX: idx_system_logs_fault_id (fault_id)
- INDEX: idx_system_logs_level (log_level)
- INDEX: idx_system_logs_processed (processed)
- INDEX: idx_system_logs_timestamp ("timestamp")
- FOREIGN KEY: FK(cluster_id) -> public.clusters(id)
#### 2.2.0 角色表 (roles)
系统角色定义

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
| :----- | :------- | :--- | :------ | :----- | :--- |
| id | BIGINT | - | NOT NULL | - | (PK) 主键ID |
| role_name | CHARACTER | - | NOT NULL | - | 角色名称 |
| role_key | CHARACTER | - | NOT NULL | - | 角色唯一标识 |
| description | CHARACTER | - | NULL | - | 角色描述 |
| is_system_role | BOOLEAN | - | NOT NULL | false | 是否为系统内置角色 |
| created_at | TIMESTAMP | - | NOT NULL | now() | 创建时间 |
| updated_at | TIMESTAMP | - | NOT NULL | now() | 更新时间 |

**索引/约束设计:**
- PRIMARY KEY: (id)
#### 2.2.1 权限表 (permissions)
系统权限定义

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
| :----- | :------- | :--- | :------ | :----- | :--- |
| id | BIGINT | - | NOT NULL | - | (PK) 主键ID |
| permission_name | CHARACTER | - | NOT NULL | - | 权限名称 |
| permission_key | CHARACTER | - | NOT NULL | - | 权限唯一标识 |
| description | CHARACTER | - | NULL | - | 权限描述 |
| created_at | TIMESTAMP | - | NOT NULL | now() | 创建时间 |

**索引/约束设计:**
- PRIMARY KEY: (id)
#### 2.2.2 角色-权限映射表 (role_permission_mapping)
多对多关系的中间表

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
| :----- | :------- | :--- | :------ | :----- | :--- |
| role_id | BIGINT | - | NOT NULL | - | (PK) 角色ID |
| permission_id | BIGINT | - | NOT NULL | - | (PK) 权限ID |

**索引/约束设计:**
- PRIMARY KEY: (role_id, permission_id)
- FOREIGN KEY: FK(permission_id) -> public.permissions(id)
- FOREIGN KEY: FK(role_id) -> public.roles(id)
#### 2.2.1 集群信息表 (clusters)
存储用户管理的集群信息

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
| :----- | :------- | :--- | :------ | :----- | :--- |
| id | BIGINT | - | NOT NULL | - | (PK) 主键ID |
| uuid | UUID | - | NOT NULL | - | 集群唯一标识(UUID) |
| name | CHARACTER | - | NOT NULL | - | 集群名称 |
| type | CHARACTER | - | NOT NULL | - | 集群类型 |
| node_count | INTEGER | - | NOT NULL | 0 | 集群节点数量 |
| health_status | CHARACTER | - | NOT NULL | 'unknown'::character | 集群健康状态(healthy/warning/error/unknown) |
| description | TEXT | - | NULL | - | 集群描述 |
| config_info | JSONB | - | NULL | - | 集群配置信息(JSONB) |
| created_at | TIMESTAMP | - | NOT NULL | now() | 创建时间 |
| updated_at | TIMESTAMP | - | NOT NULL | now() | 更新时间 |
| namenode_ip | INET | - | NULL | - |  |
| namenode_psw | CHARACTER | - | NULL | - |  |
| rm_ip | INET | - | NULL | - |  |
| rm_psw | CHARACTER | - | NULL | - |  |

**索引/约束设计:**
- PRIMARY KEY: (id)
#### 2.2.2 用户与集群映射表 (user_cluster_mapping)
管理用户和集群的多对多关系

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
| :----- | :------- | :--- | :------ | :----- | :--- |
| id | BIGINT | - | NOT NULL | - | (PK) 主键ID |
| user_id | BIGINT | - | NOT NULL | - | 用户ID |
| cluster_id | BIGINT | - | NOT NULL | - | 集群ID |
| role_id | BIGINT | - | NOT NULL | - | 角色ID |
| created_at | TIMESTAMP | - | NOT NULL | now() | 创建时间 |

**索引/约束设计:**
- PRIMARY KEY: (id)
- FOREIGN KEY: FK(cluster_id) -> public.clusters(id)
- FOREIGN KEY: FK(role_id) -> public.roles(id)
- FOREIGN KEY: FK(user_id) -> public.users(id)
#### 2.2.3 应用统一配置表 (app_configurations)
统一管理系统配置、告警规则和通知设置

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
| :----- | :------- | :--- | :------ | :----- | :--- |
| id | BIGINT | - | NOT NULL | - | (PK) 主键ID |
| config_type | CHARACTER | - | NOT NULL | - | 配置类型(system/alert_rule/notification/llm) |
| config_key | CHARACTER | - | NOT NULL | - | 配置键 |
| config_value | JSONB | - | NOT NULL | - | 配置值(JSONB) |
| description | CHARACTER | - | NULL | - | 配置描述 |
| is_enabled | BOOLEAN | - | NOT NULL | true | 是否启用 |
| created_at | TIMESTAMP | - | NOT NULL | now() | 创建时间 |
| updated_at | TIMESTAMP | - | NOT NULL | now() | 更新时间 |

**索引/约束设计:**
- PRIMARY KEY: (id)
- INDEX: idx_app_config_enabled (is_enabled)
#### 2.2.4 用户表 (users)
系统用户信息

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
| :----- | :------- | :--- | :------ | :----- | :--- |
| id | BIGINT | - | NOT NULL | - | (PK) 主键ID |
| username | CHARACTER | - | NOT NULL | - | 用户名 |
| email | CHARACTER | - | NOT NULL | - | 邮箱 |
| password_hash | CHARACTER | - | NOT NULL | - | 密码哈希 |
| full_name | CHARACTER | - | NOT NULL | - | 姓名 |
| is_active | BOOLEAN | - | NOT NULL | true | 是否激活 |
| last_login | TIMESTAMP | - | NULL | - | 最后登录时间 |
| created_at | TIMESTAMP | - | NOT NULL | now() | 创建时间 |
| updated_at | TIMESTAMP | - | NOT NULL | now() | 更新时间 |

**索引/约束设计:**
- PRIMARY KEY: (id)
#### 2.2.5 用户-角色映射表 (user_role_mapping)
用户与角色的多对多关系

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
| :----- | :------- | :--- | :------ | :----- | :--- |
| user_id | BIGINT | - | NOT NULL | - | (PK) 用户ID |
| role_id | BIGINT | - | NOT NULL | - | (PK) 角色ID |

**索引/约束设计:**
- PRIMARY KEY: (user_id, role_id)
- FOREIGN KEY: FK(role_id) -> public.roles(id)
- FOREIGN KEY: FK(user_id) -> public.users(id)
#### 2.2.6 操作审计表 (audit_logs)
记录用户操作审计日志

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
| :----- | :------- | :--- | :------ | :----- | :--- |
| id | BIGINT | - | NOT NULL | - | (PK) 主键ID |
| user_id | BIGINT | - | NULL | - | 用户ID |
| cluster_id | BIGINT | - | NULL | - | 集群ID |
| role_id | BIGINT | - | NULL | - | 角色ID |
| username | CHARACTER | - | NOT NULL | - | 用户名 |
| action | CHARACTER | - | NOT NULL | - | 操作动作 |
| resource_type | CHARACTER | - | NOT NULL | - | 资源类型 |
| resource_id | CHARACTER | - | NULL | - | 资源ID |
| ip_address | INET | - | NOT NULL | - | 请求来源IP(INET, 兼容IPv4/IPv6) |
| request_data | JSONB | - | NULL | - | 请求数据(JSONB) |
| response_status | INTEGER | - | NULL | - | 响应状态码 |
| created_at | TIMESTAMP | - | NOT NULL | now() | 创建时间 |

**索引/约束设计:**
- PRIMARY KEY: (id)
- INDEX: idx_audit_logs_action (action)
- INDEX: idx_audit_logs_cluster_id (cluster_id)
- INDEX: idx_audit_logs_created_at (created_at)
- INDEX: idx_audit_logs_role_id (role_id)
- INDEX: idx_audit_logs_user_id (user_id)
- FOREIGN KEY: FK(cluster_id) -> public.clusters(id)
- FOREIGN KEY: FK(role_id) -> public.roles(id)
- FOREIGN KEY: FK(user_id) -> public.users(id)
#### 2.3.1 修复脚本模板表 (repair_templates)
存储用于自动修复的脚本模板

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
| :----- | :------- | :--- | :------ | :----- | :--- |
| id | BIGINT | - | NOT NULL | - | (PK) 主键ID |
| template_name | CHARACTER | - | NOT NULL | - | 模板名称 |
| fault_type | CHARACTER | - | NOT NULL | - | 适用故障类型 |
| script_content | TEXT | - | NOT NULL | - | 脚本内容 |
| risk_level | CHARACTER | - | NOT NULL | 'medium'::character | 风险级别(low/medium/high) |
| description | TEXT | - | NULL | - | 模板描述 |
| parameters | JSONB | - | NULL | - | 模板参数定义(JSONB) |
| created_by | CHARACTER | - | NULL | - | 创建人 |
| created_at | TIMESTAMP | - | NOT NULL | now() | 创建时间 |
| updated_at | TIMESTAMP | - | NOT NULL | now() | 更新时间 |

**索引/约束设计:**
- PRIMARY KEY: (id)
- INDEX: idx_repair_templates_fault_type (fault_type)
