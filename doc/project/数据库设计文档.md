# 故障检测系统数据库设计文档

<style>
/* 统一本文件所有表格列宽与对齐 */
table {
  width: 100%;
  table-layout: fixed; /* 固定布局，列宽按百分比分配 */
  border-collapse: collapse;
}
table th, table td {
  text-align: left; /* 每一列首部对齐（左对齐） */
  vertical-align: top; /* 条目从上到下对齐 */
}
/* 六列宽度统一为固定比例，确保从上到下列宽一致 */
table th:nth-child(1), table td:nth-child(1) { width: 16%; }
table th:nth-child(2), table td:nth-child(2) { width: 16%; }
table th:nth-child(3), table td:nth-child(3) { width: 8%; }
table th:nth-child(4), table td:nth-child(4) { width: 12%; }
table th:nth-child(5), table td:nth-child(5) { width: 12%; }
table th:nth-child(6), table td:nth-child(6) { width: 36%; }
</style>

## 1. 数据库概述

### 1.1 设计目标
- 支持Hadoop集群故障检测与自动修复系统
- 提供高效的日志存储和查询能力
- 支持故障记录、执行日志、集群状态等核心业务数据
- 确保数据一致性和系统性能

### 1.2 技术选型
- **数据库**: MySQL 8.0+
- **存储引擎**: InnoDB
- **字符集**: utf8mb4
- **排序规则**: utf8mb4_unicode_ci

### 1.3 命名规范
- 表名：小写字母+下划线，复数形式
- 字段名：小写字母+下划线
- 索引名：idx_表名_字段名
- 外键名：fk_表名_字段名

## 2. 数据库结构设计

### 2.1 核心业务表

#### 2.1.1 故障记录表 (fault_records)
存储系统检测到的所有故障信息

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
| :----- | :------- | :--- | :------ | :----- | :--- |
| id | BIGINT | - | NOT NULL | AUTO_INCREMENT | 主键ID |
| fault_id | VARCHAR | 32 | NOT NULL | - | 故障唯一标识 |
| fault_type | VARCHAR | 50 | NOT NULL | - | 故障类型 |
| fault_level | ENUM | - | NOT NULL | 'medium' | 故障级别(low/medium/high/critical) |
| title | VARCHAR | 200 | NOT NULL | - | 故障标题 |
| description | TEXT | - | NULL | - | 故障详细描述 |
| affected_nodes | JSON | - | NULL | - | 受影响的节点列表 |
| root_cause | TEXT | - | NULL | - | 根本原因分析 |
| repair_suggestion | TEXT | - | NULL | - | 修复建议 |
| status | ENUM | - | NOT NULL | 'detected' | 状态(detected/analyzing/repairing/resolved/failed) |
| assignee | VARCHAR | 50 | NULL | - | 负责人 |
| reporter | VARCHAR | 50 | NULL | 'system' | 报告人 |
| created_at | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |
| resolved_at | TIMESTAMP | - | NULL | - | 解决时间 |

**索引设计:**
- PRIMARY KEY (id)
- UNIQUE KEY uk_fault_id (fault_id)
- KEY idx_fault_type (fault_type)
- KEY idx_status (status)
- KEY idx_created_at (created_at)

#### 2.1.2 执行日志表 (exec_logs)
记录自动修复脚本的执行过程和结果

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
| :----- | :------- | :--- | :------ | :----- | :--- |
| id | BIGINT | - | NOT NULL | AUTO_INCREMENT | 主键ID |
| exec_id | VARCHAR | 32 | NOT NULL | - | 执行唯一标识 |
| fault_id | VARCHAR | 32 | NOT NULL | - | 关联故障ID |
| command_type | VARCHAR | 50 | NOT NULL | - | 命令类型 |
| script_path | VARCHAR | 255 | NULL | - | 脚本路径 |
| command_content | TEXT | - | NOT NULL | - | 执行的命令内容 |
| target_nodes | JSON | - | NULL | - | 目标执行节点 |
| risk_level | ENUM | - | NOT NULL | 'medium' | 风险级别(low/medium/high) |
| execution_status | ENUM | - | NOT NULL | 'pending' | 执行状态(pending/running/success/failed/timeout) |
| start_time | TIMESTAMP | - | NULL | - | 开始执行时间 |
| end_time | TIMESTAMP | - | NULL | - | 结束执行时间 |
| duration | INT | - | NULL | - | 执行时长(秒) |
| stdout_log | LONGTEXT | - | NULL | - | 标准输出日志 |
| stderr_log | LONGTEXT | - | NULL | - | 错误输出日志 |
| exit_code | INT | - | NULL | - | 退出码 |
| operator | VARCHAR | 50 | NULL | 'system' | 操作人 |
| created_at | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**索引设计:**
- PRIMARY KEY (id)
- UNIQUE KEY uk_exec_id (exec_id)
- KEY idx_fault_id (fault_id)
- KEY idx_execution_status (execution_status)

#### 2.1.3 集群状态表 (cluster_status)
记录Hadoop集群各节点的实时状态信息

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
| :----- | :------- | :--- | :------ | :----- | :--- |
| id | BIGINT | - | NOT NULL | AUTO_INCREMENT | 主键ID |
| node_id | VARCHAR | 50 | NOT NULL | - | 节点标识 |
| node_name | VARCHAR | 100 | NOT NULL | - | 节点名称 |
| ip_address | VARCHAR | 15 | NOT NULL | - | IP地址 |
| node_role | ENUM | - | NOT NULL | - | 节点角色(NameNode/DataNode/ResourceManager/NodeManager) |
| node_status | ENUM | - | NOT NULL | 'unknown' | 节点状态(online/offline/maintenance/unknown) |
| cpu_usage | DECIMAL | 5,2 | NULL | - | CPU使用率(%) |
| memory_usage | DECIMAL | 5,2 | NULL | - | 内存使用率(%) |
| disk_usage | DECIMAL | 5,2 | NULL | - | 磁盘使用率(%) |
| health_score | INT | - | NULL | 100 | 健康评分(0-100) |
| last_heartbeat | TIMESTAMP | - | NULL | - | 最后心跳时间 |
| created_at | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**索引设计:**
- PRIMARY KEY (id)
- UNIQUE KEY uk_node_id (node_id)
- KEY idx_node_status (node_status)
- KEY idx_last_heartbeat (last_heartbeat)

#### 2.1.4 系统日志表 (system_logs)
存储从Flume采集的原始日志数据

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
| :----- | :------- | :--- | :------ | :----- | :--- |
| id | BIGINT | - | NOT NULL | AUTO_INCREMENT | 主键ID |
| log_id | VARCHAR | 32 | NOT NULL | - | 日志唯一标识 |
| fault_id | VARCHAR | 32 | NULL | - | 关联故障ID |
| timestamp | TIMESTAMP | - | NOT NULL | - | 日志时间戳 |
| host | VARCHAR | 100 | NOT NULL | - | 主机名 |
| service | VARCHAR | 50 | NOT NULL | - | 服务名 |
| log_level | ENUM | - | NOT NULL | - | 日志级别(DEBUG/INFO/WARN/ERROR/FATAL) |
| message | LONGTEXT | - | NOT NULL | - | 日志消息 |
| exception | LONGTEXT | - | NULL | - | 异常堆栈 |
| raw_log | LONGTEXT | - | NULL | - | 原始日志内容 |
| processed | BOOLEAN | - | NOT NULL | FALSE | 是否已处理 |
| created_at | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |

**索引设计:**
- PRIMARY KEY (id)
- UNIQUE KEY uk_log_id (log_id)
- KEY idx_fault_id (fault_id)
- KEY idx_timestamp (timestamp)
- KEY idx_log_level (log_level)

### 2.2 配置管理与用户表

#### 2.2.1 应用统一配置表 (app_configurations)
统一管理系统配置、告警规则和通知设置

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
| :----- | :------- | :--- | :------ | :----- | :--- |
| id | BIGINT | - | NOT NULL | AUTO_INCREMENT | 主键ID |
| config_type | ENUM | - | NOT NULL | - | 配置类型(system/alert_rule/notification/llm) |
| config_key | VARCHAR | 100 | NOT NULL | - | 配置键 |
| config_value | JSON | - | NOT NULL | - | 配置值 (JSON格式) |
| description | VARCHAR | 500 | NULL | - | 配置描述 |
| is_enabled | BOOLEAN | - | NOT NULL | TRUE | 是否启用 |
| created_at | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**索引设计:**
- PRIMARY KEY (id)
- UNIQUE KEY uk_config_type_key (config_type, config_key)
- KEY idx_is_enabled (is_enabled)

#### 2.2.2 用户表 (users)
系统用户信息

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
| :----- | :------- | :--- | :------ | :----- | :--- |
| id | BIGINT | - | NOT NULL | AUTO_INCREMENT | 主键ID |
| username | VARCHAR | 50 | NOT NULL | - | 用户名 |
| email | VARCHAR | 100 | NOT NULL | - | 邮箱 |
| password_hash | VARCHAR | 255 | NOT NULL | - | 密码哈希 |
| full_name | VARCHAR | 100 | NOT NULL | - | 姓名 |
| role | ENUM | - | NOT NULL | 'operator' | 角色(admin/operator/viewer) |
| is_active | BOOLEAN | - | NOT NULL | TRUE | 是否激活 |
| last_login | TIMESTAMP | - | NULL | - | 最后登录时间 |
| created_at | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**索引设计:**
- PRIMARY KEY (id)
- UNIQUE KEY uk_username (username)
- UNIQUE KEY uk_email (email)

#### 2.2.3 操作审计表 (audit_logs)
记录用户操作审计日志

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
| :----- | :------- | :--- | :------ | :----- | :--- |
| id | BIGINT | - | NOT NULL | AUTO_INCREMENT | 主键ID |
| user_id | BIGINT | - | NULL | - | 用户ID |
| username | VARCHAR | 50 | NOT NULL | - | 用户名 |
| action | VARCHAR | 100 | NOT NULL | - | 操作动作 |
| resource_type | VARCHAR | 50 | NOT NULL | - | 资源类型 |
| resource_id | VARCHAR | 100 | NULL | - | 资源ID |
| ip_address | VARCHAR | 15 | NOT NULL | - | IP地址 |
| request_data | JSON | - | NULL | - | 请求数据 |
| response_status | INT | - | NULL | - | 响应状态码 |
| created_at | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |

**索引设计:**
- PRIMARY KEY (id)
- KEY idx_user_id (user_id)
- KEY idx_action (action)
- KEY idx_created_at (created_at)

### 2.3 扩展表

#### 2.3.1 修复脚本模板表 (repair_templates)
存储用于自动修复的脚本模板

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
| :----- | :------- | :--- | :------ | :----- | :--- |
| id | BIGINT | - | NOT NULL | AUTO_INCREMENT | 主键ID |
| template_name | VARCHAR | 100 | NOT NULL | - | 模板名称 |
| fault_type | VARCHAR | 50 | NOT NULL | - | 适用故障类型 |
| script_content | TEXT | - | NOT NULL | - | 脚本内容 |
| risk_level | ENUM | - | NOT NULL | 'medium' | 风险级别(low/medium/high) |
| description | TEXT | - | NULL | - | 模板描述 |
| parameters | JSON | - | NULL | - | 参数定义 |
| created_by | VARCHAR | 50 | NULL | - | 创建人 |
| created_at | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**索引设计:**
- PRIMARY KEY (id)
- UNIQUE KEY uk_template_name (template_name)
- KEY idx_fault_type (fault_type)

## 3. 表关系设计

### 3.1 外键关系
```sql
-- 执行日志表关联故障记录表
ALTER TABLE exec_logs 
ADD CONSTRAINT fk_exec_logs_fault_id 
FOREIGN KEY (fault_id) REFERENCES fault_records(fault_id) 
ON DELETE CASCADE ON UPDATE CASCADE;

-- 系统日志表关联故障记录表
ALTER TABLE system_logs
ADD CONSTRAINT fk_system_logs_fault_id
FOREIGN KEY (fault_id) REFERENCES fault_records(fault_id)
ON DELETE SET NULL ON UPDATE CASCADE;

-- 审计日志表关联用户表
ALTER TABLE audit_logs 
ADD CONSTRAINT fk_audit_logs_user_id 
FOREIGN KEY (user_id) REFERENCES users(id) 
ON DELETE SET NULL ON UPDATE CASCADE;
```

### 3.2 关系说明
- **fault_records** ↔ **exec_logs**: 一对多关系，一个故障可能有多次修复执行记录。
- **fault_records** ↔ **system_logs**: 一对多关系（可选），一个故障可能关联多条系统日志。
- **users** ↔ **audit_logs**: 一对多关系，一个用户可能有多条操作审计记录。
- **cluster_status**: 独立表，记录集群节点状态。
- **app_configurations**: 独立表，统一管理所有配置。
- **repair_templates**: 独立表，存储修复脚本模板。

## 4. 数据库初始化脚本

### 4.1 创建数据库
```sql
CREATE DATABASE hadoop_fault_db 
CHARACTER SET utf8mb4 
COLLATE utf8mb4_unicode_ci;

USE hadoop_fault_db;
```

### 4.2 创建表结构
(此处省略，详见 `数据库建表脚本.sql` 文件)

## 5. 性能优化建议

### 5.1 分区策略
- **system_logs**: 按时间分区，每月一个分区。
- **audit_logs**: 按时间分区，每季度一个分区。

### 5.2 索引优化
- 为高频查询字段创建复合索引。
- 定期分析索引使用情况，删除无用索引。
- 对大表考虑使用分区索引。

### 5.3 数据归档
- `system_logs` 表数据保留3个月，超期数据归档到历史表。
- `audit_logs` 表数据保留1年。
- 定期清理临时数据和过期缓存。

## 6. 备份与恢复策略

### 6.1 备份策略
- 每日全量备份。
- 每小时增量备份。
- 重要操作前手动备份。

### 6.2 恢复测试
- 每月进行备份恢复测试。
- 制定灾难恢复预案。
- 建立数据恢复SOP。

## 7. 监控与维护

### 7.1 性能监控
- 监控慢查询日志。
- 跟踪表空间使用情况。
- 监控连接数和锁等待。

### 7.2 定期维护
- 每周执行表优化。
- 定期更新表统计信息。
- 监控磁盘空间使用情况。