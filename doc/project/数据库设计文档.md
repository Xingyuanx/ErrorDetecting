# 故障检测系统数据库设计文档

<style>
/* 统一本文件所有表格列宽与对齐 */
table {
  width: 100%;
  table-layout: fixed; /* 固定布局，列宽按百分比分配 */
  border-collapse: collapse;
}
table th, table td {
  text-align: left; /* 每一列首部对齐（左对齐） */
  vertical-align: top; /* 条目从上到下对齐 */
}
/* 六列宽度统一为固定比例，确保从上到下列宽一致 */
table th:nth-child(1), table td:nth-child(1) { width: 16%; }
table th:nth-child(2), table td:nth-child(2) { width: 16%; }
table th:nth-child(3), table td:nth-child(3) { width: 8%; }
table th:nth-child(4), table td:nth-child(4) { width: 12%; }
table th:nth-child(5), table td:nth-child(5) { width: 12%; }
table th:nth-child(6), table td:nth-child(6) { width: 36%; }
</style>

## 1. 数据库概述

### 1.1 设计目标
- 支持Hadoop集群故障检测与自动修复系统
- 提供高效的日志存储和查询能力
- 支持故障记录、执行日志、集群状态等核心业务数据
- 确保数据一致性和系统性能

### 1.2 技术选型
- **数据库**: MySQL 8.0+
- **存储引擎**: InnoDB
- **字符集**: utf8mb4
- **排序规则**: utf8mb4_unicode_ci

### 1.3 命名规范
- 表名：小写字母+下划线，复数形式
- 字段名：小写字母+下划线
- 索引名：idx_表名_字段名
- 外键名：fk_表名_字段名

## 2. 数据库结构设计

### 2.1 核心业务表

#### 2.1.1 故障记录表 (fault_records)
存储系统检测到的所有故障信息

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
| :----- | :------- | :--- | :------ | :----- | :--- |
| id | BIGINT | - | NOT NULL | AUTO_INCREMENT | 主键ID |
| fault_id | VARCHAR | 32 | NOT NULL | - | 故障唯一标识 |
| fault_type | VARCHAR | 50 | NOT NULL | - | 故障类型(DataNode离线/磁盘不足等) |
| fault_level | ENUM | - | NOT NULL | 'medium' | 故障级别(low/medium/high/critical) |
| title | VARCHAR | 200 | NOT NULL | - | 故障标题 |
| description | TEXT | - | NULL | - | 故障详细描述 |
| affected_nodes | JSON | - | NULL | - | 受影响的节点列表 |
| source_logs | JSON | - | NULL | - | 相关日志ID列表 |
| root_cause | TEXT | - | NULL | - | 根本原因分析 |
| repair_suggestion | TEXT | - | NULL | - | 修复建议 |
| status | ENUM | - | NOT NULL | 'detected' | 状态(detected/analyzing/repairing/resolved/failed) |
| assignee | VARCHAR | 50 | NULL | - | 负责人 |
| reporter | VARCHAR | 50 | NULL | 'system' | 报告人 |
| created_at | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |
| resolved_at | TIMESTAMP | - | NULL | - | 解决时间 |

**索引设计:**
- PRIMARY KEY (id)
- UNIQUE KEY uk_fault_id (fault_id)
- KEY idx_fault_type (fault_type)
- KEY idx_fault_level (fault_level)
- KEY idx_status (status)
- KEY idx_created_at (created_at)
- KEY idx_assignee (assignee)

#### 2.1.2 执行日志表 (exec_logs)
记录自动修复脚本的执行过程和结果

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
| :----- | :------- | :--- | :------ | :----- | :--- |
| id | BIGINT | - | NOT NULL | AUTO_INCREMENT | 主键ID |
| exec_id | VARCHAR | 32 | NOT NULL | - | 执行唯一标识 |
| fault_id | VARCHAR | 32 | NOT NULL | - | 关联故障ID |
| command_type | VARCHAR | 50 | NOT NULL | - | 命令类型(restart/repair/check等) |
| script_path | VARCHAR | 255 | NULL | - | 脚本路径 |
| command_content | TEXT | - | NOT NULL | - | 执行的命令内容 |
| target_nodes | JSON | - | NULL | - | 目标执行节点 |
| risk_level | ENUM | - | NOT NULL | 'medium' | 风险级别(low/medium/high) |
| execution_status | ENUM | - | NOT NULL | 'pending' | 执行状态(pending/running/success/failed/timeout) |
| start_time | TIMESTAMP | - | NULL | - | 开始执行时间 |
| end_time | TIMESTAMP | - | NULL | - | 结束执行时间 |
| duration | INT | - | NULL | - | 执行时长(秒) |
| stdout_log | LONGTEXT | - | NULL | - | 标准输出日志 |
| stderr_log | LONGTEXT | - | NULL | - | 错误输出日志 |
| exit_code | INT | - | NULL | - | 退出码 |
| operator | VARCHAR | 50 | NULL | 'system' | 操作人 |
| created_at | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**索引设计:**
- PRIMARY KEY (id)
- UNIQUE KEY uk_exec_id (exec_id)
- KEY idx_fault_id (fault_id)
- KEY idx_execution_status (execution_status)
- KEY idx_start_time (start_time)
- KEY idx_operator (operator)

#### 2.1.3 集群状态表 (cluster_status)
记录Hadoop集群各节点的实时状态信息

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
| :----- | :------- | :--- | :------ | :----- | :--- |
| id | BIGINT | - | NOT NULL | AUTO_INCREMENT | 主键ID |
| node_id | VARCHAR | 50 | NOT NULL | - | 节点标识 |
| node_name | VARCHAR | 100 | NOT NULL | - | 节点名称 |
| ip_address | VARCHAR | 15 | NOT NULL | - | IP地址 |
| node_role | ENUM | - | NOT NULL | - | 节点角色(NameNode/DataNode/ResourceManager/NodeManager) |
| node_status | ENUM | - | NOT NULL | 'unknown' | 节点状态(online/offline/maintenance/unknown) |
| cpu_usage | DECIMAL | 5,2 | NULL | - | CPU使用率(%) |
| memory_usage | DECIMAL | 5,2 | NULL | - | 内存使用率(%) |
| disk_usage | DECIMAL | 5,2 | NULL | - | 磁盘使用率(%) |
| network_io | BIGINT | - | NULL | - | 网络IO(bytes/s) |
| disk_io | BIGINT | - | NULL | - | 磁盘IO(bytes/s) |
| load_average | DECIMAL | 5,2 | NULL | - | 系统负载 |
| uptime | BIGINT | - | NULL | - | 运行时间(秒) |
| last_heartbeat | TIMESTAMP | - | NULL | - | 最后心跳时间 |
| health_score | INT | - | NULL | 100 | 健康评分(0-100) |
| alerts_count | INT | - | NOT NULL | 0 | 告警数量 |
| created_at | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**索引设计:**
- PRIMARY KEY (id)
- UNIQUE KEY uk_node_id (node_id)
- KEY idx_node_role (node_role)
- KEY idx_node_status (node_status)
- KEY idx_last_heartbeat (last_heartbeat)
- KEY idx_health_score (health_score)

#### 2.1.4 系统日志表 (system_logs)
存储从Flume采集的原始日志数据

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
| :----- | :------- | :--- | :------ | :----- | :--- |
| id | BIGINT | - | NOT NULL | AUTO_INCREMENT | 主键ID |
| log_id | VARCHAR | 32 | NOT NULL | - | 日志唯一标识 |
| timestamp | TIMESTAMP | - | NOT NULL | - | 日志时间戳 |
| host | VARCHAR | 100 | NOT NULL | - | 主机名 |
| ip_address | VARCHAR | 15 | NOT NULL | - | IP地址 |
| service | VARCHAR | 50 | NOT NULL | - | 服务名(HDFS/YARN/MapReduce等) |
| component | VARCHAR | 50 | NULL | - | 组件名 |
| log_level | ENUM | - | NOT NULL | - | 日志级别(DEBUG/INFO/WARN/ERROR/FATAL) |
| thread | VARCHAR | 100 | NULL | - | 线程名 |
| logger | VARCHAR | 200 | NULL | - | Logger名称 |
| message | LONGTEXT | - | NOT NULL | - | 日志消息 |
| exception | LONGTEXT | - | NULL | - | 异常堆栈 |
| raw_log | LONGTEXT | - | NULL | - | 原始日志内容 |
| tags | JSON | - | NULL | - | 标签信息 |
| processed | BOOLEAN | - | NOT NULL | FALSE | 是否已处理 |
| created_at | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |

**索引设计:**
- PRIMARY KEY (id)
- UNIQUE KEY uk_log_id (log_id)
- KEY idx_timestamp (timestamp)
- KEY idx_host (host)
- KEY idx_service (service)
- KEY idx_log_level (log_level)
- KEY idx_processed (processed)
- KEY idx_timestamp_level (timestamp, log_level)

### 2.2 配置管理表

#### 2.2.1 系统配置表 (system_configs)
存储系统配置参数

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
| :----- | :------- | :--- | :------ | :----- | :--- |
| id | BIGINT | - | NOT NULL | AUTO_INCREMENT | 主键ID |
| config_key | VARCHAR | 100 | NOT NULL | - | 配置键 |
| config_value | TEXT | - | NULL | - | 配置值 |
| config_type | VARCHAR | 20 | NOT NULL | 'string' | 配置类型(string/int/boolean/json) |
| category | VARCHAR | 50 | NOT NULL | - | 配置分类 |
| description | VARCHAR | 500 | NULL | - | 配置描述 |
| is_active | BOOLEAN | - | NOT NULL | TRUE | 是否启用 |
| created_at | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**索引设计:**
- PRIMARY KEY (id)
- UNIQUE KEY uk_config_key (config_key)
- KEY idx_category (category)
- KEY idx_is_active (is_active)

#### 2.2.2 告警规则表 (alert_rules)
定义各种告警规则和阈值

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
| :----- | :------- | :--- | :------ | :----- | :--- |
| id | BIGINT | - | NOT NULL | AUTO_INCREMENT | 主键ID |
| rule_name | VARCHAR | 100 | NOT NULL | - | 规则名称 |
| rule_type | VARCHAR | 50 | NOT NULL | - | 规则类型(threshold/pattern/anomaly) |
| metric_name | VARCHAR | 100 | NOT NULL | - | 监控指标名 |
| condition_expr | TEXT | - | NOT NULL | - | 条件表达式 |
| threshold_value | DECIMAL | 10,2 | NULL | - | 阈值 |
| severity | ENUM | - | NOT NULL | 'medium' | 严重级别(low/medium/high/critical) |
| description | TEXT | - | NULL | - | 规则描述 |
| is_enabled | BOOLEAN | - | NOT NULL | TRUE | 是否启用 |
| created_at | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**索引设计:**
- PRIMARY KEY (id)
- KEY idx_rule_type (rule_type)
- KEY idx_metric_name (metric_name)
- KEY idx_severity (severity)
- KEY idx_is_enabled (is_enabled)

### 2.3 用户管理表

#### 2.3.1 用户表 (users)
系统用户信息

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
| :----- | :------- | :--- | :------ | :----- | :--- |
| id | BIGINT | - | NOT NULL | AUTO_INCREMENT | 主键ID |
| username | VARCHAR | 50 | NOT NULL | - | 用户名 |
| email | VARCHAR | 100 | NOT NULL | - | 邮箱 |
| password_hash | VARCHAR | 255 | NOT NULL | - | 密码哈希 |
| full_name | VARCHAR | 100 | NOT NULL | - | 姓名 |
| role | ENUM | - | NOT NULL | 'operator' | 角色(admin/operator/viewer) |
| department | VARCHAR | 100 | NULL | - | 部门 |
| phone | VARCHAR | 20 | NULL | - | 电话 |
| is_active | BOOLEAN | - | NOT NULL | TRUE | 是否激活 |
| last_login | TIMESTAMP | - | NULL | - | 最后登录时间 |
| created_at | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**索引设计:**
- PRIMARY KEY (id)
- UNIQUE KEY uk_username (username)
- UNIQUE KEY uk_email (email)
- KEY idx_role (role)
- KEY idx_is_active (is_active)

#### 2.3.2 操作审计表 (audit_logs)
记录用户操作审计日志

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
| :----- | :------- | :--- | :------ | :----- | :--- |
| id | BIGINT | - | NOT NULL | AUTO_INCREMENT | 主键ID |
| user_id | BIGINT | - | NULL | - | 用户ID |
| username | VARCHAR | 50 | NOT NULL | - | 用户名 |
| action | VARCHAR | 100 | NOT NULL | - | 操作动作 |
| resource_type | VARCHAR | 50 | NOT NULL | - | 资源类型 |
| resource_id | VARCHAR | 100 | NULL | - | 资源ID |
| ip_address | VARCHAR | 15 | NOT NULL | - | IP地址 |
| user_agent | TEXT | - | NULL | - | 用户代理 |
| request_data | JSON | - | NULL | - | 请求数据 |
| response_status | INT | - | NULL | - | 响应状态码 |
| created_at | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |

**索引设计:**
- PRIMARY KEY (id)
- KEY idx_user_id (user_id)
- KEY idx_username (username)
- KEY idx_action (action)
- KEY idx_created_at (created_at)

## 3. 表关系设计

### 3.1 外键关系
```sql
-- 执行日志表关联故障记录表
ALTER TABLE exec_logs 
ADD CONSTRAINT fk_exec_logs_fault_id 
FOREIGN KEY (fault_id) REFERENCES fault_records(fault_id) 
ON DELETE CASCADE ON UPDATE CASCADE;

-- 审计日志表关联用户表
ALTER TABLE audit_logs 
ADD CONSTRAINT fk_audit_logs_user_id 
FOREIGN KEY (user_id) REFERENCES users(id) 
ON DELETE SET NULL ON UPDATE CASCADE;
```

### 3.2 关系说明
- **fault_records** ↔ **exec_logs**: 一对多关系，一个故障可能有多次修复执行记录
- **users** ↔ **audit_logs**: 一对多关系，一个用户可能有多条操作审计记录
- **cluster_status**: 独立表，记录集群节点状态
- **system_logs**: 独立表，存储原始日志数据

## 4. 数据库初始化脚本

### 4.1 创建数据库
```sql
CREATE DATABASE hadoop_fault_db 
CHARACTER SET utf8mb4 
COLLATE utf8mb4_unicode_ci;

USE hadoop_fault_db;
```

### 4.2 创建表结构
```sql
-- 故障记录表
CREATE TABLE fault_records (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    fault_id VARCHAR(32) NOT NULL UNIQUE,
    fault_type VARCHAR(50) NOT NULL,
    fault_level ENUM('low', 'medium', 'high', 'critical') NOT NULL DEFAULT 'medium',
    title VARCHAR(200) NOT NULL,
    description TEXT,
    affected_nodes JSON,
    source_logs JSON,
    root_cause TEXT,
    repair_suggestion TEXT,
    status ENUM('detected', 'analyzing', 'repairing', 'resolved', 'failed') NOT NULL DEFAULT 'detected',
    assignee VARCHAR(50),
    reporter VARCHAR(50) DEFAULT 'system',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    resolved_at TIMESTAMP NULL,
    
    INDEX idx_fault_type (fault_type),
    INDEX idx_fault_level (fault_level),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at),
    INDEX idx_assignee (assignee)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 执行日志表
CREATE TABLE exec_logs (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    exec_id VARCHAR(32) NOT NULL UNIQUE,
    fault_id VARCHAR(32) NOT NULL,
    command_type VARCHAR(50) NOT NULL,
    script_path VARCHAR(255),
    command_content TEXT NOT NULL,
    target_nodes JSON,
    risk_level ENUM('low', 'medium', 'high') NOT NULL DEFAULT 'medium',
    execution_status ENUM('pending', 'running', 'success', 'failed', 'timeout') NOT NULL DEFAULT 'pending',
    start_time TIMESTAMP NULL,
    end_time TIMESTAMP NULL,
    duration INT,
    stdout_log LONGTEXT,
    stderr_log LONGTEXT,
    exit_code INT,
    operator VARCHAR(50) DEFAULT 'system',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_fault_id (fault_id),
    INDEX idx_execution_status (execution_status),
    INDEX idx_start_time (start_time),
    INDEX idx_operator (operator)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 集群状态表
CREATE TABLE cluster_status (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    node_id VARCHAR(50) NOT NULL UNIQUE,
    node_name VARCHAR(100) NOT NULL,
    ip_address VARCHAR(15) NOT NULL,
    node_role ENUM('NameNode', 'DataNode', 'ResourceManager', 'NodeManager') NOT NULL,
    node_status ENUM('online', 'offline', 'maintenance', 'unknown') NOT NULL DEFAULT 'unknown',
    cpu_usage DECIMAL(5,2),
    memory_usage DECIMAL(5,2),
    disk_usage DECIMAL(5,2),
    network_io BIGINT,
    disk_io BIGINT,
    load_average DECIMAL(5,2),
    uptime BIGINT,
    last_heartbeat TIMESTAMP,
    health_score INT DEFAULT 100,
    alerts_count INT NOT NULL DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_node_role (node_role),
    INDEX idx_node_status (node_status),
    INDEX idx_last_heartbeat (last_heartbeat),
    INDEX idx_health_score (health_score)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 系统日志表
CREATE TABLE system_logs (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    log_id VARCHAR(32) NOT NULL UNIQUE,
    timestamp TIMESTAMP NOT NULL,
    host VARCHAR(100) NOT NULL,
    ip_address VARCHAR(15) NOT NULL,
    service VARCHAR(50) NOT NULL,
    component VARCHAR(50),
    log_level ENUM('DEBUG', 'INFO', 'WARN', 'ERROR', 'FATAL') NOT NULL,
    thread VARCHAR(100),
    logger VARCHAR(200),
    message LONGTEXT NOT NULL,
    exception LONGTEXT,
    raw_log LONGTEXT,
    tags JSON,
    processed BOOLEAN NOT NULL DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_timestamp (timestamp),
    INDEX idx_host (host),
    INDEX idx_service (service),
    INDEX idx_log_level (log_level),
    INDEX idx_processed (processed),
    INDEX idx_timestamp_level (timestamp, log_level)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

## 5. 性能优化建议

### 5.1 分区策略
- **system_logs**: 按时间分区，每月一个分区
- **audit_logs**: 按时间分区，每季度一个分区

### 5.2 索引优化
- 为高频查询字段创建复合索引
- 定期分析索引使用情况，删除无用索引
- 对大表考虑使用分区索引

### 5.3 数据归档
- system_logs表数据保留3个月，超期数据归档到历史表
- audit_logs表数据保留1年
- 定期清理临时数据和过期缓存

## 6. 备份与恢复策略

### 6.1 备份策略
- 每日全量备份
- 每小时增量备份
- 重要操作前手动备份

### 6.2 恢复测试
- 每月进行备份恢复测试
- 制定灾难恢复预案
- 建立数据恢复SOP

## 7. 监控与维护

### 7.1 性能监控
- 监控慢查询日志
- 跟踪表空间使用情况
- 监控连接数和锁等待

### 7.2 定期维护
- 每周执行表优化
- 定期更新表统计信息
- 监控磁盘空间使用情况