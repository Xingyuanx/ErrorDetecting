# 第十三周个人周总结

## 核心目标完成情况
本周重点完成了后端登录注册模块的开发，并将其与现有日志采集、Hadoop 集群远程控制功能进行了深度整合。构建了基于 JWT 的认证授权体系，实现了用户认证授权与核心业务功能的协同工作，为系统安全访问提供了基础保障。

## 具体完成内容

### 1. 登录注册模块开发
- **用户模型与数据库设计**：使用 SQLAlchemy 定义了 `User` 模型，映射 `users` 表结构，支持 `admin` 与 `user` 角色区分。
- **JWT 认证体系**：集成了 `python-jose` 与 `passlib`，实现了基于 HS256 算法的 JWT 令牌生成与验证，支持令牌过期时间配置。
- **接口实现**：
  - `POST /user/register`：实现了用户注册功能，包含用户名唯一性校验、密码强度校验（至少8位，含大小写字母与数字）。
  - `POST /user/login`：实现了用户登录功能，验证通过后返回 Access Token 与用户基本信息。
  - `GET /user/me`：实现了获取当前登录用户信息的接口，用于前端状态同步。

### 2. 权限控制与业务整合
- **依赖注入改造**：在 `app/deps/auth.py` 中实现了 `get_current_user` 依赖，将 JWT 解码逻辑与请求上下文绑定，减少了数据库查询开销。
- **集群管理权限收敛**：
  - 修改了 `app/routers/clusters.py`，为 `/clusters` 相关接口添加了 `Depends(get_current_user)` 依赖，确保仅登录用户可访问。
  - 实现了用户-集群归属映射，注册集群时自动绑定当前用户为管理员。
- **Hadoop 控制权限**：
  - 对 `start/stop` 等高危操作接口进行了权限管控，确保操作可追溯。

### 3. 系统稳定性与架构优化
- **数据库会话管理**：优化了 `app/routers/hadoop_cluster.py` 中的数据库会话管理，移除依赖注入方式，改为内部显式创建会话，解决了事件循环竞争问题。
- **SSH 执行优化**：在 `app/services/hadoop_cluster.py` 中引入了线程池执行 SSH 命令，并解析精确退出码，避免了 stderr 干扰判断。
- **异常处理标准化**：统一了路由层的错误返回格式，使用结构化 JSON 替代通用的 500 错误，提升了前端调试体验。

## 技术细节与变更
- **API 变更**：
  - 新增了 `auth` 模块相关接口（Login/Register/Me）。
  - `clusters` 模块接口增加了 Authorization Header 要求。
  - 新增 `POST /hadoop/cluster/sync-hosts` 接口，支持批量同步 `/etc/hosts`。
- **代码重构**：
  - `metrics_collector.py` 从异步写库改为同步写库，解决了跨事件循环调用的稳定性问题。
  - `ssh_utils` 强制使用 IP 进行连接，消除了 DNS 解析带来的不确定性。

## 遇到的问题与解决
- **问题**：在异步路由中依赖注入数据库会话导致 `Event loop is closed` 错误。
  - **解决**：移除路由层的 `get_db` 依赖注入，改为在路由处理函数内部使用 `async with SessionLocal() as db` 显式管理会话生命周期。
- **问题**：SSH 远程执行命令时，部分警告信息输出到 stderr 导致误判为执行失败。
  - **解决**：封装 SSH 执行逻辑，在命令后追加 `echo __EXIT__:$?`，通过解析标准输出的最后一行获取真实退出码。

## 下周计划
- 配合沈永佳进行 AI Agent 功能的深度联调，重点攻克工具调用（Tool Calling）在实际环境中的稳定性问题。
- 继续完善操作审计日志功能，确保每一笔高危操作都有据可查。
- 协助进行第二测试集群的压力测试，验证多用户并发场景下的系统表现。
